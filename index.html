<!DOCTYPE html>

<html lang="tr">

<head>

    <meta charset="UTF-8">

    

    <meta name="theme-color" content="#f4c542">

    <meta name="mobile-web-app-capable" content="yes">

    <meta name="apple-mobile-web-app-capable" content="yes">

    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">



    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">



    <title>MESEM GÃ¼nlÃ¼k ve AylÄ±k Rehberlik- DevamsÄ±zlÄ±k- Fesih FormlarÄ±</title>

    <style>

        :root { 

            --dark-bg: #0f172a; 

            --light-bg: #0f172a; 

            --card-bg: #0f172a; 

            --accent-gold: #f4c542;

            --accent-gold-50: rgba(244, 197, 66, 0.5);

            --btn-red: #b22234;

            --btn-red-hover: #9b1d2d;

            --text-light: #e0e6ed; 

            --text-lighter: #f0f4f8; 

            --text-white: #ffffff; 

            --danger-red: #ff6b7a; 

            --success-green: #4ecdc4; 

        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body { 

            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; 

            background-color: #0f172a;

            backdrop-filter: blur(15px);

            -webkit-backdrop-filter: blur(15px);

            position: relative;

            min-height: 100vh;

            color: var(--text-light);

        }

        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }

        .tabs { display: flex; background: var(--light-bg); border-radius: 10px 10px 0 0; border: 2px solid var(--accent-gold); border-bottom: none; }

        .tab { flex: 1; padding: 18px; text-align: center; cursor: pointer; color: var(--text-light); font-weight: 600; font-size: 1rem; transition: all 0.2s ease; border: none; background: transparent; }

        .tab.active { color: var(--accent-gold); background-color: var(--card-bg); }

        .content { background: var(--light-bg); border-radius: 0 0 10px 10px; border: 2px solid var(--accent-gold); min-height: 70vh; }

        .tab-content { display: none; padding: 30px; }

        .tab-content.active { display: block; }

        .panel { background-color: var(--card-bg); padding: 25px; margin-bottom: 25px; border: 2px solid var(--accent-gold); border-radius: 8px; }

        .panel h2, .content h2 { color: var(--text-white); font-size: 1.5rem; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--accent-gold); }

        .form-group { position: relative; display: flex; flex-direction: column; margin-bottom: 15px; }

        label { font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; color: var(--text-lighter); }

        label .required-star { color: var(--danger-red); font-size: 1.1rem; margin-left: 4px; }

        label .field-hint { color: var(--accent-gold); font-size: 0.8rem; font-weight: normal; margin-left: 8px; }

        .form-input, .form-select { width: 100%; background-color: var(--dark-bg); color: var(--text-lighter); border: 2px solid var(--accent-gold); border-radius: 5px; padding: 12px; font-size: 1rem; }

        .form-input:focus, .form-select:focus { outline: none; border-color: var(--accent-gold); box-shadow: 0 0 0 3px var(--accent-gold-50); }

        .error-message { color: var(--danger-red); font-size: 0.8rem; margin-top: 4px; display: none; }

        input.invalid, select.invalid { border-color: var(--danger-red) !important; }

        .btn { 

            background-color: var(--btn-red); 

            color: var(--text-white); 

            border: none; 

            padding: 10px 18px; 

            border-radius: 5px; 

            font-weight: 600; 

            cursor: pointer; 

            transition: background-color 0.2s ease; 

        }

        

        .btn:hover { background-color: var(--btn-red-hover); }

        .btn-primary { background-color: var(--btn-red); color: var(--text-white); }

        .btn-primary:hover { background-color: var(--btn-red-hover); }

        .btn-danger { background-color: #dc3545; color: var(--text-white); }

        .btn-danger:hover { background-color: #c82333; }

        .accordion-header { background-color: var(--card-bg); color: var(--text-white); padding: 15px 20px; border-radius: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-top: 15px; border: 2px solid var(--accent-gold); }

        .accordion-content { padding: 20px; border: 2px solid var(--accent-gold); border-top: none; border-radius: 0 0 5px 5px; display: none; background: var(--card-bg); }

        .accordion-content.open { display: block; }

        .student-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--dark-bg); padding: 10px 15px; border-radius: 5px; margin-bottom: 8px; flex-wrap: wrap; gap: 10px; border: 2px solid var(--accent-gold); }

        .student-info strong { font-size: 1rem; color: var(--text-lighter); }

        .student-info small { font-size: 0.8rem; color: var(--text-light); }

        .student-actions { display: flex; flex-wrap: wrap; gap: 8px; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(11, 29, 58, 0.9); backdrop-filter: blur(5px); }

        .modal-content { background-color: var(--light-bg); margin: 5% auto; padding: 30px; border: 2px solid var(--accent-gold); border-radius: 10px; width: 90%; max-width: 800px; }

        .form-controls-container { display: none; }

        .form-controls-container.active { display: block; }

        .checkbox-list .item { 

            display: flex; 

            align-items: center; 

            margin-bottom: 8px; 

            padding: 12px; 

            background: var(--dark-bg); 

            border: 1px solid var(--accent-gold); 

            border-radius: 8px; 

            transition: all 0.2s ease;

        }

        .checkbox-list .item:hover { 

            background: var(--accent-gold-50); 

            transform: translateY(-1px);

        }

        .checkbox-list label { 

            font-size: 1rem; 

            margin-left: 12px; 

            color: var(--text-lighter); 

            cursor: pointer; 

            user-select: none;

            font-weight: 500;

        }

        .checkbox-list input { 

            width: 20px; 

            height: 20px; 

            accent-color: var(--accent-gold);

            cursor: pointer;

        }

        .dropdown-container { position: relative; width: 100%; }

        .dropdown-header { 

            display: flex; 

            justify-content: space-between; 

            align-items: center; 

            padding: 12px 15px; 

            background: var(--dark-bg); 

            border: 2px solid var(--accent-gold); 

            border-radius: 8px; 

            cursor: pointer; 

            transition: all 0.2s ease;

            user-select: none;

        }

        .dropdown-header:hover { 

            border-color: var(--accent-gold); 

            background: var(--accent-gold-50); 

        }

        .dropdown-arrow { 

            transition: transform 0.3s ease; 

            color: var(--accent-gold);

            font-weight: bold;

        }

        .dropdown-header.open .dropdown-arrow { transform: rotate(180deg); }

        .dropdown-content { 

            position: absolute; 

            top: 100%; 

            left: 0; 

            right: 0; 

            background: var(--dark-bg); 

            border: 2px solid var(--accent-gold); 

            border-top: none; 

            border-radius: 0 0 8px 8px; 

            max-height: 300px; 

            overflow-y: auto; 

            z-index: 1000; 

            display: none;

        }

        .dropdown-content.open { display: block; }

        .dropdown-controls { 

            display: flex; 

            gap: 8px; 

            padding: 10px; 

            border-bottom: 1px solid var(--accent-gold-50);

        }

        .dropdown-btn { 

            padding: 6px 12px; 

            background: var(--btn-red); 

            color: var(--text-white); 

            border: none; 

            border-radius: 4px; 

            cursor: pointer; 

            font-size: 0.9rem;

            transition: background 0.2s ease;

        }

        .dropdown-btn:hover { background: var(--btn-red-hover); }

        .dropdown-item { 

            display: flex; 

            align-items: center; 

            padding: 10px 15px; 

            cursor: pointer; 

            transition: background 0.2s ease;

            border-bottom: 1px solid var(--accent-gold-50);

        }

        .dropdown-item:hover { background: var(--accent-gold-50); }

        .dropdown-item:last-child { border-bottom: none; }

        .dropdown-item input { 

            margin-right: 10px; 

            width: 18px; 

            height: 18px; 

            accent-color: var(--accent-gold);

        }

        .dropdown-item label { 

            color: var(--text-lighter); 

            cursor: pointer; 

            user-select: none;

        }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 15px; }

        .calendar-header { text-align: center; font-weight: bold; padding-bottom: 10px; color: var(--text-light); font-size: 0.8rem; }

        .calendar-day { height: 50px; display: flex; flex-direction:column; align-items: center; justify-content: center; border-radius: 5px; background-color: var(--card-bg); font-weight: bold; cursor: default; line-height: 1.1; border: 2px solid var(--accent-gold); }

        .calendar-day.workday:hover { background-color: var(--accent-gold-50); }

        .calendar-day .f-gold { color: var(--accent-gold); } .calendar-day .f-blue { color: #64b5f6; } .calendar-day .f-red { color: var(--danger-red); } .calendar-day .f-green { color: var(--success-green); }

        .summary-panel { margin-top: 40px; padding-top: 25px; border-top: 2px solid var(--accent-gold); display: flex; justify-content: space-around; text-align: center; }

        .summary-item { color: var(--text-white); }

        .summary-item .count { font-size: 2rem; font-weight: bold; color: var(--accent-gold); }

        .summary-item .label { font-size: 1rem; color: var(--text-light); }

        .print-list-btn { margin-top: 20px; }



        /* ---- SAYFA TANIMLARI (Ã¼st seviye) - Global kenar boÅŸluklarÄ± artÄ±rÄ±ldÄ± ---- */

        @page attendance  { size: A4 portrait;  margin: 15mm; }   /* DevamsÄ±zlÄ±k: Dikey */

        @page termination { size: A4 portrait;  margin: 15mm; }   /* Fesih: Dikey */

        @page guidance    { size: A4 landscape; margin: 10mm;  }   /* GÃ¼nlÃ¼k & AylÄ±k Rehberlik: Yatay */

        @page list        { size: A4 landscape; margin: 12mm; }   /* Liste: Yatay (varsa) */



        @media print {

            .no-print { display: none !important; }

            body, *:not(.grade-sheet-page):not(.grade-sheet-page *) { background: transparent !important; color: #000 !important; box-shadow: none !important; text-shadow: none !important; }

            body { font-family: Arial, sans-serif !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }

            #print-container { display: block !important; }

            .print-page-container { page-break-after: always; }

            .dynamic-text { font-weight: bold !important; font-style: italic !important; }

            .editable-textarea { border: 1px dotted #999 !important; padding: 1px !important; resize: none; height: auto; white-space: pre-wrap; overflow: hidden; font-family: inherit; font-size: inherit; width: 100%; background-color: transparent !important; }



            .print-page-attendance, .print-page-termination {

                @page { size: A4 portrait; margin: 15mm; }

                height: 267mm; width: 180mm; /* Kenar boÅŸluÄŸu artÄ±rÄ±ldÄ±ÄŸÄ± iÃ§in boyutlar kÃ¼Ã§Ã¼ltÃ¼ldÃ¼ */

            }

            .print-page-monthly-guidance, .print-page-daily-guidance {

                @page { size: A4 landscape; margin: 10mm; }

                height: 190mm; width: 277mm; /* Kenar boÅŸluÄŸu artÄ±rÄ±ldÄ±ÄŸÄ± iÃ§in boyutlar kÃ¼Ã§Ã¼ltÃ¼ldÃ¼ */

            }

            .print-page-list {

                @page { size: A4 landscape; margin: 12mm; }

                height: 186mm; width: 273mm; /* Kenar boÅŸluÄŸu artÄ±rÄ±ldÄ±ÄŸÄ± iÃ§in boyutlar kÃ¼Ã§Ã¼ltÃ¼ldÃ¼ */

            }

            

            /* AYLIK REHBERLÄ°K - Kenar boÅŸluklarÄ± artÄ±rÄ±ldÄ±, tablo satÄ±rlarÄ± kÃ¼Ã§Ã¼ltÃ¼ldÃ¼ */

            .print-page-monthly-guidance .print-page { 

                display: flex !important; 

                justify-content: space-between; 

                width: 100%; 

                height: 100%; 

                gap: 10mm !important; /* Kenar boÅŸluÄŸu artÄ±rÄ±ldÄ± */

                padding: 0 8mm !important; /* Global kenar boÅŸluÄŸu */

            }

            .print-page-monthly-guidance .print-form-half { 

                width: 125mm !important; /* Biraz daha daraltÄ±ldÄ± */

                border: 2px solid #000 !important; 

                padding: 2mm !important; /* Kenar boÅŸluÄŸu artÄ±rÄ±ldÄ± */

                display: flex; 

                flex-direction: column; 

                height: 100%; 

            }

            .print-page-monthly-guidance .editable-textarea { 

                min-height: 18px !important; /* Daha az alan */

                font-size: 5.5pt !important; /* Daha kÃ¼Ã§Ã¼k font */

                font-weight: bold;

                line-height: 1.0 !important;

                padding: 1px !important;

            }

            .print-page-monthly-guidance .editable-textarea.expandable-area { 

                min-height: 30px !important; 

            }

            .print-page-monthly-guidance .form-content-wrapper { 

                flex-grow: 1; 

            }

            .print-page-monthly-guidance tr[style*="background:#f0f0f0;"] { 

                background-color: #f000 !important; 

            }

            .print-page-monthly-guidance table td {

                padding: 0.3px !important; /* Ã‡ok az padding */

                font-size: 4.5pt !important;

                line-height: 1.0 !important;

                height: 18px !important; /* Sabit dÃ¼ÅŸÃ¼k satÄ±r yÃ¼ksekliÄŸi */

                vertical-align: top !important;

            }

        

          

         /* GÃœNLÃœK REHBERLÄ°K FORMU - NÄ°HAÄ° DIÅ Ã‡ERÃ‡EVE YAZILI DÃœZEN â–¼ */



            .print-page-daily-guidance {

                page: guidance;

            }

            .print-page-daily-guidance .daily-guidance-container {

                display: flex;

                justify-content: space-between;

                gap: 8mm;

                height: 100%;

            }

            /* YENÄ°: Her bir form sÃ¼tununu konumlandÄ±rma iÃ§in temel alÄ±r */

            .print-page-daily-guidance .daily-guidance-column {

                width: 48%;

                position: relative; /* KÃ¶ÅŸe yazÄ±larÄ±nÄ± buna gÃ¶re hizalar */

                padding-top: 3mm;   /* Ãœst yazÄ± iÃ§in boÅŸluk */

                padding-bottom: 3mm;/* Alt yazÄ± iÃ§in boÅŸluk */

                box-sizing: border-box;

                display: flex;

            }

            /* Ã‡erÃ§eveli form kutusu artÄ±k sÃ¼tunun tamamÄ±nÄ± kaplar */

            .print-page-daily-guidance .daily-guidance-form {

                border: 2px solid #000;

                padding: 3mm;

                box-sizing: border-box;

                width: 100%;

                height: 100%;

            }

            /* YENÄ°: KÃ¶ÅŸe yazÄ±larÄ±nÄ±n stilleri. ArtÄ±k Ã§erÃ§evenin dÄ±ÅŸÄ±nda konumlanacaklar. */

            .print-page-daily-guidance .top-right-text,

            .print-page-daily-guidance .bottom-left-text {

                position: absolute; /* Ana sÃ¼tuna gÃ¶re konumlanÄ±r */

                font-size: 6pt;

                font-weight: bold;

            }

            .print-page-daily-guidance .top-right-text {

                top: 0;

                right: 0;

            }

            .print-page-daily-guidance .bottom-left-text {

                bottom: 0;

                left: 0;

            }

            .print-page-daily-guidance .dynamic-text {

                font-weight: bold;

                font-style: italic;

            }

            .print-page-daily-guidance h3 {

                font-size: 10pt;

                text-align: center;

                margin: 0 0 5px 0;

            }

            .print-page-daily-guidance .main-table {

                width: 100%;

                border-collapse: collapse;

            }

            .print-page-daily-guidance .main-table td {

                border: 1px solid #000;

                padding: 2px 4px;

                font-size: 8pt;

                vertical-align: top;

            }

            .print-page-daily-guidance .label-cell {

                font-weight: bold;

                width: 40%;

            }

            .print-page-daily-guidance .section-cell {

                padding: 3px 2px;

            }

            .print-page-daily-guidance .section-cell p {

                font-size: 8pt;

                margin: 5px 0 2px 0;

            }

            .print-page-daily-guidance .section-cell .editable-textarea {

                width: 100%;

                height: 110px;

                font-size: 8pt;

                padding: 2px;

                border: 1px dotted #999;

                box-sizing: border-box;

                resize: none;

            }

            .print-page-daily-guidance .signature-cell {

                padding: 20px 2px;

                border-bottom: none;

            }

            .print-page-daily-guidance .footer {

                display: flex;

                justify-content: space-between;

                text-align: center;

                font-size: 8pt;

                padding: 0 15px;

            }

            .print-page-daily-guidance .notes-cell {

                font-size: 6pt;

                line-height: 1.1;

                border-top: none;

            }



            /* DEVAMSIZLIK FORMLARI - Footer 5 bÃ¶lÃ¼mlÃ¼ yapÄ± */

            .print-page-attendance .print-sheet-wrapper { 

                width: 100%; 

                height: 100%; 

                display: flex; 

                flex-direction: column; 

            }

            .print-page-attendance .print-sheet.first-half,

            .print-page-attendance .print-sheet.second-half {

                min-height: 49%; /* Sabit yÃ¼kseklik yerine minimum yÃ¼kseklik veriyoruz */

                flex-shrink: 0;  /* KutularÄ±n kÃ¼Ã§Ã¼lmesini engelliyoruz */

            }

            .print-page-attendance .print-sheet.second-half {

                margin-top: 2%; /* Aradaki boÅŸluk kalsÄ±n */

            }

            .print-page-attendance .sheet-content {

                break-inside: avoid; /* Sayfa ortasÄ±nda bÃ¶lÃ¼nmeyi engeller */

            }

            .print-page-attendance .sheet-content { 

                display: flex; 

                flex-direction: column; 

                height: 100%; 

                border: 2px solid #000; 

                padding: 3mm; 

            }

            .print-page-attendance .print-main-title { 

                text-align: center; 

                font-weight: bold; 

                font-size: 8pt; 

                text-transform: uppercase; 

                border-bottom: 2px solid #f4c542; 

                padding-bottom: 2px; 

            }

            .print-page-attendance .print-header-table { 

                width: 100%; 

                border-collapse: collapse; 

                margin: 4px 0; 

                font-size: 8pt; 

            }

            .print-page-attendance .print-header-table td { 

                border: 1px solid #000; 

                padding: 2px 4px; 

                vertical-align: top; 

            }

            .print-page-attendance .print-main-table-wrapper { 

                flex-grow: 1; 

            }

            .print-page-attendance .print-main-table { 

                width: 100%; 

                border-collapse: collapse; 

                table-layout: auto; 

            }

            .print-page-attendance .print-main-table th, 

            .print-page-attendance .print-main-table td { 

                border: 1px solid #000;

                text-align: center; 

                padding: 1px; 

                line-height: 1.2; 

                vertical-align: middle; 

                font-size: 6pt; 

                height: 12px; 

                overflow: hidden; 

            }

            .print-page-attendance .print-main-table .student-info-cell { 

                text-align: left; 

                padding: 1px 2px; 

                white-space: normal; /* Metnin alt satÄ±ra geÃ§mesini saÄŸlar */

                word-break: break-word; /* SatÄ±ra sÄ±ÄŸmayan Ã§ok uzun kelimeleri bÃ¶ler */

                vertical-align: middle;

            }

            .print-page-attendance .print-main-table .header-cell-name { 

                width: 220px; 

                min-width: 80px; 

            }

            .print-page-attendance .print-main-table .header-cell-no { 

                width: 100px;

                min-width: 30px;  

            }

            .print-page-attendance .print-main-table .header-cell-field { 

                width: 150px;

                min-width: 60px; 

            }

            .print-page-attendance .print-main-table .header-cell-days { 

                width: auto; 

                min-width: 15px; 

                font-size: 4pt; 

                writing-mode: vertical-rl; 

                text-orientation: mixed; 

                transform: rotate(180deg); 

            }

            .print-page-attendance .print-main-table .day-cell { 

                width: calc((100% - 200px) / 31); 

                min-width: 8px; 

                max-width: 12px; 

            }

            .print-page-attendance .print-main-table .header-cell-total { 

                width: auto; 

                min-width: 25px; 

            }



            .print-page-attendance .print-main-table .day-cell {

                width: 2.5%;

                min-width: 12px; /* Ã‡ok daralmasÄ±nÄ± Ã¶nlemek iÃ§in */

                box-sizing: border-box; /* GeniÅŸlik hesaplamasÄ±nÄ± dÃ¼zeltmek iÃ§in */

            }



            /* YENÄ° 5 BÃ–LÃœMLÃœ FOOTER DÃœZENÄ° (SON HALÄ°) */

            .print-page-attendance .print-footer {

                width: 100%;

                margin-top: auto;

                padding-top: 5px;

                display: flex;

                justify-content: space-between;

                align-items: stretch; /* KutularÄ±n yÃ¼ksekliklerini eÅŸitler */

                font-size: 6pt !important;

                gap: 2px;

                /* Sabit yÃ¼kseklik kaldÄ±rÄ±ldÄ±, artÄ±k otomatik ayarlanacak */

            }



            .print-page-attendance .signature-section {

                text-align: center;

                width: 19% !important; /* DÃœZELTÄ°LDÄ° */

                line-height: 1.2;

                border: 1px solid #000;

                padding: 2px !important;

                display: flex;

                flex-direction: column;

                justify-content: center;

            }



            .print-page-attendance .explanation-section {

                width: 21% !important; /* DÃœZELTÄ°LDÄ° */

                text-align: center;

                font-size: 6.0pt !important;

                line-height: 1.2;

                border: 1px solid #000;

                padding: 2px !important;

                display: flex;

                align-items: flex-start;

                justify-content: center;

            }



            .print-page-attendance .legend-section {

                width: 22% !important; /* Bu doÄŸru, deÄŸiÅŸtirilmedi */

                text-align: left;

                display: flex;

                align-items: center;

            }



            .print-page-attendance .legend-box {

                font-size: 5.5pt !important;

                border: 1px solid #000; 

                padding: 2px !important;

                line-height: 1.2;

                width: 100%;

                height: 100%;                 /* YENÄ°: KapsayÄ±cÄ±sÄ±nÄ± dikeyde doldurur */

                display: flex;                 /* YENÄ°: Ä°Ã§indeki yazÄ±yÄ± ortalamak iÃ§in */

                flex-direction: column;        /* YENÄ°: Ä°Ã§indeki yazÄ±yÄ± ortalamak iÃ§in */

                justify-content: center;       /* YENÄ°: Ä°Ã§indeki yazÄ±yÄ± dikeyde ortalar */

            }



            /* Renk ve font kurallarÄ± aynÄ± kalabilir */

            .print-page-attendance .f-bold {

                font-weight: bold;

            }

            .print-page-attendance .f-blue {

                color: blue !important;

            }

            .print-page-attendance .f-green {

                color: green !important;

            }

            .print-page-attendance .f-red {

                color: red !important;

                font-weight: bold !important;

            }

            .print-page-attendance .f-teal {

                color: teal !important;

            }





                        

            /* FESÄ°H FORMLARI */

            .print-page-termination .termination-container { 

                padding: 5mm; 

                border: 2px solid #000; 

                height: 100%; 

                display: flex; 

                flex-direction: column; 

                font-family: 'Times New Roman', serif; 

            }

            .print-page-termination h1 { 

                font-size: 14pt; 

                font-weight: bold; 

                text-align: center; 

            } 

            .print-page-termination h2 { 

                font-size: 16pt; 

                font-weight: bold; 

                margin: 20px 0; 

                text-align: center; 

                line-height: 1.4; 

            }

            .print-page-termination table { 

                width: 100%; 

                margin-top: 30px; 

                font-size: 12pt; 

                border-collapse: collapse; 

            }

            .print-page-termination td { 

                padding: 10px 5px; 

                vertical-align: bottom; 

            }

            .print-page-termination .label-col { 

                width: 30%; 

                font-weight: bold; 

            } 

            .print-page-termination .separator-col { 

                width: 2%; 

            } 

            .print-page-termination .value-col { 

                border-bottom: 1px dotted #000; 

            }

            .print-page-termination .reasons { 

                margin-top: 40px; 

                flex-grow: 1; 

                display: flex; 

                flex-direction: column; 

            }

            .print-page-termination .reasons .label-col { 

                font-weight: bold; 

                font-size: 12pt; 

            }

            .print-page-termination .reasons .value-box { 

                flex-grow: 1; 

                border: 1px solid #000; 

                margin-top: 5px; 

                padding: 5px; 

                font-weight: normal; 

            }

            .print-page-termination .signatures { 

                display: flex; 

                justify-content: space-between; 

                margin-top: auto; 

                padding-top: 60px; 

                text-align: center; 

                font-size: 12pt; 

            }



            /* LÄ°STE FORMLARI */

            .print-page-list .list-container { 

                padding: 10mm; 

            }

            .print-page-list h2 { 

                text-align: center; 

                font-size: 14pt; 

                margin-bottom: 20px; 

            }

            .print-page-list .business-section { 

                margin-bottom: 12px; 

                page-break-inside: avoid; 

            }

            .print-page-list .business-header { 

                background-color: #f0f0f0; 

                padding: 5px; 

                font-weight: bold; 

                border: 1px solid #f000; 

            }

            .print-page-list .student-list-table { 

                width: 100%; 

                border-collapse: collapse; 

                font-size: 8pt; 

            }

            .print-page-list .student-list-table th, 

            .print-page-list .student-list-table td { 

                border: 1px solid #000; 

                padding: 3px; 

                text-align: left; 

            }

            .print-page-list .student-list-table th { 

                background-color: #f0f0f0; 

                font-weight: bold; 

            }



            .print-page-monthly-guidance table td:first-child {

                font-size: 5pt !important;

                font-weight: bold !important;

                line-height: 1.0 !important; /* EKLENDÄ°: SatÄ±r aralÄ±ÄŸÄ±nÄ± artÄ±rÄ±r */

            }



            .print-page-monthly-guidance table:first-of-type .dynamic-text {

                font-size: 5.5pt !important;

                font-weight: bold !important;

                font-style: italic !important; /* Ä°steÄŸiniz olan italik stilini ekler */

                line-height: 1.2 !important;   /* Okunurluk iÃ§in satÄ±r aralÄ±ÄŸÄ±nÄ± biraz artÄ±rdÄ±m */

            }           

        }

        

        

        #print-container { display: none; }

        .print-page-container { page-break-after: always; break-after: page; }



        /* ---- KONTEYNER -> SAYFA ATAMALARI ---- */

        .print-page-attendance  { page: attendance;  height: 267mm; width: 180mm; }

        .print-page-termination { page: termination; height: 267mm; width: 180mm; }

        .print-page-monthly-guidance,

        .print-page-daily-guidance { page: guidance; height: 190mm; width: 277mm; }

        .print-page-list { page: list; height: 186mm; width: 273mm; }

        





        .modal { 

            display: none; 

            position: fixed; 

            z-index: 1000; 

            left: 0; 

            top: 0; 

            width: 100%; 

            height: 100%; 

            backdrop-filter: none !important;

            background-color: rgba(11, 29, 58, 0.9); 

        }



        .modal input,

        .modal textarea,

        .modal select {

            scroll-margin-block-start: 99vh;

        }



        /* MasaÃ¼stÃ¼nde modal kendi yerinde kalsÄ±n; sÃ¼rÃ¼kleyince pozisyonu korunur */

        .modal-content{

            position: fixed;

            top: 50%;        /* tekrar ekle */

            left: 50%;       /* tekrar ekle */

            transform: translate(-50%, -50%); /* tekrar ekle */

            margin: 0;

            z-index: 10001;

            will-change: auto;

        }



        /* SADECE mobil/tabletâ€™te ortala (dokunmatik iÃ§in) */

        @media (max-width: 768px) {

        .modal-content{

            top: 50%;

            left: 50%;

            transform: translate(-50%, -50%);

        }        



        /* Sadece 'Ã–ÄŸrenciyi DÃ¼zenle' penceresini (studentModal) aÃ§Ä±lÄ±ÅŸta ekranÄ±n tam ortasÄ±na al */

            #studentModal .modal-content{

                position: fixed;

                top: 50%;

                left: 50%;

                transform: translate(-50%, -50%);

                margin: 0;         /* varsa margin:5% autoâ€™yu geÃ§ersiz kÄ±lar */

                max-height: 90vh;  /* taÅŸmayÄ± Ã¶nler */

                overflow: auto;    /* iÃ§erik uzun olursa kaydÄ±r */

            }

        }



            







        /* =================================== */

        /* MOBÄ°L UYUMLULUK Ä°YÄ°LEÅTÄ°RMELERÄ°     */

        /* =================================== */



        /* Temel mobil ayarlar */

        * {

            -webkit-tap-highlight-color: rgba(244, 197, 66, 0.3);

            -webkit-touch-callout: none;

        }



        /* Tablet iÃ§in - 768px ve altÄ± */

        @media (max-width: 768px) {

            .container { padding: 10px; }

            

            .grid { 

                grid-template-columns: 1fr; 

                gap: 15px; 

            }

            

            .tabs { 

                flex-direction: column; 

            }

            

            .tab { 

                padding: 15px; 

                font-size: 0.9rem; 

            }

            

            .modal-content { 

                width: 95%; 

                padding: 20px; 

                margin: 5% auto; 

            }

            

            .dropdown-header { 

                padding: 15px; 

            }

            

            .dropdown-item { 

                padding: 15px; 

            }

        }



        /* Telefon iÃ§in - 480px ve altÄ± */

        @media (max-width: 480px) {

            .container { 

                padding: 5px; 

            }

            

            .panel { 

                padding: 15px; 

            }

            

            .form-group { 

                margin-bottom: 12px; 

            }

            

            .btn { 

                padding: 12px 20px; 

                font-size: 1rem;

                min-height: 44px; /* Touch-friendly */

            }

            

            .student-item { 

                flex-direction: column; 

                gap: 10px; 

            }

            

            .student-actions { 

                width: 100%; 

                justify-content: space-between; 

            }

            

            .summary-panel { 

                flex-direction: column; 

                gap: 15px; 

            }

            

            /* Grid dÃ¼zeni tek sÃ¼tun */

            .grid[style*="grid-template-columns: 1fr 1fr"] {

                grid-template-columns: 1fr !important;

            }

            

            .grid[style*="grid-template-columns: 1fr 1fr 1fr 1fr"] {

                grid-template-columns: 1fr !important;

            }

            

            /* Dropdown daha bÃ¼yÃ¼k */

            .dropdown-content {

                max-height: 250px;

            }

            

            /* Form inputlarÄ± daha bÃ¼yÃ¼k */

            .form-input, .form-select {

                padding: 15px;

                font-size: 16px; /* iOS zoom Ã¶nleme */

            }

            

            /* Modal tam ekran benzeri */

            .modal-content {

                width: 98%;

                height: 90vh;

                overflow-y: auto;

            }

        }



        /* Ã‡ok kÃ¼Ã§Ã¼k ekranlar - 320px */

        @media (max-width: 320px) {

            .tab {

                padding: 10px 5px;

                font-size: 0.8rem;

            }

            

            .btn {

                padding: 10px 15px;

                font-size: 0.9rem;

            }

            

            .modal-content {

                width: 99%;

                padding: 10px;

            }

        }



        /* Touch optimizasyonu */

        @media (hover: none) and (pointer: coarse) {

            .btn:hover,

            .dropdown-header:hover,

            .dropdown-item:hover {

                transform: none;

                background-color: var(--accent-gold-50);

            }

            

            /* Touch feedback */

            .btn:active,

            .dropdown-item:active {

                transform: scale(0.98);

            }

        }



            .accordion-header {

                transition: background-color 0.2s ease;

            }



            .accordion-header:hover {

                background-color: var(--accent-gold-50);

            }



            .accordion-content {

                transition: all 0.3s ease;

            }





            /* --- MOBÄ°L YAMASI (sadece mobilde Ã§alÄ±ÅŸÄ±r) --- */

            @media (max-width: 768px), (pointer: coarse) {



            /* Modal iÃ§erik: iOS/Android'de akÄ±cÄ± kaydÄ±rma, taÅŸmadan gÃ¶rÃ¼nÃ¼m */

            .modal .modal-content,

            #studentModal .modal-content{

                max-height: 90dvh;              /* iOS barlarÄ±nÄ± hesaba katar */

                width: 96vw;                     /* ekrandan taÅŸmayÄ± engeller */

                overflow: auto;                  /* iÃ§erik kayar */

                -webkit-overflow-scrolling: touch;

            }



            /* Varsa modal gÃ¶vdesini kaydÄ±rÄ±labilir yap (tercih edilir) */

            .modal .modal-body{

                max-height: 70dvh;

                overflow: auto;

                -webkit-overflow-scrolling: touch;

            }



            /* YalnÄ±zca mobil */

            @media (max-width: 768px){

            /* Konteyner: yan yana sÄ±ÄŸmayan butonlar otomatik bir alt satÄ±ra iner, ortalanÄ±r */

            .modal .modal-footer,

            .button-bar, .actions, .toolbar{

                display: flex;

                flex-wrap: wrap;          /* ALT SATIRA Ä°NSÄ°N */

                justify-content: center;  /* ORTALA */

                gap: 8px;

            }



            /* Butonlar: metin KIRILMAZ; sÄ±ÄŸmazsa buton komple alta geÃ§er */

            .modal .modal-footer > *,

            .button-bar > *, .actions > *, .toolbar > *{

                flex: 0 0 auto;           /* iÃ§eriÄŸe gÃ¶re geniÅŸlik */

                white-space: nowrap;      /* buton iÃ§i metin tek satÄ±r */

                min-height: 44px;

                padding: 10px 12px;

                font-size: clamp(12px, 3.2vw, 14px);  /* mobilde biraz kÃ¼Ã§Ã¼lt */

                max-width: 100%;          /* gÃ¼venlik: taÅŸma engeli */

            }

            }





            /* Ã‡ok dar telefonlarda tek sÃ¼tun */

            @media (max-width: 360px){

                .modal .modal-footer,

                .button-bar, .actions, .toolbar{

                grid-template-columns: 1fr;

                }

            }



            /* Buton metni kÄ±rÄ±labilsin; Ã¼st Ã¼ste binmeyi kes */

            .btn, button{

                max-width: 100%;

                white-space: normal;

                line-height: 1.2;

            }

            }



            /* SADECE MOBÄ°L Ä°Ã‡Ä°N - Desktop'a dokunmuyoruz */

            @media (max-width: 768px) {

                /* Veri YÃ¶netimi butonlarÄ± - sadece mobilde flex-wrap */

                .panel > div:last-child > div {

                    flex-wrap: wrap !important;

                    justify-content: center !important;

                }

                

                /* Ä°ÅŸletmeler baÅŸlÄ±k hizasÄ± - mobilde alt alta */

                div[style*="display:flex"][style*="justify-content: space-between"] {

                    flex-direction: column !important;

                    text-align: center !important;

                    gap: 15px !important;

                }

            }



            @media (max-width: 480px) {

                /* KÃ¼Ã§Ã¼k ekranlarda butonlar tam geniÅŸlik */

                .panel > div:last-child > div {

                    flex-direction: column !important;

                }

                

                .panel > div:last-child > div .btn {

                    width: 100% !important;

                    margin-bottom: 10px !important;

                }

            }



/* --- DÃ–NEM NOT FÄ°ÅÄ° (SÃœTUNLAR AYARLANDI - 3'LÃœ SÄ°STEM) --- */
        @page grade-sheet {
            size: A4 landscape;
            margin: 15mm 10mm 10mm 10mm;
        }

        .grade-sheet-page {
            page: grade-sheet;
            width: 285mm;
            height: auto;
            min-height: unset;
            background: white;
            color: #000;
            font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
            font-size: 9pt; /* Genel fontu biraz kÃ¼Ã§Ã¼lttÃ¼k ki sÄ±ÄŸsÄ±n */
            position: relative;
            page-break-after: always;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            border: none; 
            padding: 0;
            padding-top: 20px;
            overflow: visible;
        }

        .gs-border-container {
            border: 2px solid #000;
            padding: 5px;
            padding-bottom: 15px;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .gs-doc-code {
            position: absolute;
            top: 8px;
            right: 0;
            font-size: 8pt;
            font-weight: bold;
            line-height: 1;
        }

        .gs-header-section {
            display: block; 
            height: auto;
            text-align: center;
            border-bottom: 2px solid #f4c542;
            padding-bottom: 4px;
            margin-bottom: 10px;
            position: relative;
        }

        .gs-main-title {
            font-size: 11pt;
            font-weight: 700;
            text-transform: uppercase;
            color: #000;
            line-height: 1.2;
        }

        .info-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .info-table td { border: none; padding: 2px; vertical-align: bottom; white-space: nowrap; }
        .label-cell { font-weight: 700; width: 1%; padding-right: 5px; }
        .value-cell { border-bottom: 1px dotted #000 !important; font-weight: 700; font-style: italic; padding-left: 15px !important; text-align: left !important; }

        /* TABLO AYARLARI */
        .modern-table { width: 100%; border-collapse: collapse; table-layout: fixed; border-bottom: none; margin-bottom: 10px; }
        
        .modern-table th, .modern-table td { 
            border: 1px solid #000; 
            padding: 0; 
            vertical-align: middle; 
            text-align: center; 
            line-height: 1.1; 
            font-size: 9pt; 
        }
        
        .modern-table th { 
            background-color: #f0f0f0; 
            font-weight: 700; 
            padding: 2px 0; 
            font-size: 7.5pt; /* BaÅŸlÄ±k fontunu kÃ¼Ã§Ã¼lttÃ¼k */
        }
        
        .student-data-cell { 
            text-align: left !important; 
            padding-left: 5px !important; 
            font-weight: 700 !important; 
            font-style: italic !important; 
            font-size: 8.5pt; /* Ä°simler sÄ±ÄŸsÄ±n diye biraz kÃ¼Ã§Ã¼ldÃ¼ */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- SÃœTUN GENÄ°ÅLÄ°KLERÄ° (3'LÃœ SÄ°STEM Ä°Ã‡Ä°N DARALTILDI) --- */
        .col-no { width: 30px; } 
        .col-name { width: 13%; } /* Ä°sim alanÄ± daraltÄ±ldÄ± */
        .col-field { width: 10%; } /* Alan adÄ± daraltÄ±ldÄ± */
        .col-class { width: 5%; }
        
        /* 3'lÃ¼ kÃ¼Ã§Ã¼k puan kutularÄ± iÃ§in yeni sÄ±nÄ±f */
        .col-grade-sub { width: 22px; } 

        .col-telafi { width: 3.5%; } 
        .col-beceri { width: 4%; } 
        .col-ort { width: 4%; } 
        .col-not-rakam { width: 4%; } 
        .col-not-yazi { width: 7%; }

        .vertical-cell { height: 90px; vertical-align: bottom !important; padding-bottom: 3px !important; }
        .vertical-text { writing-mode: vertical-rl; transform: rotate(180deg); white-space: nowrap; display: inline-block; font-weight: 700; font-size: 8pt; }
        .data-row { height: 28px; }

        .signature-section { 
            display: flex; 
            justify-content: space-between; 
            border-top: 1px solid #f4c542; 
            margin-top: 40px; 
        }
        .sig-box { text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: flex-start; gap: 2px; margin-top: 10px; }
        .sig-name { font-size: 9pt; font-weight: 700; font-style: italic; min-height: 18px; margin-bottom: 0; }
        .sig-title { font-size: 8pt; font-weight: 600; line-height: 1.1; margin-bottom: 5px; height: 30px; display: flex; align-items: flex-start; justify-content: center; }
        .sig-place { font-size: 8.5pt; }

        .footer-notes { margin-top: 95px; font-size: 9pt; font-style: italic; line-height: 1.2; }
        

     </style>

</head>

<body>



    <div id="auth-container" class="no-print" style="background: var(--dark-bg); padding: 15px; border-bottom: 2px solid var(--accent-gold);">

        <div id="login-section" style="text-align: center;">

            <h2 style="color: var(--accent-gold); margin-bottom: 10px;">ğŸ“ MESEM Takip Sistemi</h2>

            <button id="google-login-btn" class="btn btn-primary">ğŸ” Google HesabÄ±mla GiriÅŸ</button>

        </div>

        <div id="user-info" style="display: none; text-align: right;">

            <span id="user-name" style="color: var(--text-light); margin-right: 15px;"></span>

            <button id="logout-btn" class="btn btn-danger">Ã‡Ä±kÄ±ÅŸ</button>

        </div>

    </div>





    <div class="container no-print" style="display: none;">

        <div class="tabs">

            <button class="tab active" data-tab="management-panel">ğŸ¢ YÃ¶netim Paneli</button>

            <button class="tab" data-tab="generator-panel">ğŸ“‹ Form OluÅŸtur</button>
            <button class="tab" data-tab="grade-sheet-panel">ğŸ“ DÃ¶nem Not FiÅŸi</button>


        </div>

        <div class="content">

            <div id="management-panel" class="tab-content active">

                <div class="panel">

                    <h2>Genel Ayarlar</h2>

                    <div class="grid" style="grid-template-columns: 1fr 1fr 1fr 1fr;">

                         <div class="form-group"><label for="schoolName">Okul/Kurumun AdÄ±</label><input type="text" id="schoolName" class="form-input"></div>

                         <div class="form-group"><label for="coordinatorName">KoordinatÃ¶r Ã–ÄŸretmen</label><input type="text" id="coordinatorName" class="form-input"></div>

                         <div class="form-group"><label for="asstPrincipalName">KoordinatÃ¶r MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±</label><input type="text" id="asstPrincipalName" class="form-input"></div>

                         <div class="form-group"><label for="principalName">Okul MÃ¼dÃ¼rÃ¼</label><input type="text" id="principalName" class="form-input"></div>


                    </div>

                    <div class="data-management-section">

                        <h3 style="color: var(--white); font-size: 1.2rem; margin-bottom: 15px;">Veri YÃ¶netimi</h3>

                        <div class="data-management-buttons">

                            <button class="btn btn-primary" id="download-data-btn">Verileri Ä°ndir</button>

                            <button class="btn" id="upload-data-btn">Verileri YÃ¼kle</button>

                            <button class="btn" id="print-list-btn">Liste YazdÄ±r</button>

                            <input type="file" id="upload-input" accept=".json" style="display: none;">

                        </div>

                    </div>

                </div>

                <div class="business-header-section">

                    <h2>Ä°ÅŸletmeler</h2>

                    <button class="btn btn-primary" id="add-business-btn">Yeni Ä°ÅŸletme Ekle</button>

                </div>

                <div id="businessesAccordion" style="margin-top: 20px;"></div>

                <div class="summary-panel" id="summary-panel">

                    <div class="summary-item">

                        <div id="totalBusinesses" class="count">0</div>

                        <div class="label">Toplam Ä°ÅŸletme</div>

                    </div>

                    <div class="summary-item">

                        <div id="totalStudents" class="count">0</div>

                        <div class="label">Toplam Ã–ÄŸrenci</div>

                    </div>

                </div>

            </div>

            

            <div id="generator-panel" class="tab-content">

                 <h2>Form OluÅŸtur</h2>

                 <div class="form-group">

                     <label>1. Form TÃ¼rÃ¼nÃ¼ SeÃ§in</label>

                     <select id="formTypeSelect" class="form-select">

                        <option value="attendance">DevamsÄ±zlÄ±k Ã‡izelgesi</option>

                        <option value="monthly_guidance">AylÄ±k Rehberlik Formu</option>

                        <option value="daily_guidance">GÃ¼nlÃ¼k Rehberlik Formu</option>

                     </select>

                 </div>



                <div id="controls-monthly" class="form-controls-container active">

                    <div class="form-group" style="grid-column: 1 / -1;">

                        <label for="business-select-dropdown">2. Ä°ÅŸletme(ler)i SeÃ§in</label>

                        <div class="dropdown-container">

                            <div class="dropdown-header" id="business-dropdown-header">

                                <span id="business-selected-text">Ä°ÅŸletme seÃ§in...</span>

                                <span class="dropdown-arrow">â–¼</span>

                            </div>

                            <div class="dropdown-content" id="business-dropdown-content">

                                <div class="dropdown-controls">

                                    <button type="button" class="dropdown-btn" id="select-all-businesses">TÃ¼mÃ¼nÃ¼ SeÃ§</button>

                                    <button type="button" class="dropdown-btn" id="deselect-all-businesses">Temizle</button>

                                </div>

                                <div id="business-dropdown-list"></div>

                            </div>

                        </div>

                    </div>

                    <div class="form-group"><label for="genMonthSelect">3. Ay</label><select id="genMonthSelect" class="form-select"></select></div>

                    <div class="form-group"><label for="genYearSelect">4. YÄ±l</label><input type="number" id="genYearSelect" class="form-input"></div>

                </div>



                <div id="controls-daily" class="form-controls-container">

                     <div class="form-group" style="grid-column: 1 / -1;"><label>2. Ay ve YÄ±l SeÃ§in</label></div>

                     <div class="form-group"><label for="dailyMonthSelect">Ay</label><select id="dailyMonthSelect" class="form-select"></select></div>

                     <div class="form-group"><label for="dailyYearSelect">YÄ±l</label><input type="number" id="dailyYearSelect" class="form-input"></div>

                    <div class="form-group" style="grid-column: 1 / -1;">

                        <label for="daily-business-select-dropdown">3. Ä°ÅŸletme(ler)i SeÃ§in</label>

                        <div class="dropdown-container">

                            <div class="dropdown-header" id="daily-business-dropdown-header">

                                <span id="daily-business-selected-text">Ä°ÅŸletme seÃ§in...</span>

                                <span class="dropdown-arrow">â–¼</span>

                            </div>

                            <div class="dropdown-content" id="daily-business-dropdown-content">

                                <div class="dropdown-controls">

                                    <button type="button" class="dropdown-btn" id="select-all-daily-businesses">TÃ¼mÃ¼nÃ¼ SeÃ§</button>

                                    <button type="button" class="dropdown-btn" id="deselect-all-daily-businesses">Temizle</button>

                                </div>

                                <div id="daily-business-dropdown-list"></div>

                            </div>

                        </div>

                    </div>

                    <div class="form-group"><label for="genWeekSelect1">4. Hafta SeÃ§in</label><select id="genWeekSelect1" class="form-select"></select></div>

                </div>

                 <button class="btn btn-primary" id="generate-sheet-btn" style="margin-top:20px; width: 100%; padding: 15px;">FormlarÄ± OluÅŸtur ve YazdÄ±r</button>

            </div>

            <div id="grade-sheet-panel" class="tab-content">
                <h2>DÃ¶nem Not FiÅŸi OluÅŸtur</h2>
                
                <div class="panel">
                    <div class="form-group">
                        <label for="gradeSheetPeriod">DÃ¶nem SeÃ§in</label>
                        <select id="gradeSheetPeriod" class="form-select">
                            <option value="1">1. DÃ¶nem</option>
                            <option value="2">2. DÃ¶nem</option>
                        </select>
                        
                    </div>
                    
                    <div class="form-group">
                        <label for="gradeSheetYear">Ã–ÄŸretim YÄ±lÄ±</label>
                        <input type="text" id="gradeSheetYear" class="form-input" value="2025-2026">
                    </div>
                    
                    <div class="form-group">
                        <label>Ä°ÅŸletme SeÃ§in (Birden Fazla SeÃ§ilebilir)</label>
                        <div class="dropdown-container">
                            <div class="dropdown-header" id="grade-sheet-business-dropdown-header">
                                <span id="grade-sheet-business-selected-text">TÃ¼m iÅŸletmeler seÃ§ili...</span>
                                <span class="dropdown-arrow">â–¼</span>
                            </div>
                            <div class="dropdown-content" id="grade-sheet-business-dropdown-content">
                                <div class="dropdown-controls">
                                    <button type="button" class="dropdown-btn" id="select-all-grade-businesses">TÃ¼mÃ¼nÃ¼ SeÃ§</button>
                                    <button type="button" class="dropdown-btn" id="deselect-all-grade-businesses">Temizle</button>
                                </div>
                                <div id="grade-sheet-business-dropdown-list"></div>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" id="generateGradeSheetBtn" style="margin-top: 20px; width: 100%; padding: 15px;">
                        Not FiÅŸlerini OluÅŸtur ve YazdÄ±r
                    </button>
                </div>
            </div>

        </div>

    </div>

    <div id="print-container"></div>

    <div class="modal" id="businessModal"><div class="modal-content"><h2 id="businessModalTitle"></h2><form id="businessForm" novalidate><input type="hidden" id="businessId"><div class="grid" style="grid-template-columns: 1fr 1fr;"><div class="form-group"><label for="businessName">Ä°ÅŸletme AdÄ±<span class="required-star">*</span></label><input required class="form-input" id="businessName" type="text"><span class="error-message"></span></div><div class="form-group"><label for="businessAddress">Ä°ÅŸletme Adresi</label><input class="form-input" id="businessAddress" type="text"></div><div class="form-group"><label for="businessPhone">Telefon <span class="field-hint">(Sadece rakam)</span></label><input class="form-input" id="businessPhone" inputmode="numeric" pattern="[0-9]*" placeholder="5051234567" type="text"><span class="error-message"></span></div><div class="form-group"><label for="businessOfficial">Ä°ÅŸletme Yetkilisi<span class="required-star">*</span></label><input required class="form-input" id="businessOfficial" type="text"><span class="error-message"></span></div><div class="form-group"><label for="businessVisitDay">KoordinatÃ¶r Ziyaret GÃ¼nÃ¼<span class="required-star">*</span></label><select required class="form-select" id="businessVisitDay"><option disabled selected value="">GÃ¼nÃ¼ SeÃ§in</option><option value="1">Pazartesi</option><option value="2">SalÄ±</option><option value="3">Ã‡arÅŸamba</option><option value="4">PerÅŸembe</option><option value="5">Cuma</option></select><span class="error-message"></span></div></div><div style="display:flex; gap:10px; margin-top:20px; justify-content:flex-end;"><button class="btn btn-danger" data-action="cancel-modal" type="button">Ä°ptal</button><button class="btn btn-primary" type="submit">Kaydet</button></div></form></div></div>

   <div class="modal" id="studentModal"><div class="modal-content"><h2 id="studentModalTitle"></h2><form id="studentForm" novalidate><input id="studentBusinessId" type="hidden"><input id="studentId" type="hidden"><div class="grid" style="grid-template-columns: 1fr 1fr;">
   <div class="form-group"><label for="studentClass">SÄ±nÄ±fÄ±</label><select class="form-select" id="studentClass"><option value="9">9. SÄ±nÄ±f</option><option value="10">10. SÄ±nÄ±f</option><option value="11">11. SÄ±nÄ±f</option><option value="12">12. SÄ±nÄ±f</option></select></div><div class="form-group"><label for="studentBranch">Åubesi</label><select class="form-select" id="studentBranch"><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="Foto">Foto</option></select></div><div class="form-group"><label for="studentNo">Okul No <span class="field-hint">(Sadece rakam)</span></label><input class="form-input" id="studentNo" inputmode="numeric" pattern="[0-9]*" placeholder="1234" type="text"></div>
   <div class="form-group"><label for="studentName">AdÄ± SoyadÄ±<span class="required-star">*</span></label><input required class="form-input" id="studentName" type="text"><span class="error-message"></span></div><div class="form-group"><label for="studentField">Alan/DalÄ±</label><input class="form-input" id="studentField" type="text" placeholder="Ã–rn: Erkek KuafÃ¶rlÃ¼ÄŸÃ¼"></div><div class="form-group"><label for="studentSchoolDay">Okul GÃ¼nÃ¼</label><select class="form-select" id="studentSchoolDay"><option value="1">Pazartesi</option><option value="2">SalÄ±</option><option value="3">Ã‡arÅŸamba</option><option value="4">PerÅŸembe</option><option value="5">Cuma</option></select></div><div class="form-group"><label for="studentPhone">Telefon <span class="field-hint">(Sadece rakam)</span></label><input class="form-input" id="studentPhone" inputmode="numeric" pattern="[0-9]*" placeholder="5051234567" type="text"></div><div class="form-group"><label for="studentStartDate">Ä°ÅŸe BaÅŸlama Tarihi (SÃ¶zleÅŸme)<span class="required-star">*</span></label><input required class="form-input" id="studentStartDate" type="date"><span class="error-message"></span></div><div class="form-group"><label for="studentEndDate">Ä°ÅŸten AyrÄ±lma Tarihi (Fesih)</label><input class="form-input" id="studentEndDate" type="date"><span class="error-message" id="studentEndDateError"></span></div></div><div style="display:flex; gap:10px; margin-top:20px; justify-content:flex-end;"><button class="btn btn-danger" data-action="cancel-modal" type="button">Ä°ptal</button><button class="btn btn-primary" type="submit">Kaydet</button></div></form></div></div>

    <div class="modal" id="terminationModal"><div class="modal-content"><h2>SÃ¶zleÅŸme Fesih Bilgileri</h2><form id="terminationForm"><input id="terminationStudentId" type="hidden"><input id="terminationBusinessId" type="hidden"><div class="form-group"><label for="terminationDate">Fesih Tarihi<span class="required-star">*</span></label><input required class="form-input" id="terminationDate" type="date"></div><div class="form-group" style="margin-top:15px;"><label for="terminationReason">Fesih Nedenleri<span class="required-star">*</span></label><textarea required class="form-input" id="terminationReason" rows="5"></textarea></div><div style="display:flex; gap:10px; margin-top:20px; justify-content:flex-end;"><button class="btn btn-danger" data-action="cancel-modal" type="button">Ä°ptal</button><button class="btn btn-primary" type="submit">Fesih TutanaÄŸÄ±nÄ± OluÅŸtur ve YazdÄ±r</button></div></form></div></div>

    <div id="absenceModal" class="modal"><div class="modal-content"><h2></h2><div class="grid" style="grid-template-columns: 1fr 1fr; align-items:end;"><div class="form-group"><label for="absenceMonthSelect">Ay</label><select id="absenceMonthSelect" class="form-select"></select></div><div class="form-group"><label for="absenceYearSelect">YÄ±l</label><input type="number" id="absenceYearSelect" class="form-input"></div></div><div class="grid calendar-grid-header" style="grid-template-columns: repeat(7, 1fr); margin-top: 15px;"><div class="calendar-header">Pzt</div><div class="calendar-header">Sal</div><div class="calendar-header">Ã‡ar</div><div class="calendar-header">Per</div><div class="calendar-header">Cum</div><div class="calendar-header">Cmt</div><div class="calendar-header">Paz</div></div><div id="absenceCalendarGrid" class="calendar-grid"></div><div style="display:flex; gap:10px; margin-top:20px; justify-content:flex-end;"><button type="button" class="btn btn-danger" data-action="cancel-modal">Kapat</button><button type="button" class="btn btn-primary" id="saveAbsenceBtn">DevamsÄ±zlÄ±ÄŸÄ± Kaydet</button></div></div>

    

    <div class="modal" id="qrPrePrintModal" style="cursor: pointer;">

    <div class="modal-content" style="max-width: 500px; text-align: center; background: var(--card-bg); border: 2px solid var(--accent-gold); border-radius: 10px; padding: 30px; margin: 10% auto; cursor: default;">

        <h2 style="color: var(--accent-gold); margin-bottom: 20px;">Formlar HazÄ±rlanÄ±yor</h2>

        <p style="color: var(--text-light); font-size: 1.1rem; line-height: 1.5; margin-bottom: 25px;">

            Belgeleriniz oluÅŸturuluyor. LÃ¼tfen bekleyin. Bu pencereyi kapatmak iÃ§in dÄ±ÅŸarÄ±daki herhangi bir alana tÄ±klayabilirsiniz.

        </p>

        <div id="processingSpinner" style="display: flex; justify-content: center; align-items: center; height: 100px; color: var(--accent-gold);">

            <svg width="60" height="60" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><style>.spinner_ajPY{transform-origin:center;animation:spinner_AtaB .75s infinite linear}@keyframes spinner_AtaB{100%{transform:rotate(360deg)}}</style><path d="M12,1A11,11,0,1,0,23,12,11,11,0,0,0,12,1Zm0,19a8,8,0,1,1,8-8A8,8,0,0,1,12,20Z" opacity=".25" fill="currentColor"/><path d="M10.14,1.16a11,11,0,0,0-9,8.92A1.59,1.59,0,0,0,2.46,12,1.52,1.52,0,0,0,4.11,10.7a8,8,0,0,1,6.66-6.61A1.42,1.42,0,0,0,12,2.69h0A1.57,1.57,0,0,0,10.14,1.16Z" class="spinner_ajPY" fill="currentColor"/></svg>

        </div>

    </div>

</div>

    

<script type="module">
    // 1. Firebase KÃ¼tÃ¼phanelerini import et
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // 2. Firebase ayarlarÄ±nÄ± yap ve baÅŸlat
    const firebaseConfig = {
        apiKey: "AIzaSyB8H41-2uK39kWSRhLJOBmnzdlaxzVyGC0",
        authDomain: "mesem-takip-sistemi-408d8.firebaseapp.com",
        projectId: "mesem-takip-sistemi-408d8",
        storageBucket: "mesem-takip-sistemi-408d8.appspot.com",
        messagingSenderId: "66667379009",
        appId: "1:66667379009:web:7303e9bb7cc49b751a89c0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // 3. TÃœM UYGULAMA MANTIÄI
    document.addEventListener('DOMContentLoaded', () => {
        
        let currentUser = null;
        let appData = {};
        let currentAbsence = { studentId: null, businessId: null };

        // DOM elementleri
        const dom = {
            loginSection: document.getElementById('login-section'),
            userInfo: document.getElementById('user-info'),
            userName: document.getElementById('user-name'),
            googleLoginBtn: document.getElementById('google-login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            container: document.querySelector('.container'),
            tabs: document.querySelector('.tabs'),
            settingsInputs: document.querySelectorAll('#management-panel .panel .form-input'),
            businessesAccordion: document.getElementById('businessesAccordion'),
            addBusinessBtn: document.getElementById('add-business-btn'),
            businessModal: document.getElementById('businessModal'),
            businessForm: document.getElementById('businessForm'),
            studentModal: document.getElementById('studentModal'),
            studentForm: document.getElementById('studentForm'),
            terminationModal: document.getElementById('terminationModal'),
            terminationForm: document.getElementById('terminationForm'),
            absenceModal: document.getElementById('absenceModal'),
            genMonthSelect: document.getElementById('genMonthSelect'),
            genYearSelect: document.getElementById('genYearSelect'),
            dailyMonthSelect: document.getElementById('dailyMonthSelect'),
            dailyYearSelect: document.getElementById('dailyYearSelect'),
            genWeekSelect1: document.getElementById('genWeekSelect1'),
            generateSheetBtn: document.getElementById('generate-sheet-btn'),
            printContainer: document.getElementById('print-container'),
            downloadBtn: document.getElementById('download-data-btn'),
            uploadBtn: document.getElementById('upload-data-btn'),
            uploadInput: document.getElementById('upload-input'),
            printListBtn: document.getElementById('print-list-btn'),
            formTypeSelect: document.getElementById('formTypeSelect'),
            controlsMonthly: document.getElementById('controls-monthly'),
            controlsDaily: document.getElementById('controls-daily'),
            totalBusinesses: document.getElementById('totalBusinesses'),
            totalStudents: document.getElementById('totalStudents'),
            businessDropdownList: document.getElementById('business-dropdown-list'),
            businessSelectedText: document.getElementById('business-selected-text'),
            dailyBusinessDropdownHeader: document.getElementById('daily-business-dropdown-header'),
            dailyBusinessDropdownContent: document.getElementById('daily-business-dropdown-content'),
            dailyBusinessDropdownList: document.getElementById('daily-business-dropdown-list'),
            dailyBusinessSelectedText: document.getElementById('daily-business-selected-text'),
            selectAllBusinesses: document.getElementById('select-all-businesses'),
            deselectAllBusinesses: document.getElementById('deselect-all-businesses'),
            selectAllDailyBusinesses: document.getElementById('select-all-daily-businesses'),
            deselectAllDailyBusinesses: document.getElementById('deselect-all-daily-businesses'),
        }

        // --- GÃ–RÃœNÃœM DÃœZENLEME: Okul GÃ¼nÃ¼ ve Tarihini Yan Yana Getir ---
        const schoolDaySelect = document.getElementById('studentSchoolDay');
        if (schoolDaySelect) {
            const parentGroup = schoolDaySelect.parentElement;
            if (!document.getElementById('studentSchoolDayChangeDate')) {
                parentGroup.style.display = 'grid';
                parentGroup.style.gridTemplateColumns = '1fr 1fr';
                parentGroup.style.gap = '10px';
                parentGroup.innerHTML = ''; 

                const dayDiv = document.createElement('div');
                dayDiv.innerHTML = `
                    <label for="studentSchoolDay">Okul GÃ¼nÃ¼</label>
                    <select class="form-select" id="studentSchoolDay">
                        <option value="1">Pazartesi</option>
                        <option value="2">SalÄ±</option>
                        <option value="3">Ã‡arÅŸamba</option>
                        <option value="4">PerÅŸembe</option>
                        <option value="5">Cuma</option>
                    </select>
                `;
                parentGroup.appendChild(dayDiv);

                const dateDiv = document.createElement('div');
                dateDiv.innerHTML = `
                    <label for="studentSchoolDayChangeDate" style="color: var(--accent-gold);">GeÃ§erlilik Tarihi</label>
                    <input class="form-input" id="studentSchoolDayChangeDate" type="date">
                `;
                parentGroup.appendChild(dateDiv);
                
                const hintDiv = document.createElement('div');
                hintDiv.style.gridColumn = '1 / -1';
                hintDiv.innerHTML = '<span class="field-hint" style="font-size: 0.75rem;">Ã–ÄŸrencinin okul gÃ¼nÃ¼ deÄŸiÅŸtiyse, yeni gÃ¼nÃ¼ seÃ§ip saÄŸ taraftan hangi tarihten itibaren geÃ§erli olduÄŸunu giriniz.</span>';
                parentGroup.appendChild(hintDiv);
            }
        }

        // --- Firebase FonksiyonlarÄ± ---
        async function signInWithGoogle() {
            try {
                const provider = new GoogleAuthProvider();
                provider.setCustomParameters({ prompt: 'select_account' });
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('GiriÅŸ hatasÄ±:', error);
                showNotification('GiriÅŸ yapÄ±lamadÄ±: ' + error.message, 'error');
            }
        }

        async function loadUserData() {
            if (!currentUser) return;
            try {
                const userDocRef = doc(db, 'users', currentUser.uid);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    appData = userDoc.data();
                } else {
                    appData = { 
                        settings: { 
                            schoolName: 'UÅAK MESLEKÄ° VE TEKNÄ°K ANADOLU LÄ°SESÄ°', 
                            coordinatorName: '', 
                            asstPrincipalName: 'Salih SEVÄ°M', 
                            principalName: 'SeÃ§kin ÅENTÃœRK' 
                        }, 
                        businesses: [] 
                    };
                }
                Object.keys(appData.settings).forEach(key => { 
                    if(document.getElementById(key)) document.getElementById(key).value = appData.settings[key]; 
                });
                checkAndUpgradeClasses();
                renderAll();
            } catch (error) {
                console.error('Veri yÃ¼kleme hatasÄ±:', error);
                showNotification('Veri yÃ¼klenirken bir hata oluÅŸtu.', 'error');
            }
        }
    
        async function saveData() {
            if (!currentUser) return;
            dom.settingsInputs.forEach(input => { 
                if(input.id && appData.settings) {
                    appData.settings[input.id] = input.value; 
                }
            });
            try {
                await setDoc(doc(db, 'users', currentUser.uid), appData);
                console.log('Veri baÅŸarÄ±yla buluta kaydedildi.');
            } catch (error) {
                console.error('Buluta kaydetme hatasÄ±:', error);
                showNotification('Veri kaydedilirken bir hata oluÅŸtu.', 'error');
            }
        }

        // YardÄ±mcÄ± Fonksiyonlar
        const monthNames = ["Ocak", "Åubat", "Mart", "Nisan", "MayÄ±s", "Haziran", "Temmuz", "AÄŸustos", "EylÃ¼l", "Ekim", "KasÄ±m", "AralÄ±k"];
        const publicHolidays = {
            '2024': [{ month: 9, day: 29, halfDay: false }],
            '2025': [
                { month: 0, day: 1, halfDay: false }, { month: 2, day: 29, halfDay: true }, { month: 2, day: 30, halfDay: false },
                { month: 2, day: 31, halfDay: false }, { month: 3, day: 1, halfDay: false }, { month: 3, day: 23, halfDay: false },
                { month: 4, day: 1, halfDay: false }, { month: 4, day: 19, halfDay: false }, { month: 5, day: 5, halfDay: true },
                { month: 5, day: 6, halfDay: false }, { month: 5, day: 7, halfDay: false }, { month: 5, day: 8, halfDay: false },
                { month: 5, day: 9, halfDay: false }, { month: 6, day: 15, halfDay: false }, { month: 7, day: 30, halfDay: false },
                { month: 9, day: 28, halfDay: true }, { month: 9, day: 29, halfDay: false }
            ],
            '2026': [
                { month: 0, day: 1, halfDay: false }, { month: 2, day: 19, halfDay: true }, { month: 2, day: 20, halfDay: false },
                { month: 2, day: 21, halfDay: false }, { month: 2, day: 22, halfDay: false }, { month: 3, day: 23, halfDay: false },
                { month: 4, day: 1, halfDay: false }, { month: 4, day: 19, halfDay: false }, { month: 5, day: 26, halfDay: true },
                { month: 5, day: 27, halfDay: false }, { month: 5, day: 28, halfDay: false }, { month: 5, day: 29, halfDay: false },
                { month: 5, day: 30, halfDay: false }, { month: 6, day: 15, halfDay: false }, { month: 7, day: 30, halfDay: false },
                { month: 9, day: 28, halfDay: true }, { month: 9, day: 29, halfDay: false }
            ]
        };
        const schoolHolidays = [
            { start: new Date(2024, 10, 11), end: new Date(2024, 10, 15) }, { start: new Date(2025, 0, 20), end: new Date(2025, 1, 2) },
            { start: new Date(2025, 3, 7), end: new Date(2025, 3, 11) }, { start: new Date(2025, 5, 14), end: new Date(2025, 8, 7) },
            { start: new Date(2025, 10, 10), end: new Date(2025, 10, 14) }, { start: new Date(2026, 0, 19), end: new Date(2026, 0, 30) },
            { start: new Date(2026, 2, 16), end: new Date(2026, 2, 20) }, { start: new Date(2026, 5, 27), end: new Date(2026, 8, 6) }
        ];

        function isPublicHoliday(date) {
            const year = date.getFullYear().toString();
            const month = date.getMonth();
            const day = date.getDate();
            if (!publicHolidays[year]) return false;
            return publicHolidays[year].some(holiday => holiday.month === month && holiday.day === day);
        }

        function isSchoolHoliday(date) {
            const checkDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            return schoolHolidays.some(period => checkDate >= period.start && checkDate <= period.end);
        }

        function parseDateString(dateStr) { 
            if (!dateStr) return null; 
            const parts = dateStr.split('-');
            return new Date(parts[0], parts[1] - 1, parts[2]); 
        }

        // DÃœZELTÄ°LMÄ°Å FONKSÄ°YON: Okul GÃ¼nÃ¼ GeÃ§miÅŸini Kontrol Et (Hafta BazlÄ±)
        function getSchoolDayForDate(student, targetDate) {
            const checkDate = new Date(targetDate);
            checkDate.setHours(0, 0, 0, 0);

            // EÄŸer geÃ§miÅŸ yoksa, mevcut gÃ¼nÃ¼ dÃ¶ndÃ¼r
            if (!student.schoolDayHistory || !Array.isArray(student.schoolDayHistory) || student.schoolDayHistory.length === 0) {
                return parseInt(student.schoolDay);
            }

            // YardÄ±mcÄ± fonksiyon: HaftanÄ±n Pazartesi gÃ¼nÃ¼nÃ¼ bul
            function getWeekStart(date) {
                const d = new Date(date);
                d.setHours(0, 0, 0, 0);
                const dayOfWeek = d.getDay();
                const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                d.setDate(d.getDate() - daysToSubtract);
                return d;
            }

            // Kontrol edilen tarihin hafta baÅŸlangÄ±cÄ±
            const checkWeekStart = getWeekStart(checkDate);

            // Tarihe gÃ¶re sÄ±rala (Yeniden eskiye)
            const sortedHistory = [...student.schoolDayHistory].sort((a, b) => {
                return new Date(b.startDate) - new Date(a.startDate);
            });

            // DeÄŸiÅŸiklik tarihinin hafta baÅŸlangÄ±cÄ±ndan itibaren geÃ§erli olacak ÅŸekilde kontrol et
            const validRecord = sortedHistory.find(record => {
                const recordDate = parseDateString(record.startDate);
                if (recordDate) {
                    recordDate.setHours(0, 0, 0, 0);
                    // DeÄŸiÅŸiklik tarihinin hafta baÅŸlangÄ±cÄ±nÄ± bul
                    const recordWeekStart = getWeekStart(recordDate);
                    // EÄŸer kontrol edilen haftanÄ±n Pazartesi'si, deÄŸiÅŸiklik haftasÄ±nÄ±n Pazartesi'sine eÅŸit veya sonraysa
                    return recordWeekStart <= checkWeekStart;
                }
                return false;
            });

            if (validRecord) {
                return parseInt(validRecord.day);
            }

            // EÄŸer tarih, tÃ¼m geÃ§miÅŸ kayÄ±tlarÄ±ndan daha eskiyse (eski haftalara ait),
            // tarihteki EN ESKÄ° (ilk) kaydÄ± dÃ¶ndÃ¼r.
            const oldestRecord = sortedHistory[sortedHistory.length - 1];
            return parseInt(oldestRecord.day);
        }

        function getWeekOfYear(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }

        function checkAndUpgradeClasses() {
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();
            if (currentMonth >= 8) { 
                const academicYear = currentYear;
                if (!appData.lastClassUpgrade || appData.lastClassUpgrade < academicYear) {
                    (appData.businesses || []).forEach(business => {
                        (business.students || []).forEach(student => {
                            if (student.class && !student.endDate) {
                                const currentClass = parseInt(student.class);
                                if (currentClass < 12) student.class = (currentClass + 1).toString();
                            }
                        });
                    });
                    appData.lastClassUpgrade = academicYear;
                    saveData();
                }
            }
        }

        function showNotification(message, type = 'info', callback = null) {
            let alertModal = document.getElementById('alertModal');
            if (!alertModal) {
                alertModal = document.createElement('div');
                alertModal.id = 'alertModal';
                alertModal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;display:none;';
                document.body.appendChild(alertModal);
            }
            const modal = document.getElementById('alertModal');
            if (type === 'confirm') {
                modal.innerHTML = `<div style="background:var(--card-bg);padding:30px;width:400px;text-align:center;border:2px solid var(--accent-gold);border-radius:10px;position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);"><h2 style="color:var(--accent-gold);">âš ï¸ Onay</h2><p style="color:var(--text-light);">${message}</p><div style="display:flex;gap:15px;justify-content:center;margin-top:20px;"><button id="confirmYes" class="btn btn-danger">Evet</button><button id="confirmNo" class="btn">HayÄ±r</button></div></div>`;
                modal.style.display = 'block';
                document.getElementById('confirmYes').onclick = function() { modal.style.display = 'none'; if (callback) callback(true); };
                document.getElementById('confirmNo').onclick = function() { modal.style.display = 'none'; if (callback) callback(false); };
            } else {
                modal.innerHTML = '<div style="background:var(--card-bg);padding:30px;width:400px;text-align:center;border:2px solid var(--accent-gold);border-radius:10px;position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);"><h2 style="color:var(--accent-gold);">âš ï¸ UyarÄ±</h2><p style="color:var(--text-light);">' + message + '</p></div>';
                modal.style.display = 'block';
                modal.onclick = function(e) { if (e.target === modal) modal.style.display = 'none'; };
            }
        }

        function renderAll() { renderBusinessesAccordion(); renderGeneratorUI(); updateSummaryPanel(); populateGradeSheetBusinessSelect(); }

        function renderBusinessesAccordion() {
            dom.businessesAccordion.innerHTML = appData.businesses.map(b => `<div><div class="accordion-header" data-id="${b.id}"><h3>${b.name}</h3><span>${b.students?.length||0} Ã–ÄŸrenci</span></div><div class="accordion-content" id="content-${b.id}">${renderBusinessContent(b)}</div></div>`).join('') || '<p style="text-align:center; margin-top:20px;">KayÄ±tlÄ± iÅŸletme bulunmuyor.</p>';
        }

        function renderBusinessContent(business) {
            const studentList = (business.students && business.students.length > 0) ?
                business.students.map(s => {
                    const isTerminated = s.endDate;
                    let actionButtons = '';
                    if (isTerminated) {
                        actionButtons = `<button class="btn" style="padding:5px 10px; background-color: #f59e0b;" data-action="open-termination-modal" data-business-id="${business.id}" data-id="${s.id}">Feshi DÃ¼zenle/YazdÄ±r</button> <button class="btn" style="padding:5px 10px; border-color: #8ab4f8; color: #8ab4f8;" data-action="cancel-termination" data-business-id="${business.id}" data-student-id="${s.id}">Feshi Ä°ptal Et</button> <button class="btn btn-danger" style="padding:5px 10px;" data-action="delete-student" data-business-id="${business.id}" data-id="${s.id}">Sil</button>`;
                    } else {
                        actionButtons = `<button class="btn" style="padding:5px 10px;" data-action="open-absence-modal" data-business-id="${business.id}" data-id="${s.id}">DevamsÄ±zlÄ±k</button> <button class="btn" style="padding:5px 10px;" data-action="edit-student" data-business-id="${business.id}" data-id="${s.id}">DÃ¼zenle</button> <button class="btn btn-danger" style="padding:5px 10px;" data-action="open-termination-modal" data-business-id="${business.id}" data-id="${s.id}">Feshet</button> <button class="btn btn-danger" style="padding:5px 10px;" data-action="delete-student" data-business-id="${business.id}" data-id="${s.id}">Sil</button>`;
                    }
                    return `<div class="student-item"> <div class="student-info"> <strong style="${isTerminated ? 'text-decoration: line-through; color: var(--slate);' : ''}">${s.name}</strong> <small>${s.field || 'Alan belirtilmedi'} ${s.phone ? `- Tel: ${s.phone}` : ''} ${isTerminated ? `(Fesih: ${parseDateString(s.endDate).toLocaleDateString('tr-TR')})` : ''}</small> </div> <div class="student-actions">${actionButtons}</div> </div>`;
                }).join('') : '<p>Bu iÅŸletmeye kayÄ±tlÄ± Ã¶ÄŸrenci bulunmamaktadÄ±r.</p>';
            return `<div style="display:flex; gap:10px; margin-bottom:20px;"> <button class="btn btn-primary" data-action="add-student" data-id="${business.id}">Ã–ÄŸrenci Ekle</button> <button class="btn" data-action="edit-business" data-id="${business.id}">Ä°ÅŸletmeyi DÃ¼zenle</button> <button class="btn btn-danger" data-action="delete-business" data-id="${business.id}">Ä°ÅŸletmeyi Sil</button> </div>${studentList}`;
        }

        function renderGeneratorUI() {
            renderBusinessDropdowns();
            const monthOptions = monthNames.map((n,i) => `<option value="${i}">${n}</option>`).join('');
            dom.genMonthSelect.innerHTML = monthOptions;
            dom.dailyMonthSelect.innerHTML = monthOptions;
            const today = new Date();
            dom.genYearSelect.value = today.getFullYear(); 
            dom.genMonthSelect.value = today.getMonth();
            dom.dailyYearSelect.value = today.getFullYear();
            dom.dailyMonthSelect.value = today.getMonth();
            populateWeeksForDailyForm();
        }

        function renderBusinessDropdowns() {
            const businessItems = appData.businesses.map(b => `<div class="dropdown-item"><input type="checkbox" value="${b.id}" class="business-checkbox" id="monthly-business-${b.id}"><label for="monthly-business-${b.id}">${b.name}</label></div>`).join('');
            const dailyBusinessItems = appData.businesses.map(b => `<div class="dropdown-item"><input type="checkbox" value="${b.id}" class="daily-business-checkbox" id="daily-business-${b.id}"><label for="daily-business-${b.id}">${b.name}</label></div>`).join('');
            dom.businessDropdownList.innerHTML = businessItems || '<div style="padding: 15px; text-align: center; color: var(--text-light);">Ä°ÅŸletme bulunamadÄ±</div>';
            dom.dailyBusinessDropdownList.innerHTML = dailyBusinessItems || '<div style="padding: 15px; text-align: center; color: var(--text-light);">Ä°ÅŸletme bulunamadÄ±</div>';
            updateDropdownText();
        }

        function updateDropdownText() {
            const selectedBusinesses = Array.from(document.querySelectorAll('.business-checkbox:checked'));
            const selectedDaily = Array.from(document.querySelectorAll('.daily-business-checkbox:checked'));
            if (selectedBusinesses.length === 0) dom.businessSelectedText.textContent = 'Ä°ÅŸletme seÃ§in...';
            else if (selectedBusinesses.length === 1) dom.businessSelectedText.textContent = selectedBusinesses[0].nextElementSibling.textContent;
            else dom.businessSelectedText.textContent = `${selectedBusinesses.length} iÅŸletme seÃ§ildi`;
            if (selectedDaily.length === 0) dom.dailyBusinessSelectedText.textContent = 'Ä°ÅŸletme seÃ§in...';
            else if (selectedDaily.length === 1) dom.dailyBusinessSelectedText.textContent = selectedDaily[0].nextElementSibling.textContent;
            else dom.dailyBusinessSelectedText.textContent = `${selectedDaily.length} iÅŸletme seÃ§ildi`;
        }

        function populateWeeksForDailyForm() {
            const month = parseInt(dom.dailyMonthSelect.value);
            const year = parseInt(dom.dailyYearSelect.value);
            const weeks = [];
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            let firstMonday = new Date(firstDayOfMonth);
            const firstDayWeekday = firstDayOfMonth.getDay();
            const daysToSubtract = firstDayWeekday === 0 ? 6 : firstDayWeekday - 1;
            firstMonday.setDate(firstDayOfMonth.getDate() - daysToSubtract);
            let monthWeekNumber = 1;
            let currentMonday = new Date(firstMonday);
            while (currentMonday <= lastDayOfMonth) {
                const weekStart = new Date(currentMonday);
                const weekEnd = new Date(currentMonday);
                weekEnd.setDate(weekEnd.getDate() + 6);
                if (weekEnd >= firstDayOfMonth && weekStart <= lastDayOfMonth) {
                    const yearWeekNumber = getWeekOfYear(weekStart);
                    const label = `${yearWeekNumber}. Hafta (${weekStart.toLocaleDateString('tr-TR')} - ${weekEnd.toLocaleDateString('tr-TR')})`;
                    weeks.push({ week: monthWeekNumber, label: label, startDate: weekStart, endDate: weekEnd });
                    monthWeekNumber++;
                }
                currentMonday.setDate(currentMonday.getDate() + 7);
            }
            dom.genWeekSelect1.innerHTML = weeks.map(w => `<option value="${w.week}">${w.label}</option>`).join('');
            const today = new Date();
            if (year === today.getFullYear() && month === today.getMonth()) {
                const currentWeekObject = weeks.find(w => today >= w.startDate && today <= w.endDate);
                if (currentWeekObject) dom.genWeekSelect1.value = currentWeekObject.week;
            }
        }

        function updateSummaryPanel() {
            dom.totalBusinesses.textContent = appData.businesses.length;
            const totalStudents = appData.businesses.reduce((sum, business) => sum + (business.students ? business.students.length : 0), 0);
            dom.totalStudents.textContent = totalStudents;
        }

        // --- Modal Ä°ÅŸlemleri ---
        function openModal(modalId, data) {
            const modal = document.getElementById(modalId);
            const form = modal.querySelector('form'); 
            if (form) form.reset();
            if (form) { 
                form.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
                form.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid')); 
            }
            const title = modal.querySelector('h2');
            if (modalId === 'businessModal') {
                if (data && data.id) { 
                    const b = appData.businesses.find(b => b.id === data.id);
                    title.textContent = 'Ä°ÅŸletmeyi DÃ¼zenle'; 
                    form.querySelector('#businessId').value = b.id; 
                    form.querySelector('#businessName').value = b.name; 
                    form.querySelector('#businessAddress').value = b.address; 
                    form.querySelector('#businessPhone').value = b.phone; 
                    form.querySelector('#businessOfficial').value = b.official;
                    form.querySelector('#businessVisitDay').value = b.visitDay; 
                } else { 
                    title.textContent = 'Yeni Ä°ÅŸletme Ekle';
                    form.querySelector('#businessId').value = ''; 
                }
            } else if (modalId === 'studentModal') {
                form.querySelector('#studentBusinessId').value = data.businessId;
                const historyInput = document.getElementById('studentSchoolDayChangeDate');
                if(historyInput) historyInput.value = '';
                if (data && data.id) { 
                    const s = appData.businesses.find(b => b.id === data.businessId).students.find(s => s.id === data.id);
                    title.textContent = 'Ã–ÄŸrenciyi DÃ¼zenle'; 
                    form.querySelector('#studentId').value = s.id; 
                    form.querySelector('#studentClass').value = s.class || '9';
                    form.querySelector('#studentBranch').value = s.branch || 'A';
                    form.querySelector('#studentNo').value = s.no;
                    form.querySelector('#studentName').value = s.name; 
                    form.querySelector('#studentField').value = s.field; 
                    form.querySelector('#studentSchoolDay').value = s.schoolDay; 
                    form.querySelector('#studentPhone').value = s.phone; 
                    form.querySelector('#studentStartDate').value = s.startDate; 
                    form.querySelector('#studentEndDate').value = s.endDate;
                } else { 
                    title.textContent = 'Yeni Ã–ÄŸrenci Ekle';
                    form.querySelector('#studentId').value = ''; 
                }
            } else if (modalId === 'terminationModal') {
                form.querySelector('#terminationStudentId').value = data.studentId;
                form.querySelector('#terminationBusinessId').value = data.businessId;
                const currentBusiness = appData.businesses.find(b => b.id === data.businessId);
                const currentStudent = currentBusiness.students.find(s => s.id === data.studentId);
                if (currentStudent.endDate) {
                    form.querySelector('#terminationDate').value = currentStudent.endDate;
                    form.querySelector('#terminationReason').value = currentStudent.terminationReason || '';
                    modal.querySelector('button[type="submit"]').textContent = "Feshi GÃ¼ncelle ve YazdÄ±r";
                } else {
                    form.querySelector('#terminationDate').value = new Date().toISOString().slice(0, 10);
                    form.querySelector('#terminationReason').value = '';
                    modal.querySelector('button[type="submit"]').textContent = "Fesih TutanaÄŸÄ±nÄ± OluÅŸtur ve YazdÄ±r";
                }
            } else if (modalId === 'absenceModal') {
                currentAbsence = { studentId: data.studentId, businessId: data.businessId };
                const student = appData.businesses.find(b=>b.id===data.businessId).students.find(s=>s.id===data.studentId);
                modal.querySelector('h2').textContent = `${student.name} - DevamsÄ±zlÄ±k GiriÅŸi`;
                const monthSelect = modal.querySelector('#absenceMonthSelect');
                const yearSelect = modal.querySelector('#absenceYearSelect');
                if (monthSelect.innerHTML === '') { monthSelect.innerHTML = monthNames.map((n,i) => `<option value="${i}">${n}</option>`).join(''); }
                monthSelect.value = new Date().getMonth(); 
                yearSelect.value = new Date().getFullYear();
                renderAbsenceCalendar();
            }
            const mc = modal.querySelector('.modal-content');
            mc.style.top = '50%';
            mc.style.left = '50%';
            mc.style.transform = 'translate(-50%, -50%)';
            modal.style.display = 'block';
        }

        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }

        function validateForm(form) {
            let isValid = true;
            form.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            form.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
            form.querySelectorAll('[required]').forEach(input => {
                const errorSpan = input.parentElement.querySelector('.error-message');
                if (!input.value.trim()) {
                    input.classList.add('invalid');
                    if (errorSpan) { errorSpan.textContent = "Bu alan zorunludur."; errorSpan.style.display = 'block'; }
                    isValid = false;
                }
            });
            const phoneFields = form.querySelectorAll('input[inputmode="numeric"]');
            phoneFields.forEach(input => {
                const errorSpan = input.parentElement.querySelector('.error-message');
                if (input.value && !/^[0-9]+$/.test(input.value)) {
                    input.classList.add('invalid');
                    if (errorSpan) { errorSpan.textContent = "Sadece rakam giriniz."; errorSpan.style.display = 'block'; }
                    isValid = false;
                }
            });
            return isValid;
        }

        function validateStudentForm() {
            if (!validateForm(dom.studentForm)) return false;
            const startDate = dom.studentForm.querySelector('#studentStartDate').value;
            const endDate = dom.studentForm.querySelector('#studentEndDate').value;
            const errorSpan = dom.studentForm.querySelector('#studentEndDateError');
            const endDateInput = dom.studentForm.querySelector('#studentEndDate');
            if (startDate && endDate && parseDateString(endDate) < parseDateString(startDate)) {
                errorSpan.textContent = 'Fesih tarihi, baÅŸlama tarihinden Ã¶nce olamaz.';
                errorSpan.style.display = 'block';
                endDateInput.classList.add('invalid');
                return false;
            } else {
                errorSpan.style.display = 'none';
                endDateInput.classList.remove('invalid');
            }
            return true;
        }

        // --- Veri KayÄ±t Ä°ÅŸlemleri ---
        function saveBusiness(e) { 
            e.preventDefault();
            if (!validateForm(dom.businessForm)) return; 
            const form = dom.businessForm; 
            const id = form.querySelector('#businessId').value; 
            const businessData = { 
                id: id || Date.now().toString(), 
                name: form.querySelector('#businessName').value, 
                address: form.querySelector('#businessAddress').value, 
                phone: form.querySelector('#businessPhone').value, 
                official: form.querySelector('#businessOfficial').value, 
                visitDay: form.querySelector('#businessVisitDay').value, 
                students: id ? appData.businesses.find(b => b.id === id).students : [] 
            }; 
            if (id) appData.businesses = appData.businesses.map(b => b.id === id ? businessData : b);
            else { 
                if(!appData.businesses) appData.businesses = []; 
                appData.businesses.push(businessData); 
            } 
            saveData(); 
            renderAll(); 
            closeModal('businessModal');
            showNotification('Ä°ÅŸletme baÅŸarÄ±yla kaydedildi.', 'success'); 
        }

        function saveStudent(e) { 
            e.preventDefault(); 
            if (!validateStudentForm()) return; 
            const form = dom.studentForm;
            const businessId = form.querySelector('#studentBusinessId').value; 
            const id = form.querySelector('#studentId').value; 
            const business = appData.businesses.find(b => b.id === businessId);
            const existingStudent = id ? business.students.find(s => s.id === id) : {}; 
            
            const newSchoolDay = form.querySelector('#studentSchoolDay').value;
            const changeDateInput = form.querySelector('#studentSchoolDayChangeDate').value;
            let history = existingStudent.schoolDayHistory || [];

            if (id && changeDateInput) {
                if (history.length === 0) {
                     // EÄŸer ilk kayÄ±t yoksa, Ã¶ÄŸrencinin iÅŸe giriÅŸ tarihiyle eski gÃ¼nÃ¼nÃ¼ kaydet
                     history.push({
                         startDate: existingStudent.startDate,
                         day: existingStudent.schoolDay
                     });
                }
                // Yeni tarihi ekle
                history.push({
                    startDate: changeDateInput,
                    day: newSchoolDay
                });
            }

            const studentData = { 
                id: id || Date.now().toString(), 
                no: form.querySelector('#studentNo').value, 
                name: form.querySelector('#studentName').value, 
                class: form.querySelector('#studentClass').value, 
                branch: form.querySelector('#studentBranch').value, 
                field: form.querySelector('#studentField').value, 
                schoolDay: newSchoolDay,
                schoolDayHistory: history,
                phone: form.querySelector('#studentPhone').value, 
                startDate: form.querySelector('#studentStartDate').value, 
                endDate: form.querySelector('#studentEndDate').value, 
                terminationReason: existingStudent.terminationReason || '', 
                absences: existingStudent.absences || {} 
            }; 
            
            if (id) {
                business.students = business.students.map(s => s.id === id ? studentData : s);
            } else {
                if(!business.students) business.students = [];
                business.students.push(studentData);
            }
            saveData(); 
            renderAll(); 
            closeModal('studentModal');
            showNotification('Ã–ÄŸrenci baÅŸarÄ±yla kaydedildi.', 'success'); 
        }

        function deleteBusiness(id) {
            showNotification('Ä°ÅŸletmeyi ve iÃ§indeki tÃ¼m Ã¶ÄŸrencileri silmek istediÄŸinizden emin misiniz?', 'confirm', (result) => {
                if (result) {
                    appData.businesses = appData.businesses.filter(b => b.id !== id);
                    saveData();
                    renderAll();
                    showNotification('Ä°ÅŸletme baÅŸarÄ±yla silindi.', 'success');
                }
            });
        }

        function deleteStudent(id, businessId) {
            showNotification('Ã–ÄŸrenciyi kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz?', 'confirm', (result) => {
                if (result) {
                    const business = appData.businesses.find(b => b.id === businessId);
                    business.students = business.students.filter(s => s.id !== id);
                    saveData();
                    renderAll();
                    showNotification('Ã–ÄŸrenci baÅŸarÄ±yla silindi.', 'success');
                }
            });
        }

        function cancelTermination(id, businessId) {
            showNotification('Ã–ÄŸrencinin sÃ¶zleÅŸme feshini iptal etmek istediÄŸinizden emin misiniz?', 'confirm', (result) => {
                if (result) {
                    const business = appData.businesses.find(b => b.id === businessId);
                    const student = business.students.find(s => s.id === id);
                    student.endDate = '';
                    student.terminationReason = '';
                    saveData();
                    renderAll();
                    showNotification('SÃ¶zleÅŸme feshi iptal edildi.', 'success');
                }
            });
        }    

        function renderAbsenceCalendar() {
            const { studentId, businessId } = currentAbsence;
            const modal = dom.absenceModal;
            const month = parseInt(modal.querySelector('#absenceMonthSelect').value);
            const year = parseInt(modal.querySelector('#absenceYearSelect').value);
            const grid = modal.querySelector('#absenceCalendarGrid');
            const student = appData.businesses.find(b => b.id === businessId).students.find(s => s.id === studentId);
            grid.innerHTML = '';
            const firstDay = (new Date(year, month, 1).getDay() + 6) % 7;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for(let i=0; i<firstDay; i++) { grid.insertAdjacentHTML('beforeend', '<div class="calendar-day empty"></div>'); }
            for(let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.innerHTML = `<div class="calendar-day-num">${day}</div><div class="calendar-day-status"></div>`;
                const currentDate = new Date(year, month, day); 
                currentDate.setHours(0,0,0,0);
                const dayOfWeek = currentDate.getDay();
                const sStart = parseDateString(student.startDate); if(sStart) sStart.setHours(0,0,0,0);
                const sEnd = student.endDate ? parseDateString(student.endDate) : null; if(sEnd) sEnd.setHours(0,0,0,0);
                let isOutOfRange = (sStart && currentDate < sStart) || (sEnd && currentDate > sEnd);
                
                if (!isOutOfRange) {
                    const monthYearKey = `${year}-${month}`;
                    const studentAbsences = student.absences?.[monthYearKey]?.[day] || [];
                    const statusEl = dayEl.querySelector('.calendar-day-status');
                    const activeSchoolDay = getSchoolDayForDate(student, currentDate);

                    if(dayOfWeek == activeSchoolDay) { dayEl.classList.add('school'); statusEl.textContent = 'O'; statusEl.classList.add('f-blue'); }
                    else if(dayOfWeek === 0) { dayEl.classList.add('sunday'); statusEl.textContent = 'T'; statusEl.classList.add('f-green'); }
                    else {
                        dayEl.classList.add('workday');
                        dayEl.dataset.day = day;
                        let statusText = '';
                        if (studentAbsences.includes('S')) statusText += 'S';
                        if (studentAbsences.includes('Ã–')) statusText += 'Ã–';
                        statusEl.innerHTML = statusText.replace('SÃ–', 'S<br>Ã–');
                        if(statusText !== '') statusEl.classList.add('f-gold');
                    }
                } else { dayEl.classList.add('empty'); }
                grid.appendChild(dayEl);
            }
        }

        function saveAbsences() {
            const { studentId, businessId } = currentAbsence;
            const modal = dom.absenceModal; const month = modal.querySelector('#absenceMonthSelect').value; const year = modal.querySelector('#absenceYearSelect').value;
            const monthYearKey = `${year}-${month}`;
            const student = appData.businesses.find(b => b.id === businessId).students.find(s => s.id === studentId);
            if(!student.absences) student.absences = {}; if(!student.absences[monthYearKey]) student.absences[monthYearKey] = {};
            modal.querySelectorAll('.calendar-day.workday').forEach(dayEl => {
                const day = parseInt(dayEl.dataset.day); const status = dayEl.querySelector('.calendar-day-status').textContent;
                let absenceData = [];
                if(status.includes('S')) absenceData.push('S');
                if(status.includes('Ã–')) absenceData.push('Ã–');
                if (absenceData.length > 0) student.absences[monthYearKey][day] = absenceData;
                else if (student.absences[monthYearKey][day]) delete student.absences[monthYearKey][day];
            });
            saveData(); closeModal('absenceModal'); showNotification('DevamsÄ±zlÄ±k kayÄ±tlarÄ± gÃ¼ncellendi.', 'success');
        }

        function generateListPrint() {
            // 1. Verileri AlalÄ±m
            const okulAdi = document.getElementById('schoolName')?.value || "UÅAK MESLEKÄ° VE TEKNÄ°K ANADOLU LÄ°SESÄ°";
            const yil = document.getElementById('year')?.value || "2025 - 2026";
            const donem = "2. DÃ¶nem"; 
            
            // Ä°ÅŸletme bilgilerini buraya Ã§ekiyoruz
            const isletmeAdi = ".........................................................................................."; 
            const isletmeTel = ".......................";
            const isletmeEmail = ".......................";

            // Yetkili Ä°simleri
            const ustaOgreticiAd = ".......................";
            const isletmeYetkilisiAd = ustaOgreticiAd; // AynÄ± isim olsun demiÅŸtiniz
            const koordOgretmenAd = ".......................";
            const mudurYrdAd = ".......................";
            const okulMuduruAd = ".......................";

            let html = `
            <div id="printArea">
                <div style="text-align: right; font-size: 8pt; font-family: Calibri;">IME-DNOT</div>
                
                <div style="text-align: center; font-weight: bold; font-size: 14pt; font-family: Calibri; margin-bottom: 10px;">
                    Ä°ÅLETMELERDE MESLEKÄ° EÄÄ°TÄ°M GÃ–REN Ã–ÄRENCÄ°LERE AÄ°T DÃ–NEM NOT FÄ°ÅÄ°
                </div>

                <table class="form-header-table">
                    <tr>
                        <td style="width: 13%; font-weight: bold;">Okul/Kurumun AdÄ±</td>
                        <td style="width: 1%;">:</td>
                        <td colspan="5" style="border-bottom: 1px dotted #000;">${okulAdi}</td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold;">Ã–ÄŸretim YÄ±lÄ±</td>
                        <td>:</td>
                        <td style="width: 15%; border-bottom: 1px dotted #000;">${yil}</td>
                        
                        <td style="width: 5%; font-weight: bold; text-align: right;">DÃ¶nemi:</td>
                        <td style="width: 20%; border-bottom: 1px dotted #000;">${donem}</td> <td style="width: 8%; font-weight: bold; text-align: right;">Dersin AdÄ±:</td>
                        <td style="border-bottom: 1px dotted #000;">Ä°ÅLETMELERDE MESLEKÄ° EÄÄ°TÄ°M</td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold;">Ä°ÅŸletmenin AdÄ±</td>
                        <td>:</td>
                        <td colspan="3" style="border-bottom: 1px dotted #000;">${isletmeAdi}</td>
                        
                        <td colspan="2" style="text-align: right;">
                            <b>Telefonu:</b> <span style="display:inline-block; width:100px; border-bottom:1px dotted #000;">${isletmeTel}</span>
                            &nbsp;&nbsp;
                            <b>e-posta:</b> <span style="display:inline-block; width:120px; border-bottom:1px dotted #000;">${isletmeEmail}</span>
                        </td>
                    </tr>
                </table>
                
                <div style="height: 10px;"></div>

                <table class="excel-table">
                    <thead>
                        <tr style="background-color: #f2f2f2;">
                            <th colspan="4" style="height: 25px;">Ã–ÄŸrencinin</th>
                            <th colspan="4">Ä°ÅŸletmede Verilen Puanlar</th>
                            <th colspan="2">Okulda Ver. Puanlar</th>
                            <th colspan="1">DÃ¶nem BaÅŸarÄ±sÄ±</th>
                            <th colspan="2">DÃ¶nem Notu</th>
                        </tr>
                        <tr style="background-color: #f2f2f2;">
                            <th style="width: 4%;">SÄ±ra No</th>
                            <th style="width: 18%;">AdÄ± SoyadÄ±</th>
                            <th style="width: 12%;">Meslek Alan/DalÄ±</th>
                            <th style="width: 5%;">SÄ±nÄ±fÄ±</th>
                            
                            <th style="width: 6%;">Temrin</th>
                            <th style="width: 6%;">Ä°ÅŸ Hizmet</th>
                            <th style="width: 6%;">Proje</th>
                            <th style="width: 6%;">Deney</th>
                            
                            <th style="width: 7%;">Telafi EÄŸitimi<br>PuanÄ± (*)</th>
                            <th style="width: 7%;">Beceri YerleÅŸme<br>PuanÄ± (*)</th>
                            
                            <th style="width: 6%;">Ortalama</th>
                            
                            <th style="width: 8%;">Rakamla</th>
                            <th style="width: 9%;">YazÄ±yla</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // --- SABÄ°T 8 SATIR DÃ–NGÃœSÃœ ---
            // Excel formundaki boÅŸluk kadar (8 Ã¶ÄŸrenci)
            for (let i = 0; i < 8; i++) {
                html += `
                    <tr style="height: 40px;"> <td>${i+1}</td>
                        <td style="text-align: left;">&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        
                        <td style="background-color: #f9f9f9;">&nbsp;</td>
                        
                        <td style="font-weight: bold;">&nbsp;</td>
                        <td>&nbsp;</td>
                    </tr>
                `;
            }

            html += `
                    </tbody>
                </table>

                <table class="signature-table">
                    <tr>
                        <td width="20%"><b>${ustaOgreticiAd}</b></td>
                        <td width="20%"><b>${isletmeYetkilisiAd}</b></td>
                        <td width="20%"><b>${koordOgretmenAd}</b></td>
                        <td width="20%"><b>${mudurYrdAd}</b></td>
                        <td width="20%"><b>${okulMuduruAd}</b></td>
                    </tr>
                    <tr>
                        <td>Usta Ã–ÄŸretici /<br>EÄŸitici Personel</td>
                        <td>Ä°ÅŸletme Yetkilisi</td>
                        <td>KoordinatÃ¶r Ã–ÄŸretmen</td>
                        <td>KoordinatÃ¶r<br>MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±</td>
                        <td>Okul MÃ¼dÃ¼rÃ¼</td>
                    </tr>
                    <tr>
                        <td style="height: 40px; vertical-align: bottom;">Ä°mza</td>
                        <td style="height: 40px; vertical-align: bottom;">Ä°mza</td>
                        <td style="height: 40px; vertical-align: bottom;">Ä°mza</td>
                        <td style="height: 40px; vertical-align: bottom;">Ä°mza</td>
                        <td style="height: 40px; vertical-align: bottom;">Ä°mza</td>
                    </tr>
                </table>

                <div style="font-size: 8pt; margin-top: 10px; font-family: Calibri;">
                    <b>AÃ‡IKLAMA:</b><br>
                    1- Bu Ã§izelge; Orta Ã–ÄŸretim KurumlarÄ± YÃ¶netmeliÄŸi 144/g maddesine gÃ¶re Ä°ÅŸletme yetkilisi tarafÄ±ndan doldurulacak ve dÃ¶nem sona ermeden beÅŸ gÃ¼n Ã¶nce kapalÄ± zarf iÃ§inde okul / kurum mÃ¼dÃ¼rlÃ¼ÄŸÃ¼ne teslim edilecektir.<br>
                    2- (*) Ä°ÅŸaretli bÃ¶lÃ¼mler okul / kurum mÃ¼dÃ¼rlÃ¼ÄŸÃ¼nce doldurulacak ve puan ortalamasÄ± alÄ±narak dÃ¶nem notu belirlenecektir.
                </div>
            </div>
            `;

            return html;
        }

        function generateAttendanceSheet(businessId, month, year) {
            const business = appData.businesses.find(b => b.id === businessId);
            const lastDayOfMonth = new Date(year, month + 1, 0); 
            let studentRowsHTML = '';
            const studentList = business.students.filter(s => {
                const sStart = parseDateString(s.startDate); if(sStart) sStart.setHours(0,0,0,0);
                const sEnd = s.endDate ? parseDateString(s.endDate) : null; if(sEnd) sEnd.setHours(0,0,0,0);
                const monthStart = new Date(year, month, 1); monthStart.setHours(0,0,0,0);
                const monthEnd = new Date(year, month + 1, 0); monthEnd.setHours(0,0,0,0);
                return sStart && sStart <= monthEnd && (!sEnd || sEnd >= monthStart);
            });
            
            studentList.forEach(student => {
                let morningRowCells = ''; 
                let afternoonRowCells = ''; 
                let unexcusedTotal = 0; 
                const daysInMonth = lastDayOfMonth.getDate();
                for(let day = 1; day <= 31; day++) {
                    if(day > daysInMonth) { morningRowCells += `<td></td>`; afternoonRowCells += `<td></td>`; continue; }
                    const currentDate = new Date(year, month, day);
                    currentDate.setHours(0,0,0,0);
                    const dayOfWeek = currentDate.getDay();
                    let fullDayContent = null;
                    const sStart = parseDateString(student.startDate); if(sStart) sStart.setHours(0,0,0,0);
                    const sEnd = student.endDate ? parseDateString(student.endDate) : null; if(sEnd) sEnd.setHours(0,0,0,0);
                    let isOutOfRange = (sStart && currentDate < sStart) || (sEnd && currentDate > sEnd);
                    const activeSchoolDay = getSchoolDayForDate(student, currentDate);

                    if(isOutOfRange) { morningRowCells += `<td style="background-color:#eee;"></td>`; afternoonRowCells += `<td style="background-color:#eee;"></td>`; }
                    else if(isPublicHoliday(currentDate)) { fullDayContent = `<td rowspan="2" class="f-bold f-green">T</td>`; }
                    else if(dayOfWeek == activeSchoolDay && !isSchoolHoliday(currentDate)) { fullDayContent = `<td rowspan="2" class="f-bold f-blue">O</td>`; }
                    else if(dayOfWeek === 0) { fullDayContent = `<td rowspan="2" class="f-bold f-green">T</td>`; }
                    else { 
                        const monthYearKey = `${year}-${month}`;
                        const studentAbsences = student.absences?.[monthYearKey]?.[day] || [];
                        const s_absent = studentAbsences.includes('S'); 
                        const o_absent = studentAbsences.includes('Ã–');
                        if(s_absent) unexcusedTotal += 0.5; if(o_absent) unexcusedTotal += 0.5;
                        morningRowCells += `<td class="${s_absent ? 'f-teal f-bold': ''}">${s_absent ? 'S' : '+'}</td>`;
                        afternoonRowCells += `<td class="${o_absent ? 'f-teal f-bold': ''}">${o_absent ? 'Ã–' : '+'}</td>`;
                    }
                    if (fullDayContent) morningRowCells += fullDayContent;
                }
                const studentInfo = `<td class="student-info-cell" rowspan="2">${student.name}</td><td class="student-info-cell" rowspan="2">${student.no||''}</td><td class="student-info-cell" rowspan="2">${student.field||''}</td>`;
                const totals = `<td rowspan="2"></td><td rowspan="2">${unexcusedTotal > 0 ? unexcusedTotal : ''}</td>`;
                studentRowsHTML += `<tr>${studentInfo}<td class="f-bold">S</td>${morningRowCells}${totals}</tr><tr><td class="f-bold">Ã–</td>${afternoonRowCells}</tr>`;
            });
            
            const legendHTML = `<div class="legend-box"><strong>DevamsÄ±zlÄ±ÄŸÄ±n gÃ¶sterileceÄŸi semboller:</strong><br>(Ä°) Ä°zinli<br>(H) Hasta Sevkli<br>(R) Raporlu<br>(T) Resmi Tatil<br>(O) Okul GÃ¼nÃ¼<br>(S) Sabah DevamsÄ±z<br>(Ã–) Ã–ÄŸleden Sonra DevamsÄ±z</div>`;
            const explanationHTML = `<div class="explanation-section"><strong>Bu Ã§izelge, iÅŸletme tarafÄ±ndan tutulacak, Ã¶ÄŸrencinin iÅŸletmede bulunmasÄ± gereken gÃ¼nlere ait devamsÄ±zlÄ±k durumlarÄ± ilgili sÃ¼tunda, yanda gÃ¶sterilen uygun sembolle belirlenecektir.</strong></div>`;
            const mainTitle = `<div class="print-main-title">Ä°ÅŸletmelerde Meslek EÄŸitimi GÃ¶ren Ã–ÄŸrencilerin AylÄ±k Devam - DevamsÄ±zlÄ±k Bildirim Ã‡izelgesi</div>`;
            const headerTable = `<table class="print-header-table"><tr><td style="width: 25%;" rowspan="2"><strong>Okul/Kurumun AdÄ±:</strong><br><span class="dynamic-text">${appData.settings.schoolName || ''}</span></td><td style="width: 50%;"><strong>Ä°ÅŸletmenin:</strong> AdÄ±: <span class="dynamic-text">${business.name || ''}</span></td><td style="width: 25%;"><strong>Ait OlduÄŸu Ay:</strong> <span class="dynamic-text">${monthNames[month]} ${year}</span></td></tr><tr><td>Telefonu ve faksÄ±: <span class="dynamic-text">${business.phone || ''}</span></td><td><strong>Belgenin DÃ¼zenlendiÄŸi Tarih:</strong> <span class="dynamic-text">${lastDayOfMonth.toLocaleDateString('tr-TR')}</span></td></tr></table>`;
            const mainTable = `<table class="print-main-table"><thead><tr><th colspan="3" rowspan="2">Ã–ÄRENCÄ°NÄ°N</th><th rowspan="3" class="header-cell-days">GÃœNLER</th><th colspan="31"></th><th colspan="2" rowspan="2">TOPLAM<br>DEVAMSIZLIK</th></tr><tr>${Array.from({length: 31}, (_, i) => `<th class="day-cell">${i+1}</th>`).join('')}</tr><tr><th class="header-cell-name">AdÄ± SoyadÄ±</th><th class="header-cell-no">No</th><th class="header-cell-field">Alan/DalÄ±</th><th colspan="31" style="border-top: 1px solid #000;"></th><th class="header-cell-total">Ã–zÃ¼rlÃ¼</th><th class="header-cell-total">Ã–zÃ¼rsÃ¼z</th></tr></thead><tbody>${studentRowsHTML}</tbody></table>`;
            const printFooter = `<div class="print-footer"><div class="signature-section"><strong>Ä°ÅŸletme Yetkilisi</strong><br><span class="dynamic-text">${business.official || ''}</span><br><br>KaÅŸe - Ä°mza</div><div class="signature-section"><strong>KoordinatÃ¶r Ã–ÄŸretmen</strong><br><span class="dynamic-text">${appData.settings.coordinatorName || ''}</span><br><span class="dynamic-text">${lastDayOfMonth.toLocaleDateString('tr-TR')}</span><br>Ä°mza</div><div class="signature-section"><strong>KoordinatÃ¶r MÃ¼dÃ¼r Yrd.</strong><br><span class="dynamic-text">${appData.settings.asstPrincipalName || ''}</span><br><span class="dynamic-text">${lastDayOfMonth.toLocaleDateString('tr-TR')}</span><br>Ä°mza</div>${explanationHTML}<div class="legend-section">${legendHTML}</div></div>`;
            return `<div class="sheet-content">${mainTitle}${headerTable}<div class="print-main-table-wrapper">${mainTable}</div>${printFooter}</div>`;
        }


        function generateGradeSheetForm(student, business, period, year) {
            const settings = appData.settings;
            const schoolName = settings.schoolName || 'UÅAK MESLEKÄ° VE TEKNÄ°K ANADOLU LÄ°SESÄ°';
            const fixedYear = "2025 - 2026"; 
            const periodText = period === "1" ? "1. DÃ¶nem" : "2. DÃ¶nem";
            const fullClass = `${student.class || ''}/${student.branch || ''}`;
            const ustaOgreticiName = business.official || '';
            const emptyRowsCount = 4;

            return `
            <div class="grade-sheet-page">
                <div class="gs-doc-code">IME-DNOT</div>

                <div class="gs-border-container">
                    
                    <div class="gs-header-section">
                        <div class="gs-main-title">Ä°ÅLETMELERDE MESLEKÄ° EÄÄ°TÄ°M GÃ–REN Ã–ÄRENCÄ°LERE AÄ°T DÃ–NEM NOT FÄ°ÅÄ°</div>
                    </div>

                    <table class="info-table">
                        <tr>
                            <td class="label-cell">Okul/Kurumun AdÄ±</td>
                            <td class="label-cell">:</td>
                            <td colspan="7" class="value-cell">${schoolName}</td>
                        </tr>
                        <tr>
                            <td class="label-cell">Ã–ÄŸretim YÄ±lÄ±</td>
                            <td class="label-cell">:</td>
                            <td class="value-cell" style="width: 15%;">${fixedYear}</td>
                            
                            <td class="label-cell" style="padding-left:20px;">DÃ¶nemi</td>
                            <td class="label-cell">:</td>
                            <td class="value-cell" style="width: 15%;">${periodText}</td>
                            
                            <td class="label-cell" style="padding-left:20px;">Dersin AdÄ±</td>
                            <td class="label-cell">:</td>
                            <td class="value-cell">Ä°ÅLETMELERDE MESLEKÄ° EÄÄ°TÄ°M</td>
                        </tr>
                        <tr>
                            <td class="label-cell">Ä°ÅŸletmenin AdÄ±</td>
                            <td class="label-cell">:</td>
                            <td colspan="4" class="value-cell">${business.name}</td>
                            
                            <td class="label-cell" style="padding-left:20px;">Telefonu / E-posta</td>
                            <td class="label-cell">:</td>
                            <td class="value-cell">${business.phone || ''}</td>
                        </tr>
                    </table>

                    <table class="modern-table">
                        <colgroup>
                            <col class="col-no">
                            <col class="col-name">
                            <col class="col-field">
                            <col class="col-class">
                            
                            <col class="col-grade-sub"><col class="col-grade-sub"><col class="col-grade-sub">
                            <col class="col-grade-sub"><col class="col-grade-sub"><col class="col-grade-sub">
                            <col class="col-grade-sub"><col class="col-grade-sub"><col class="col-grade-sub">
                            <col class="col-grade-sub"><col class="col-grade-sub"><col class="col-grade-sub">
                            
                            <col class="col-telafi"><col class="col-telafi">
                            <col class="col-beceri">
                            <col class="col-ort">
                            <col class="col-not-rakam"><col class="col-not-yazi">
                        </colgroup>
                        <thead>
                            <tr>
                                <th colspan="4" style="border-bottom: 2px solid #000;">Ã–ÄRENCÄ°NÄ°N</th>
                                <th colspan="12" style="border-bottom: 2px solid #000;">Ä°ÅLETMEDE VERÄ°LEN PUANLAR</th>
                                <th colspan="3" style="border-bottom: 2px solid #000;">OKULDA VER. PUANLAR</th>
                                <th colspan="3" style="border-bottom: 2px solid #000;">DÃ–NEM BAÅARISI</th>
                            </tr>
                            <tr>
                                <th rowspan="2" class="vertical-cell"><span class="vertical-text">NumarasÄ±</span></th>
                                <th rowspan="2">AdÄ± SoyadÄ±</th>
                                <th rowspan="2">Meslek<br>Alan/DalÄ±</th>
                                <th rowspan="2">SÄ±nÄ±fÄ±</th>
                                
                                <th colspan="3">Temrin</th>
                                <th colspan="3">Ä°ÅŸ Hizmet</th>
                                <th colspan="3">Proje</th>
                                <th colspan="3">Deney</th>
                                
                                <th colspan="2" rowspan="2" class="vertical-cell"><span class="vertical-text">Telafi EÄŸitimi<br>PuanÄ± (*)</span></th>
                                <th rowspan="2" class="vertical-cell"><span class="vertical-text">Beceri YrÅŸ.<br>PuanÄ±</span></th>
                                <th rowspan="2" class="vertical-cell"><span class="vertical-text">Ortalama</span></th>
                                <th colspan="2" style="height: 20px;">DÃ¶nem Notu</th>
                            </tr>
                            <tr>
                                <th style="height: 30px;" colspan="3"></th>
                                <th colspan="3"></th>
                                <th colspan="3"></th>
                                <th colspan="3"></th>
                                
                                <th>Rakamla</th>
                                <th>YazÄ±yla</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="data-row">
                                <td class="student-data-cell" style="border: 1px solid #000 !important; border-bottom: 1px solid #000 !important;">${student.no || ''}</td>
                                <td class="student-data-cell" style="border: 1px solid #000 !important; border-bottom: 1px solid #000 !important;">${student.name}</td>
                                <td class="student-data-cell" style="border: 1px solid #000 !important; border-bottom: 1px solid #000 !important;">${student.field || ''}</td>
                                <td class="student-data-cell" style="border: 1px solid #000 !important; border-bottom: 1px solid #000 !important;">${fullClass}</td>
                                
                                <td></td><td></td><td></td>
                                <td></td><td></td><td></td>
                                <td></td><td></td><td></td>
                                <td></td><td></td><td></td>
                                
                                <td></td><td></td>
                                <td></td>
                                
                                <td></td>
                                <td></td><td></td>
                            </tr>
                            ${Array(emptyRowsCount).fill('').map(() => `
                            <tr class="data-row">
                                <td></td><td></td><td></td><td></td>
                                
                                <td></td><td></td><td></td>
                                <td></td><td></td><td></td>
                                <td></td><td></td><td></td>
                                <td></td><td></td><td></td>
                                
                                <td></td><td></td>
                                <td></td>
                                <td></td>
                                <td></td><td></td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                    
                    <div class="signature-section">
                        <div class="sig-box">
                            <div class="sig-name">${ustaOgreticiName}</div>
                            <div class="sig-title">Usta Ã–ÄŸretici /<br>EÄŸitici Personel</div>
                            <div class="sig-place">Ä°mza</div>
                        </div>
                        <div class="sig-box">
                            <div class="sig-name">${business.official || ''}</div>
                            <div class="sig-title">Ä°ÅŸletme Yetkilisi</div>
                            <div class="sig-place">Ä°mza</div>
                        </div>
                        <div class="sig-box">
                            <div class="sig-name">${settings.coordinatorName || ''}</div>
                            <div class="sig-title">KoordinatÃ¶r Ã–ÄŸretmen</div>
                            <div class="sig-place">Ä°mza</div>
                        </div>
                        <div class="sig-box">
                            <div class="sig-name">${settings.asstPrincipalName || ''}</div>
                            <div class="sig-title">KoordinatÃ¶r<br>MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±</div>
                            <div class="sig-place">Ä°mza</div>
                        </div>
                        <div class="sig-box">
                            <div class="sig-name">${settings.principalName || ''}</div>
                            <div class="sig-title">Okul MÃ¼dÃ¼rÃ¼</div>
                            <div class="sig-place">Ä°mza</div>
                        </div>
                    </div>

                    <div class="footer-notes">
                        <strong>AÃ‡IKLAMA:</strong><br>
                        1- Bu Ã§izelge; Orta Ã–ÄŸretim KurumlarÄ± YÃ¶netmeliÄŸi 144/g maddesine gÃ¶re Ä°ÅŸletme yetkilisi tarafÄ±ndan doldurulacak ve dÃ¶nem sona ermeden beÅŸ gÃ¼n Ã¶nce kapalÄ± zarf iÃ§inde okul / kurum mÃ¼dÃ¼rlÃ¼ÄŸÃ¼ne teslim edilecektir.<br>
                        2- (*) Ä°ÅŸaretli bÃ¶lÃ¼mler okul / kurum mÃ¼dÃ¼rlÃ¼ÄŸÃ¼nce doldurulacak ve puan ortalamasÄ± alÄ±narak dÃ¶nem notu belirlenecektir.
                    </div>

                </div>
            </div>
            `;
        }

        function handleGenerateGradeSheet() {
            const periodSelect = document.getElementById('gradeSheetPeriod');
            const period = periodSelect.value; // 1 veya 2 deÄŸeri gelir
            const year = document.getElementById('gradeSheetYear').value;
            
            if (!year) {
                showNotification('LÃ¼tfen Ã¶ÄŸretim yÄ±lÄ±nÄ± girin.', 'error');
                return;
            }
            
            // SeÃ§ili iÅŸletmeleri al
            const selectedCheckboxes = document.querySelectorAll('.grade-sheet-business-checkbox:checked');
            const selectedBusinessIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            
            if (selectedBusinessIds.length === 0) {
                showNotification('LÃ¼tfen en az bir iÅŸletme seÃ§in.', 'error');
                return;
            }
            
            let allFormsHTML = '';
            
            selectedBusinessIds.forEach(businessId => {
                const business = appData.businesses.find(b => b.id === businessId);
                if (!business || !business.students) return;
                
                // Fesih edilmemiÅŸ (aktif) Ã¶ÄŸrencileri filtrele
                const activeStudents = business.students.filter(s => !s.endDate);
                
                if (activeStudents.length === 0) return; // Ã–ÄŸrenci yoksa atla

                // HER Ã–ÄRENCÄ° Ä°Ã‡Ä°N AYRI SAYFA OLUÅTUR
                activeStudents.forEach(student => {
                    allFormsHTML += generateGradeSheetForm(student, business, period, year);
                });
            });
            
            if (!allFormsHTML) {
                showNotification('SeÃ§ili iÅŸletmelerde aktif Ã¶ÄŸrenci bulunamadÄ±.', 'error');
                return;
            }
            
            const printContainer = document.getElementById('print-container');
            printContainer.innerHTML = allFormsHTML;
            window.print();
        }

       function populateGradeSheetBusinessSelect() {
            const dropdownList = document.getElementById('grade-sheet-business-dropdown-list');
            if (!dropdownList) return;
            dropdownList.innerHTML = '';
            appData.businesses.forEach(business => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                // CHECKED Ä°FADESÄ° YOK:
                div.innerHTML = `
                    <input type="checkbox" class="grade-sheet-business-checkbox" value="${business.id}" id="grade-business-${business.id}">
                    <label for="grade-business-${business.id}">${business.name}</label>
                `;
                dropdownList.appendChild(div);
            });
            updateGradeSheetDropdownText();
        }

        
        function updateGradeSheetDropdownText() {
            const checkboxes = document.querySelectorAll('.grade-sheet-business-checkbox');
            const checkedBoxes = document.querySelectorAll('.grade-sheet-business-checkbox:checked');
            const textElement = document.getElementById('grade-sheet-business-selected-text');
            
            if (!textElement) return;
            
            if (checkedBoxes.length === 0) {
                textElement.textContent = 'Ä°ÅŸletme seÃ§in...';
            } else if (checkedBoxes.length === checkboxes.length) {
                textElement.textContent = 'TÃ¼m iÅŸletmeler seÃ§ili';
            } else if (checkedBoxes.length === 1) {
                textElement.textContent = checkedBoxes[0].nextElementSibling.textContent;
            } else {
                textElement.textContent = `${checkedBoxes.length} iÅŸletme seÃ§ili`;
            }
        }
        function generateMonthlyGuidanceForm(company, month, year) {
            function calculateActiveVisitDates(company, year, month) {
                const targetDay = parseInt(company.visitDay);
                if (isNaN(targetDay)) return [];
                const potentialDates = [];
                const date = new Date(year, month, 1);
                while (date.getMonth() === month) {
                    if (date.getDay() === targetDay) {
                        const checkDate = new Date(date);
                        checkDate.setHours(0,0,0,0);
                        const hasActiveStudent = company.students.some(s => {
                            const sStart = parseDateString(s.startDate); if(sStart) sStart.setHours(0,0,0,0);
                            const sEnd = s.endDate ? parseDateString(s.endDate) : null; if(sEnd) sEnd.setHours(0,0,0,0);
                            return sStart && sStart <= checkDate && (!sEnd || sEnd >= checkDate);
                        });
                        if (hasActiveStudent) potentialDates.push(new Date(checkDate));
                    }
                    date.setDate(date.getDate() + 1);
                }
                return potentialDates;
            }
            const activeDates = calculateActiveVisitDates(company, year, month);
            if (activeDates.length === 0) return null; 
            const visitDatesText = activeDates.map(date => `${date.toLocaleDateString('tr-TR')} - ${date.toLocaleDateString('tr-TR', { weekday: 'long' })}`).join('<br>');
            function getFormQuestionsHTML() { const questions = [ { s: 'A', q: '1. Usta Ã¶ÄŸretici/eÄŸitici personelin yÄ±llÄ±k eÄŸitim planÄ± var mÄ±? Uyguluyor mu? Ã–ÄŸrencilere sÃ¼rekli aynÄ± iÅŸlem mi, rotasyona gÃ¶re mi eÄŸitim yaptÄ±rÄ±lÄ±yor?', a: 'Var, uyguluyor, rotasyona gÃ¶re eÄŸitim' }, { s: 'A', q: '2. Ã–ÄŸrencilerin gÃ¼nlÃ¼k Ã§alÄ±ÅŸmalarÄ± yÄ±llÄ±k eÄŸitim planÄ±na uygun olarak plÃ¢nlanmÄ±ÅŸ mÄ±?', a: 'Evet' }, { s: 'A', q: '3. Ã–ÄŸrenci devam durumu gÃ¼nlÃ¼k olarak takip ediliyor mu?', a: 'Evet' }, { s: 'A', q: '4. Meslek eÄŸitimi Ã§alÄ±ÅŸmalarÄ± puanla deÄŸerlendiriliyor mu?', a: 'Evet' }, { s: 'A', q: '5. YapÄ±lan iÅŸlerle ilgili olarak her Ã¶ÄŸrenciye iÅŸ dosyasÄ± tutturuluyor mu?', a: 'Evet' }, { s: 'A', q: '6. Ã–ÄŸrencilere 3308 sayÄ±lÄ± Kanunun 25 inci maddesine gÃ¶re aylÄ±k Ã¼cret Ã¶deniyor mu?', a: 'Evet' }, { s: 'A', q: '7. Meslek eÄŸitimi, Ã§alÄ±ÅŸma saatlerinde yapÄ±lÄ±yor mu?', a: 'Evet' }, { s: 'A', q: '8. Ä°ÅŸ gÃ¼venliÄŸi konusunda Ã¶ÄŸrencilere yeterli bilgi veriliyor ve gerekli tedbirler alÄ±nÄ±yor mu?', a: 'Evet' }, { s: 'A', q: '9. Ã–ÄŸrenciler disiplin, kÄ±lÄ±k-kÄ±yafet ve iÅŸletmenin kurallarÄ±na uyuyor mu?', a: 'Evet' }, { s: 'A', q: '10. Ã–ÄŸrencilerin telafi eÄŸitimine alÄ±nmasÄ± gerekiyor mu? Gerekiyorsa hangi konularda telafi eÄŸitimi uygulanmalÄ±?', a: 'HayÄ±r' }, { s: 'B', q: '1. Ä°ÅŸletmenin meslek eÄŸitimi ile gÃ¶revli personelinin usta Ã¶ÄŸreticilik belgesi var mÄ±?', a: 'Evet' }, { s: 'B', q: '2. EÄŸitici personelin sorumlu olduÄŸu Ã¶ÄŸrenci grubu sayÄ±sÄ± Mesleki ve Teknik EÄŸitim YÃ¶netmeliÄŸinin 192 nci maddesine uygun mu?', a: 'Evet' }, { s: 'B', q: '3. Meslek eÄŸitimi konusunda koordinatÃ¶r tarafÄ±ndan eÄŸitici personele yapÄ±lan rehberlik ve konusu.', a: 'GeliÅŸim tablolarÄ±nÄ±n kontrol edilmesi, Ã¶ÄŸrencilere ve eÄŸiticilere gÃ¼venli iÅŸ ortamÄ±nÄ±n geliÅŸtirilmesi.', tall: true }, { s: 'B', q: '4. EÄŸitici personelin geliÅŸtirme ve uyum kursuna ihtiyacÄ± var mÄ±?', a: 'HayÄ±r' }, { s: 'C', q: '1. Ä°ÅŸletmelerde meslek eÄŸitimi, yÄ±llÄ±k Ã§alÄ±ÅŸma takvimine uygun olarak sÃ¼rdÃ¼rÃ¼lÃ¼yor mu?', a: 'Evet' }, { s: 'C', q: '2. Ä°ÅŸletmede meslek eÄŸitiminin mevzuata gÃ¶re sÃ¼rdÃ¼rÃ¼lmesi ile ilgili gerekli tedbirler alÄ±nÄ±yor mu? (Mesleki ve Teknik EÄŸitim YÃ¶netmeliÄŸi madde 196.)', a: 'Evet' }, { s: 'C', q: '4. Ã–ÄŸrenciler iÃ§in geliÅŸim tablosu uygulanÄ±yor mu?', a: 'Evet' }, { s: 'C', q: '5. Ä°ÅŸletme yetkililerinin meslek eÄŸitiminin uygulanÄ±ÅŸÄ± ve Ã¶ÄŸretim programlarÄ± konusundaki gÃ¶rÃ¼ÅŸ ve Ã¶nerileri', a: '', tall: true }, { s: 'D', q: 'AÃ§Ä±klanmasÄ± gereken diÄŸer hususlar:', a: '', tall: true }, ];
            let currentSection = ''; const rows = questions.map(item => { let sectionHeader = ''; if (item.s !== currentSection) { currentSection = item.s; const sectionNames = {A: 'A. Mesleki ve Teknik EÄŸitim YÃ¶netmeliÄŸi ile ilgili konular:', B: 'B. EÄŸitici Personelle ilgili konular:', C: 'C. Ä°ÅŸletme ile ilgili konular', D: 'D. AÃ§Ä±klanmasÄ± gereken diÄŸer hususlar:'}; sectionHeader = `<tr style="background:#f0f0f0 !important;"><td colspan="2" style="border:1px solid #000; padding:1px; font-weight:bold; text-align:center; font-size:5.5pt;">${sectionNames[item.s]}</td></tr>`; } const tallClass = item.tall ? 'expandable-area' : ''; const answerCell = `<textarea class="editable-textarea ${tallClass}">${item.a}</textarea>`; return `${sectionHeader}<tr><td style="border:1px solid #000; padding:1px; font-size:6pt; font-weight:bold; line-height:1.1;">${item.q}</td><td style="border:1px solid #000; padding:1px; vertical-align:middle; font-size:5.5pt;">${answerCell}</td></tr>`; }).join('');
            return `<table style="width:100%; border-collapse:collapse;"><thead><tr style="background:#f0f0f0 !important;"><th style="border:1px solid #000; padding:1px; width:60%; font-size:6pt;">KoordinatÃ¶rÃ¼n Rehberlik Ziyaret KonularÄ±</th><th style="border:1px solid #000; padding:1px; width:40%; font-size:6pt;">DeÄŸerlendirme ve Ã–neriler</th></tr></thead><tbody>${rows}</tbody></table>`;
            }
            const uniqueStudentFields = [...new Set(company.students.filter(s => {
                const sStart = parseDateString(s.startDate); if(sStart) sStart.setHours(0,0,0,0);
                const sEnd = s.endDate ? parseDateString(s.endDate) : null; if(sEnd) sEnd.setHours(0,0,0,0);
                const monthEnd = new Date(year, month + 1, 0); monthEnd.setHours(0,0,0,0);
                const monthStart = new Date(year, month, 1); monthStart.setHours(0,0,0,0);
                return sStart && sStart <= monthEnd && (!sEnd || sEnd >= monthStart);
            }).map(s => s.field).filter(Boolean))].join(', ');
            return `<div style="text-align: center; font-weight: bold; font-size: 7.5pt; line-height:1.1;">Ä°ÅLETMELERDE MESLEK EÄÄ°TÄ°MÄ° KOORDÄ°NATÃ–RLERÄ°NÄ°N Ä°ÅLETMEYE YAPACAÄI AYLIK REHBERLÄ°K RAPOR FORMU</div><div style="text-align: center; font-weight: bold; font-size: 7.5pt; margin-top: 2px;">UÅAK MESLEKÄ° VE TEKNÄ°K ANADOLU LÄ°SESÄ° MÃœDÃœRLÃœÄÃœ'NE</div><div style="text-align: center; font-weight: bold; font-size: 7.5pt;">UÅAK</div><p style="font-size: 7pt; line-height: 1.1; margin: 2px 0; text-indent:10px;">Okul/Kurumumuz <b><i>${uniqueStudentFields || '................................'}</i></b> alan/dalÄ± Ã¶ÄŸrencilerinin meslek eÄŸitimi gÃ¶rdÃ¼ÄŸÃ¼ iÅŸletmede yapmÄ±ÅŸ olduÄŸum bir aylÄ±k koordinatÃ¶rlÃ¼k gÃ¶revlerim sÄ±rasÄ±nda tespit ettiÄŸim hususlar aÅŸaÄŸÄ±da belirtilmiÅŸtir.<br>Bilgilerinizi ve gereÄŸini arz ederim.</p><table style="width:100%; border-collapse:collapse; font-size:7pt; margin: 2px 0;"><tr><td style="border:1px solid #000; padding:1px; width:50%; vertical-align:top;"><b>Ä°ÅŸletmenin AdÄ± ve Adresi:</b><br><span class="dynamic-text">${company.name}, ${company.address}</span></td><td style="border:1px solid #000; padding:1px; width:50%; vertical-align:top;"><b>GÃ–REV TARÄ°HLERÄ°:</b><br><span class="dynamic-text">${visitDatesText}</span></td></tr><tr><td style="border:1px solid #000; padding:1px; line-height:1.1;"><b>Ä°ÅŸletme EÄŸitim Yetkilisinin</b><br>AdÄ± SoyadÄ±: <span class="dynamic-text">${company.official}</span><br><br>Ä°mza:</td><td style="border:1px solid #000; padding:1px; line-height:1.1;"><b>KoordinatÃ¶r Ã–ÄŸretmenin</b><br>AdÄ± SoyadÄ±: <span class="dynamic-text">${appData.settings.coordinatorName}</span><br><br>Ä°mza:</td></tr></table><div class="form-content-wrapper">${getFormQuestionsHTML()}</div><div style="text-align: center; margin-top: auto; font-size: 6pt; border-top: 1px solid #000; padding-top: 1px;"><strong>AÃ‡IKLAMA:</strong> Bu form her iÅŸletme iÃ§in her ay ayrÄ± ayrÄ± doldurulacak, kurum idaresine verilecektir. FORM A</div>`;
        }
        
        function generateDailyGuidanceForm(business, visitDate) {
            if (!business || !visitDate) return `<div class="daily-guidance-form"></div>`;
            const checkDate = new Date(visitDate); checkDate.setHours(0, 0, 0, 0);
            let activeStudents = [];
            if (business.students && business.students.length > 0) {
                for (const student of business.students) {
                    const startDate = parseDateString(student.startDate);
                    const endDate = student.endDate ? parseDateString(student.endDate) : null;
                    if (startDate) startDate.setHours(0, 0, 0, 0);
                    if (endDate) endDate.setHours(0, 0, 0, 0);
                    if (startDate && startDate <= checkDate && (!endDate || endDate >= checkDate)) {
                        activeStudents.push(student);
                    }
                }
            }
            if (activeStudents.length === 0) return null;
            const activeStudentCount = activeStudents.length;
            const uniqueStudentFields = [...new Set(activeStudents.map(s => s.field).filter(Boolean))].join(', ');
            return `<div class="daily-guidance-form"><h3>Ä°ÅLETMELERDE MESLEK EÄÄ°TÄ°MÄ°<br>GÃœNLÄ°K REHBERLÄ°K GÃ–REV FORMU</h3><table class="main-table"><tbody><tr><td class="label-cell">Ä°ÅŸletmenin AdÄ±</td><td class="data-cell"><span class="dynamic-text">${business.name}</span></td></tr><tr><td class="label-cell">Ä°zlemeden Sorumlu olduÄŸu Ã–ÄŸrenci SayÄ±sÄ±</td><td class="data-cell"><span class="dynamic-text">${activeStudentCount}</span></td></tr><tr><td class="label-cell">Meslek Alan/DalÄ±</td><td class="data-cell"><span class="dynamic-text">${uniqueStudentFields}</span></td></tr><tr><td class="label-cell">GÃ¶rev Tarihi</td><td class="data-cell"><span class="dynamic-text">${visitDate.toLocaleDateString('tr-TR')}</span></td></tr><tr><td colspan="2" class="section-cell"><p>1- Ä°ÅŸletmede Ã¶ÄŸrenim gÃ¶ren Ã¶ÄŸrencilerin eÄŸitimini olumsuz yÃ¶nde etkileyen hususlar. (varsa yazÄ±nÄ±z.)</p><textarea class="editable-textarea"></textarea></td></tr><tr><td colspan="2" class="section-cell"><p>2- Belirlenen aksaklÄ±klarla ilgili yapÄ±lan rehberlik ve alÄ±nan Ã¶nlemler:</p><textarea class="editable-textarea"></textarea></td></tr><tr><td colspan="2" class="section-cell"><p>3- AylÄ±k Rehberlik formunda belirtilmesinde yarar gÃ¶rÃ¼len hususlar:</p><textarea class="editable-textarea"></textarea></td></tr><tr><td colspan="2" class="signature-cell"><div class="footer"><div><span class="dynamic-text">${business.official}</span><br>Ä°ÅŸletme EÄŸitim Yetkilisi<br><br>Ä°mza</div><div><span class="dynamic-text">${appData.settings.coordinatorName}</span><br>Koor. Ã–ÄŸretmen<br><br>Ä°mza</div><div><span class="dynamic-text">${appData.settings.asstPrincipalName}</span><br>Koor. Md. Yrd.<br><br>Ä°mza</div></div></td></tr><tr><td colspan="2" class="notes-cell"><div class="notes">AÃ§Ä±klamalar: Bu form koordinatÃ¶r Ã¶ÄŸretmen tarafÄ±ndan her gÃ¶rev iÃ§in gÃ¶rev haftasÄ± baÅŸÄ±nda koordinatÃ¶r Md. Yrd.'ndan alÄ±nÄ±r. GÃ¶rev sonrasÄ±nda okula geldiÄŸi gÃ¼n iÃ§inde imzalarÄ± tamamlanmÄ±ÅŸ olarak KoordinatÃ¶r Md. Yrd.'na teslim edilir.<br><b>Not: HaftalÄ±k devamsÄ±zlÄ±klarÄ± 3 nolu alanda belirtiniz. (No, isim, tarih)</b></div></td></tr></tbody></table></div>`;
        }

       function generateTerminationForm(e) {
            e.preventDefault();
            const studentId = dom.terminationForm.querySelector('#terminationStudentId').value;
            const businessId = dom.terminationForm.querySelector('#terminationBusinessId').value; 
            const terminationDate = dom.terminationForm.querySelector('#terminationDate').value; 
            const terminationReason = dom.terminationForm.querySelector('#terminationReason').value;
            const business = appData.businesses.find(b => b.id === businessId);
            const student = business.students.find(s => s.id === studentId);
            student.endDate = terminationDate;
            student.terminationReason = terminationReason;
            saveData();
            renderAll();
            closeModal('terminationModal');
            const formattedStartDate = student.startDate ? parseDateString(student.startDate).toLocaleDateString('tr-TR') : '';
            const formattedTerminationDate = parseDateString(terminationDate).toLocaleDateString('tr-TR');
            const formHTML = `<div class="print-page-container print-page-termination"><div class="termination-container" style="padding-bottom: 25px;"><h1 style="font-size: 14pt;">${appData.settings.schoolName}</h1><h2 style="font-size: 14pt; margin: 15px 0;">Ä°ÅLETMELERDE BECERÄ° EÄÄ°TÄ°MÄ° GÃ–REN Ã–ÄRENCÄ°LERE AÄ°T<br>SÃ–ZLEÅME FESÄ°H TUTANAÄI</h2><table><tr><td class="label-col">Ä°ÅLETMENÄ°N ADI</td><td class="separator-col">:</td><td class="value-col"><strong><em>${business.name}</em></strong></td></tr><tr><td class="label-col">Ã–ÄRENCÄ°NÄ°N ADI SOYADI</td><td class="separator-col">:</td><td class="value-col"><strong><em>${student.name}</em></strong></td></tr><tr><td class="label-col">ALANI</td><td class="separator-col">:</td><td class="value-col"><strong><em>${student.field}</em></strong></td></tr><tr><td class="label-col">SINIFI / ÅUBE / NUMARASI</td><td class="separator-col">:</td><td class="value-col"><strong><em>${student.class ? student.class + '. SÄ±nÄ±f' : ''}${student.branch ? ' / ' + student.branch + ' Åubesi' : ''}${student.no ? ' / ' + student.no : ''}</em></strong></td></tr><tr><td class="label-col">SÃ–ZLEÅMELÄ° TARÄ°HÄ°</td><td class="separator-col">:</td><td class="value-col"><strong><em>${formattedStartDate}</em></strong></td></tr><tr><td class="label-col">SÃ–ZLEÅMENÄ°N FESÄ°H TARÄ°HÄ°</td><td class="separator-col">:</td><td class="value-col"><strong><em>${formattedTerminationDate}</em></strong></td></tr></table><div class="reasons"><div class="label-col" style="border-bottom: 1px solid black; padding-bottom: 2px; margin-bottom: 5px;">FESÄ°H NEDENLERÄ°:</div><div class="value-box" style="border: 1px solid transparent; padding: 5px;"><strong><em>${terminationReason.replace(/\n/g, '<br>')}</em></strong></div></div><div class="signatures" style="display: flex; flex-wrap: wrap; justify-content: space-between; text-align: center; width: 100%; margin-top: auto; padding-top: 40px;"><div style="width: 32%; height: 1px;"></div><div style="width: 32%; height: 1px;"></div><div style="width: 32%; margin-bottom: 20px;">..... / ..... / 2025</div><div style="width: 32%;"><strong><em>${business.official}</em></strong><br>Ä°ÅŸletme Yetkilisi</div><div style="width: 32%;"><strong><em>${appData.settings.coordinatorName}</em></strong><br>KoordinatÃ¶r Ã–ÄŸretmen</div><div style="width: 32%;"><strong><em>${appData.settings.principalName}</em></strong><br>Okul MÃ¼dÃ¼rÃ¼</div></div></div></div>`;
            dom.printContainer.innerHTML = formHTML; 
            window.print();
            showNotification('SÃ¶zleÅŸme feshi gerÃ§ekleÅŸtirildi.', 'success');
        }

        // --- Event Listeners ---
        dom.generateSheetBtn.addEventListener('click', () => {
            const formType = dom.formTypeSelect.value;
            let allFormsHTML = '';
            if (formType === 'attendance' || formType === 'monthly_guidance') {
                const checkedBoxes = document.querySelectorAll('#business-dropdown-content .business-checkbox:checked');
                if (checkedBoxes.length === 0) { showNotification('LÃ¼tfen en az bir iÅŸletme seÃ§in.', 'error'); return; }
                const selectedBusinessIds = Array.from(checkedBoxes).map(cb => cb.value);
                const month = parseInt(dom.genMonthSelect.value);
                const year = parseInt(dom.genYearSelect.value);
                const today = new Date();
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth();
                if (year > currentYear || (year === currentYear && month > currentMonth)) { showNotification('HenÃ¼z gelmemiÅŸ bir tarih iÃ§in form oluÅŸturulamaz.', 'error'); return; }

                if(formType === 'attendance'){
                    let businessChunks = [];
                    for (let i = 0; i < selectedBusinessIds.length; ) {
                        const business = appData.businesses.find(b => b.id === selectedBusinessIds[i]);
                        const hasActiveStudent = business.students.some(s => {
                             const sStart = parseDateString(s.startDate); if(sStart) sStart.setHours(0,0,0,0);
                             const monthEnd = new Date(year, month + 1, 0); monthEnd.setHours(0,0,0,0);
                             return sStart && sStart <= monthEnd;
                        });
                        if (!hasActiveStudent) { i++; continue; } 
                        const studentCount = business.students.filter(s => !s.endDate || parseDateString(s.endDate) > new Date(year, month, 1)).length;
                        if (studentCount <= 8) {
                            const nextBusiness = i + 1 < selectedBusinessIds.length ? appData.businesses.find(b => b.id === selectedBusinessIds[i + 1]) : null;
                            if(nextBusiness) { businessChunks.push([selectedBusinessIds[i], selectedBusinessIds[i+1]]); i += 2; }
                            else { businessChunks.push([selectedBusinessIds[i]]); i++; }
                        } else { businessChunks.push([selectedBusinessIds[i]]); i++; }
                    }
                    businessChunks.forEach(chunk => {
                        if(chunk.length === 2) {
                            const formHTML1 = generateAttendanceSheet(chunk[0], month, year); 
                            const formHTML2 = generateAttendanceSheet(chunk[1], month, year);
                            allFormsHTML += `<div class="print-page-container print-page-attendance"><div class="print-sheet-wrapper"><div class="print-sheet first-half">${formHTML1}</div><div class="print-sheet second-half">${formHTML2}</div></div></div>`;
                        } else {
                            const formHTML = generateAttendanceSheet(chunk[0], month, year);
                            allFormsHTML += `<div class="print-page-container print-page-attendance"><div class="print-sheet-wrapper"><div class="print-sheet first-half">${formHTML}</div><div class="print-sheet second-half"></div></div></div>`;
                        }
                    });
                } else {
                    const validMonthlyForms = [];
                    for (const businessId of selectedBusinessIds) {
                        const company = appData.businesses.find(c => c.id === businessId);
                        const formHTML = generateMonthlyGuidanceForm(company, month, year);
                        if (formHTML !== null) validMonthlyForms.push(formHTML);
                    }
                    if (validMonthlyForms.length === 0) { showNotification('SeÃ§ilen iÅŸletmelerde belirtilen ayda aktif Ã¶ÄŸrenci bulunamadÄ±.', 'error'); return; }
                    for (let i = 0; i < validMonthlyForms.length; i += 2) {
                        const form1 = validMonthlyForms[i];
                        const form2 = validMonthlyForms[i + 1] || ''; 
                        allFormsHTML += `<div class="print-page-container print-page-monthly-guidance"><div class="print-page"><div class="print-form-half">${form1}</div><div class="print-form-half">${form2}</div></div></div>`;
                    }
                }
            } else if (formType === 'daily_guidance') {
                let selectedBusinessIds = Array.from(document.querySelectorAll('.daily-business-checkbox:checked')).map(cb => cb.value);
                const selectedWeek = parseInt(dom.genWeekSelect1.value);
                if (selectedBusinessIds.length === 0) { showNotification('LÃ¼tfen en az bir iÅŸletme seÃ§in.', 'error'); return; }
                const month = parseInt(dom.dailyMonthSelect.value);
                const year = parseInt(dom.dailyYearSelect.value);
                let weekStartDate = null, weekEndDate = null;
                const firstDayOfMonth = new Date(year, month, 1);
                const lastDayOfMonth = new Date(year, month + 1, 0);
                let firstMonday = new Date(firstDayOfMonth);
                const firstDayWeekday = firstDayOfMonth.getDay();
                const daysToSubtract = firstDayWeekday === 0 ? 6 : firstDayWeekday - 1;
                firstMonday.setDate(firstDayOfMonth.getDate() - daysToSubtract);
                let weekNumber = 1;
                let currentMonday = new Date(firstMonday);
                while (currentMonday <= lastDayOfMonth) {
                    const weekStart = new Date(currentMonday);
                    const weekEnd = new Date(currentMonday);
                    weekEnd.setDate(weekEnd.getDate() + 6);
                    if (weekEnd >= firstDayOfMonth && weekStart <= lastDayOfMonth) {
                        if (weekNumber === selectedWeek) { weekStartDate = weekStart; weekEndDate = weekEnd; break; }
                        weekNumber++;
                    }
                    currentMonday.setDate(currentMonday.getDate() + 7);
                }
                const businessForms = selectedBusinessIds.map(businessId => {
                    const business = appData.businesses.find(b => b.id === businessId);
                    if (!business || !business.visitDay) return null;
                    if (!weekStartDate || !weekEndDate) return null;
                    let visitDate = null;
                    for (let d = new Date(weekStartDate); d <= weekEndDate; d.setDate(d.getDate() + 1)) {
                        if (d.getDay() === parseInt(business.visitDay)) { visitDate = new Date(d); break; }
                    }
                    if (!visitDate) return null;
                    return generateDailyGuidanceForm(business, visitDate);
                }).filter(form => form !== null);
                if (businessForms.length === 0) { showNotification('SeÃ§ilen hafta iÃ§in uygun ziyaret gÃ¼nÃ¼ veya aktif Ã¶ÄŸrenci bulunamadÄ±.', 'error'); return; }
                for (let i = 0; i < businessForms.length; i += 2) {
                    const form1HTML = businessForms[i];
                    const form2HTML = businessForms[i + 1] || null;
                    let column1 = `<div class="daily-guidance-column"><div class="top-right-text">Ä°ME-GÃ–REV REHBERLÄ°K</div>${form1HTML}<div class="bottom-left-text">FORM 4A</div></div>`;
                    let column2 = `<div class="daily-guidance-column">`;
                    if (form2HTML) { column2 += `<div class="top-right-text">Ä°ME-GÃ–REV REHBERLÄ°K</div>${form2HTML}<div class="bottom-left-text">FORM 4A</div>`; }
                    column2 += `</div>`;
                    allFormsHTML += `<div class="print-page-container print-page-daily-guidance"><div class="daily-guidance-container">${column1}${column2}</div></div>`;
                }
            }
            if (allFormsHTML) { dom.printContainer.innerHTML = allFormsHTML; window.print(); }
        });

        dom.formTypeSelect.addEventListener('change', (e) => {
            if (e.target.value === 'daily_guidance') { dom.controlsMonthly.classList.remove('active'); dom.controlsDaily.classList.add('active'); }
            else { dom.controlsDaily.classList.remove('active'); dom.controlsMonthly.classList.add('active'); }
        });

        document.addEventListener('click', function(e) {
            if (e.target.type === 'checkbox' && (e.target.classList.contains('business-checkbox') || e.target.classList.contains('daily-business-checkbox'))) {
                setTimeout(() => { updateDropdownText(); }, 10); return;
            }
            if (e.target.tagName === 'LABEL') {
                const checkbox = document.getElementById(e.target.getAttribute('for'));
                if (checkbox) { checkbox.checked = !checkbox.checked; setTimeout(() => { updateDropdownText(); }, 10); }
                return;
            }
            if (e.target.closest('#business-dropdown-header')) {
                const content = document.getElementById('business-dropdown-content');
                const header = document.getElementById('business-dropdown-header');
                if (content.style.display === 'block') { content.style.display = 'none'; header.classList.remove('open'); } 
                else { content.style.display = 'block'; header.classList.add('open'); }
                return;
            }
            if (e.target.closest('#daily-business-dropdown-header')) {
                const content = document.getElementById('daily-business-dropdown-content');
                const header = document.getElementById('daily-business-dropdown-header');
                if (content.style.display === 'block') { content.style.display = 'none'; header.classList.remove('open'); } 
                else { content.style.display = 'block'; header.classList.add('open'); }
                return;
            }
            if (e.target.closest('.dropdown-item') && !e.target.closest('button')) {
                const item = e.target.closest('.dropdown-item');
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox) { checkbox.checked = !checkbox.checked; setTimeout(() => { updateDropdownText(); }, 10); }
            }
        });

        dom.selectAllBusinesses.addEventListener('click', (e) => { e.stopPropagation(); document.querySelectorAll('.business-checkbox').forEach(cb => cb.checked = true); updateDropdownText(); });
        dom.deselectAllBusinesses.addEventListener('click', (e) => { e.stopPropagation(); document.querySelectorAll('.business-checkbox').forEach(cb => cb.checked = false); updateDropdownText(); });
        dom.selectAllDailyBusinesses.addEventListener('click', (e) => { e.stopPropagation(); document.querySelectorAll('.daily-business-checkbox').forEach(cb => cb.checked = true); updateDropdownText(); });
        dom.deselectAllDailyBusinesses.addEventListener('click', (e) => { e.stopPropagation(); document.querySelectorAll('.daily-business-checkbox').forEach(cb => cb.checked = false); updateDropdownText(); });

        // Grade Sheet Business Dropdown Event Listeners
        document.addEventListener('click', function(e) {
            // Grade sheet dropdown header toggle
            if (e.target.closest('#grade-sheet-business-dropdown-header')) {
                const content = document.getElementById('grade-sheet-business-dropdown-content');
                const header = document.getElementById('grade-sheet-business-dropdown-header');
                if (content.style.display === 'block') {
                    content.style.display = 'none';
                    header.classList.remove('open');
                } else {
                    content.style.display = 'block';
                    header.classList.add('open');
                }
                return;
            }
        });
        
        // Select all grade businesses
        document.addEventListener('click', function(e) {
            if (e.target.id === 'select-all-grade-businesses') {
                e.stopPropagation();
                document.querySelectorAll('.grade-sheet-business-checkbox').forEach(cb => cb.checked = true);
                updateGradeSheetDropdownText();
            }
        });
        
        // Deselect all grade businesses
        document.addEventListener('click', function(e) {
            if (e.target.id === 'deselect-all-grade-businesses') {
                e.stopPropagation();
                document.querySelectorAll('.grade-sheet-business-checkbox').forEach(cb => cb.checked = false);
                updateGradeSheetDropdownText();
            }
        });
        
        // Grade sheet checkbox change
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('grade-sheet-business-checkbox')) {
                updateGradeSheetDropdownText();
            }
        });
        document.addEventListener('change', (e) => { if (e.target.matches('.business-checkbox, .daily-business-checkbox')) { updateDropdownText(); } });
        [dom.dailyMonthSelect, dom.dailyYearSelect].forEach(el => el.addEventListener('change', populateWeeksForDailyForm));
        dom.tabs.addEventListener('click', e => { if(e.target.matches('.tab')) { const tabId=e.target.dataset.tab; document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); document.getElementById(tabId).classList.add('active'); e.target.classList.add('active'); }});
        
        document.addEventListener('click', e => {
            if (e.target.matches('[data-action="cancel-modal"]')) { e.target.closest('.modal').style.display = 'none'; return; }
            const accordionHeader = e.target.closest('.accordion-header'); 
            if (accordionHeader) { accordionHeader.nextElementSibling.classList.toggle('open'); return; } 
            const action = e.target.dataset.action; 
            if(!action) return; 
            const id = e.target.dataset.id; 
            const businessId = e.target.dataset.businessId; 
            switch(action) { 
                case 'add-student': openModal('studentModal', {businessId: id}); break; 
                case 'edit-business': openModal('businessModal', {id: id}); break; 
                case 'delete-business': deleteBusiness(id); break; 
                case 'edit-student': openModal('studentModal', {id: id, businessId: businessId}); break; 
                case 'delete-student': deleteStudent(id, businessId); break;
                case 'open-termination-modal': openModal('terminationModal', {studentId: id, businessId: businessId}); break; 
                case 'cancel-termination': cancelTermination(e.target.dataset.studentId || e.target.dataset.id, businessId); break;
                case 'open-absence-modal': openModal('absenceModal', {studentId: id, businessId: businessId}); break; 
            } 
        });

        dom.absenceModal.querySelector('#saveAbsenceBtn').addEventListener('click', saveAbsences);
        dom.absenceModal.querySelector('#absenceMonthSelect').addEventListener('change', renderAbsenceCalendar);
        dom.absenceModal.querySelector('#absenceYearSelect').addEventListener('change', renderAbsenceCalendar);
        dom.absenceModal.addEventListener('click', e => { const dayEl = e.target.closest('.calendar-day.workday'); if (!dayEl) return; const statusEl = dayEl.querySelector('.calendar-day-status'); let currentStatus = statusEl.textContent.replace(/\s/g, ''); let newStatus = ''; if (currentStatus === '') newStatus = 'S'; else if (currentStatus === 'S') newStatus = 'Ã–'; else if (currentStatus === 'Ã–') newStatus = 'SÃ–'; else newStatus = ''; statusEl.innerHTML = newStatus.replace('SÃ–', 'S<br>Ã–'); statusEl.classList.toggle('f-gold', newStatus !== ''); });
        dom.addBusinessBtn.addEventListener('click', () => openModal('businessModal', null));
        document.getElementById('generateGradeSheetBtn').addEventListener('click', handleGenerateGradeSheet);

        dom.businessForm.addEventListener('submit', saveBusiness);
        dom.studentForm.addEventListener('submit', saveStudent);
        dom.terminationForm.addEventListener('submit', generateTerminationForm);
        dom.downloadBtn.addEventListener('click', () => { saveData(); const dataStr = JSON.stringify(appData, null, 2); const blob = new Blob([dataStr], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `mesem_verileri_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url); showNotification('Veriler baÅŸarÄ±yla indirildi.', 'success'); });
        dom.uploadBtn.addEventListener('click', () => dom.uploadInput.click());
        dom.uploadInput.addEventListener('change', (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const loadedData = JSON.parse(e.target.result); if (loadedData.settings && loadedData.businesses) { appData = loadedData; saveData(); loadData(); renderAll(); showNotification('Veriler baÅŸarÄ±yla geri yÃ¼klendi.', 'success'); } else { showNotification('HatalÄ± dosya formatÄ±.', 'error'); } } catch (error) { showNotification('Dosya okunurken bir hata oluÅŸtu: ' + error, 'error'); } }; reader.readAsText(file); event.target.value = ''; });
        dom.printListBtn.addEventListener('click', () => { const listHTML = generateListPrint(); dom.printContainer.innerHTML = listHTML; window.print(); });
        document.addEventListener('input', (e) => { if (e.target.hasAttribute('inputmode') && e.target.getAttribute('inputmode') === 'numeric') { e.target.value = e.target.value.replace(/[^0-9]/g, ''); } });
        dom.settingsInputs.forEach(input => input.addEventListener('input', saveData));        

        function setVhProperty() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        setVhProperty();
        window.addEventListener('resize', setVhProperty);
        window.addEventListener('orientationchange', setVhProperty);
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                dom.loginSection.style.display = 'none';
                dom.userInfo.style.display = 'block';
                dom.userName.textContent = user.displayName || user.email;
                dom.container.style.display = 'block';
                loadUserData(); 
            } else {
                currentUser = null;
                dom.loginSection.style.display = 'block';
                dom.userInfo.style.display = 'none';
                dom.container.style.display = 'none';
                appData = {}; 
            }
        });
    });
</script>
</body>

</html>
