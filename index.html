<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#f4c542">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>MESEM G√ºnl√ºk ve Aylƒ±k Rehberlik- Devamsƒ±zlƒ±k- Fesih Formlarƒ±</title>
     <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <style>
        :root { 
            --dark-bg: #0f172a; --light-bg: #0f172a; --card-bg: #0f172a; --accent-gold: #f4c542;
            --accent-gold-50: rgba(244, 197, 66, 0.5); --btn-red: #b22234; --btn-red-hover: #9b1d2d;
            --text-light: #e0e6ed; --text-lighter: #f0f4f8; --text-white: #ffffff; --danger-red: #ff6b7a; 
            --success-green: #4ecdc4; 
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #0f172a; backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            position: relative; min-height: 100vh; color: var(--text-light);
        }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .tabs { display: flex; background: var(--light-bg); border-radius: 10px 10px 0 0; border: 2px solid var(--accent-gold); border-bottom: none; }
        .tab { flex: 1; padding: 18px; text-align: center; cursor: pointer; color: var(--text-light); font-weight: 600; font-size: 1rem; transition: all 0.2s ease; border: none; background: transparent; }
        .tab.active { color: var(--accent-gold); background-color: var(--card-bg); }
        .content { background: var(--light-bg); border-radius: 0 0 10px 10px; border: 2px solid var(--accent-gold); min-height: 70vh; }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        .panel { background-color: var(--card-bg); padding: 25px; margin-bottom: 25px; border: 2px solid var(--accent-gold); border-radius: 8px; }
        .panel h2, .content h2 { color: var(--text-white); font-size: 1.5rem; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--accent-gold); }
        .form-group { position: relative; display: flex; flex-direction: column; margin-bottom: 15px; }
        label { font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; color: var(--text-lighter); }
        label .required-star { color: var(--danger-red); font-size: 1.1rem; margin-left: 4px; }
        label .field-hint { color: var(--accent-gold); font-size: 0.8rem; font-weight: normal; margin-left: 8px; }
        .form-input, .form-select { width: 100%; background-color: var(--dark-bg); color: var(--text-lighter); border: 2px solid var(--accent-gold); border-radius: 5px; padding: 12px; font-size: 1rem; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--accent-gold); box-shadow: 0 0 0 3px var(--accent-gold-50); }
        .error-message { color: var(--danger-red); font-size: 0.8rem; margin-top: 4px; display: none; }
        input.invalid, select.invalid { border-color: var(--danger-red) !important; }
        .btn { background-color: var(--btn-red); color: var(--text-white); border: none; padding: 10px 18px; border-radius: 5px; font-weight: 600; cursor: pointer; transition: background-color 0.2s ease; }
        .btn:hover { background-color: var(--btn-red-hover); }
        .btn-primary { background-color: var(--btn-red); color: var(--text-white); }
        .btn-primary:hover { background-color: var(--btn-red-hover); }
        .btn-danger { background-color: #dc3545; color: var(--text-white); }
        .btn-danger:hover { background-color: #c82333; }
        .accordion-header { background-color: var(--card-bg); color: var(--text-white); padding: 15px 20px; border-radius: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-top: 15px; border: 2px solid var(--accent-gold); }
        .accordion-content { padding: 20px; border: 2px solid var(--accent-gold); border-top: none; border-radius: 0 0 5px 5px; display: none; background: var(--card-bg); }
        .accordion-content.open { display: block; }
        .student-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--dark-bg); padding: 10px 15px; border-radius: 5px; margin-bottom: 8px; flex-wrap: wrap; gap: 10px; border: 2px solid var(--accent-gold); }
        .student-info strong { font-size: 1rem; color: var(--text-lighter); }
        .student-info small { font-size: 0.8rem; color: var(--text-light); }
        .student-actions { display: flex; flex-wrap: wrap; gap: 8px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(11, 29, 58, 0.9); backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--light-bg); margin: 5% auto; padding: 30px; border: 2px solid var(--accent-gold); border-radius: 10px; width: 90%; max-width: 800px; }
        .dropdown-container { position: relative; width: 100%; }
        .dropdown-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: var(--dark-bg); border: 2px solid var(--accent-gold); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; user-select: none; }
        .dropdown-content { position: absolute; top: 100%; left: 0; right: 0; background: var(--dark-bg); border: 2px solid var(--accent-gold); border-top: none; border-radius: 0 0 8px 8px; max-height: 300px; overflow-y: auto; z-index: 1000; display: none; }
        .dropdown-content.open { display: block; }
        .dropdown-controls { display: flex; gap: 8px; padding: 10px; border-bottom: 1px solid var(--accent-gold-50); }
        .dropdown-btn { padding: 6px 12px; background: var(--btn-red); color: var(--text-white); border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: background 0.2s ease; }
        .summary-panel { margin-top: 40px; padding-top: 25px; border-top: 2px solid var(--accent-gold); display: flex; justify-content: space-around; text-align: center; }
        .summary-item .count { font-size: 2rem; font-weight: bold; color: var(--accent-gold); }
        .summary-item .label { font-size: 1rem; color: var(--text-light); }
        
        @media print {
            .no-print { display: none !important; }
            body, * { background: transparent !important; color: #000 !important; box-shadow: none !important; text-shadow: none !important; }
            #print-container { display: block !important; }
        }
        @media (max-width: 480px) {
            .btn { padding: 8px 12px; font-size: 0.85rem; min-height: 40px; }
            .student-actions { gap: 5px !important; }
            .student-actions .btn { flex: 1; min-width: 60px; font-size: 0.8rem; padding: 6px 8px; }
            .student-item { flex-direction: column; gap: 10px; }
            .summary-panel { flex-direction: column; gap: 15px; }
            .form-input, .form-select { font-size: 16px; }
            .modal-content { width: 98%; height: 90vh; overflow-y: auto; }
        }
    </style>
</head>
<body>

    <div id="auth-container" class="no-print" style="background: var(--dark-bg); padding: 15px; border-bottom: 2px solid var(--accent-gold);">
        <div id="login-section" style="text-align: center;">
            <h2 style="color: var(--accent-gold); margin-bottom: 10px;">üéì MESEM Takip Sistemi</h2>
            <button id="google-login-btn" class="btn btn-primary">üîê Google Hesabƒ±mla Giri≈ü</button>
        </div>
        <div id="user-info" style="display: none; text-align: right;">
            <span id="user-name" style="color: var(--text-light); margin-right: 15px;"></span>
            <button id="logout-btn" class="btn btn-danger">√áƒ±kƒ±≈ü</button>
        </div>
    </div>

    <div class="container no-print" style="display: none;">
        <div class="tabs">
            <button class="tab active" data-tab="management-panel">üè¢ Y√∂netim Paneli</button>
            <button class="tab" data-tab="generator-panel">üìã Form Olu≈ütur</button>
        </div>
        <div class="content">
            <div id="management-panel" class="tab-content active">
                <div class="panel">
                    <h2>Genel Ayarlar</h2>
                    <div class="grid" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                         <div class="form-group"><label for="schoolName">Okul/Kurumun Adƒ±</label><input type="text" id="schoolName" class="form-input"></div>
                         <div class="form-group"><label for="coordinatorName">Koordinat√∂r √ñƒüretmen</label><input type="text" id="coordinatorName" class="form-input"></div>
                         <div class="form-group"><label for="asstPrincipalName">Koordinat√∂r M√ºd√ºr Yardƒ±mcƒ±sƒ±</label><input type="text" id="asstPrincipalName" class="form-input"></div>
                         <div class="form-group"><label for="principalName">Okul M√ºd√ºr√º</label><input type="text" id="principalName" class="form-input"></div>
                    </div>
                </div>
                <div style="display:flex; justify-content: space-between; align-items: center;">
                    <h2>ƒ∞≈ületmeler</h2>
                    <button class="btn btn-primary" id="add-business-btn">Yeni ƒ∞≈ületme Ekle</button>
                </div>
                <div id="businessesAccordion" style="margin-top: 20px;"></div>
                <div class="summary-panel" id="summary-panel">
                    <div class="summary-item">
                        <div id="totalBusinesses" class="count">0</div>
                        <div class="label">Toplam ƒ∞≈ületme</div>
                    </div>
                    <div class="summary-item">
                        <div id="totalStudents" class="count">0</div>
                        <div class="label">Toplam √ñƒürenci</div>
                    </div>
                 </div>
            </div>
            <div id="generator-panel" class="tab-content">
                 <h2>Form Olu≈ütur</h2>
                 <div class="form-group">
                     <label>1. Form T√ºr√ºn√º Se√ßin</label>
                     <select id="formTypeSelect" class="form-select">
                        <option value="attendance">Devamsƒ±zlƒ±k √áizelgesi</option>
                        <option value="monthly_guidance">Aylƒ±k Rehberlik Formu</option>
                        <option value="daily_guidance">G√ºnl√ºk Rehberlik Formu</option>
                     </select>
                 </div>
                 <div class="form-group">
                     <label for="business-select-dropdown">2. ƒ∞≈ületme(ler)i Se√ßin</label>
                     <div class="dropdown-container">
                         <div class="dropdown-header" id="business-dropdown-header">
                             <span id="business-selected-text">ƒ∞≈ületme se√ßin...</span>
                             <span class="dropdown-arrow">‚ñº</span>
                         </div>
                         <div class="dropdown-content" id="business-dropdown-content">
                              <div class="dropdown-controls">
                                 <button type="button" class="dropdown-btn" id="select-all-businesses">T√ºm√ºn√º Se√ß</button>
                                 <button type="button" class="dropdown-btn" id="deselect-all-businesses">Temizle</button>
                              </div>
                             <div id="business-dropdown-list"></div>
                         </div>
                      </div>
                 </div>
                 <button class="btn btn-primary" id="generate-sheet-btn" style="margin-top:20px; width: 100%; padding: 15px;">Formlarƒ± Olu≈ütur ve Yazdƒ±r</button>
            </div>
        </div>
    </div>
    
    <div id="print-container"></div>
    
    <div class="modal" id="businessModal"><div class="modal-content"> ... </div></div>
    <div class="modal" id="studentModal"><div class="modal-content"> ... </div></div>
    <script type="module">
  // 1. Firebase K√ºt√ºphanelerini import et
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  // 2. Firebase ayarlarƒ±nƒ± yap ve ba≈ülat
  const firebaseConfig = {
    apiKey: "AIzaSyB8H41-2uK39kWSRhLJOBmnzdlaxzVyGC0",
    authDomain: "mesem-takip-sistemi-408d8.firebaseapp.com",
    projectId: "mesem-takip-sistemi-408d8",
    storageBucket: "mesem-takip-sistemi-408d8.appspot.com",
    messagingSenderId: "66667379009",
    appId: "1:66667379009:web:7303e9bb7cc49b751a89c0"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  let currentUser = null;
  
  // 3. T√úM UYGULAMA MANTIƒûI BU BLOK ƒ∞√áƒ∞NE ALINDI
  document.addEventListener('DOMContentLoaded', () => {
    
    let appData = {};
    let currentAbsence = { studentId: null, businessId: null };

    const dom = {
        loginSection: document.getElementById('login-section'),
        userInfo: document.getElementById('user-info'),
        userName: document.getElementById('user-name'),
        googleLoginBtn: document.getElementById('google-login-btn'),
        logoutBtn: document.getElementById('logout-btn'),
        tabs: document.querySelector('.tabs'), 
        settingsInputs: document.querySelectorAll('#management-panel .panel .form-input'), 
        businessesAccordion: document.getElementById('businessesAccordion'), 
        addBusinessBtn: document.getElementById('add-business-btn'), 
        businessModal: document.getElementById('businessModal'), 
        businessForm: document.getElementById('businessForm'), 
        studentModal: document.getElementById('studentModal'), 
        studentForm: document.getElementById('studentForm'), 
        terminationModal: document.getElementById('terminationModal'), 
        terminationForm: document.getElementById('terminationForm'), 
        absenceModal: document.getElementById('absenceModal'), 
        genMonthSelect: document.getElementById('genMonthSelect'), 
        genYearSelect: document.getElementById('genYearSelect'), 
        dailyMonthSelect: document.getElementById('dailyMonthSelect'), 
        dailyYearSelect: document.getElementById('dailyYearSelect'), 
        genWeekSelect1: document.getElementById('genWeekSelect1'), 
        generateSheetBtn: document.getElementById('generate-sheet-btn'), 
        printContainer: document.getElementById('print-container'), 
        formTypeSelect: document.getElementById('formTypeSelect'), 
        totalBusinesses: document.getElementById('totalBusinesses'), 
        totalStudents: document.getElementById('totalStudents'), 
        businessDropdownHeader: document.getElementById('business-dropdown-header'), 
        businessDropdownContent: document.getElementById('business-dropdown-content'), 
        businessDropdownList: document.getElementById('business-dropdown-list'), 
        businessSelectedText: document.getElementById('business-selected-text'),
        selectAllBusinesses: document.getElementById('select-all-businesses'), 
        deselectAllBusinesses: document.getElementById('deselect-all-businesses'), 
    };

    // --- Firebase Fonksiyonlarƒ± ---
    async function signInWithGoogle() {
        try {
            const provider = new GoogleAuthProvider();
            await signInWithPopup(auth, provider);
        } catch (error) {
            console.error('Giri≈ü hatasƒ±:', error);
            showNotification('Giri≈ü yapƒ±lamadƒ±: ' + error.message, 'error');
        }
    }

    onAuthStateChanged(auth, async (user) => {
        const container = document.querySelector('.container');
        if (user) {
            currentUser = user;
            dom.loginSection.style.display = 'none';
            dom.userInfo.style.display = 'block';
            dom.userName.textContent = user.displayName;
            container.style.display = 'block';
            await loadUserData();
        } else {
            currentUser = null;
            dom.loginSection.style.display = 'block';
            dom.userInfo.style.display = 'none';
            container.style.display = 'none';
            loadDefaultData();
        }
    });

    async function loadUserData() {
        if (!currentUser) return;
        try {
            const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
            if (userDoc.exists()) {
                appData = userDoc.data();
            } else {
                console.log("Yeni kullanƒ±cƒ± i√ßin varsayƒ±lan veri olu≈üturuluyor.");
                loadDefaultData(false);
            }
            renderAll();
        } catch (error) {
            console.error('Veri y√ºkleme hatasƒ±:', error);
            showNotification('Veri y√ºklenirken bir hata olu≈ütu.', 'error');
        }
    }
    
    function loadDefaultData(shouldRender = true) {
        appData = { 
            settings: { 
                schoolName: 'U≈ûAK MESLEKƒ∞ VE TEKNƒ∞K ANADOLU Lƒ∞SESƒ∞', 
                coordinatorName: '', 
                asstPrincipalName: 'Salih SEVƒ∞M', 
                principalName: 'Se√ßkin ≈ûENT√úRK' 
            }, 
            businesses: [] 
        };
        if (shouldRender) {
            renderAll();
        }
    }

    async function saveData() {
        dom.settingsInputs.forEach(input => { 
            if(input.id && appData.settings) {
                appData.settings[input.id] = input.value; 
            }
        });
        
        if (currentUser) {
            try {
                await setDoc(doc(db, 'users', currentUser.uid), appData);
                console.log('Veri ba≈üarƒ±yla buluta kaydedildi.');
            } catch (error) {
                console.error('Buluta kaydetme hatasƒ±:', error);
                showNotification('Veri kaydedilirken bir hata olu≈ütu.', 'error');
            }
        }
    }

    dom.googleLoginBtn.onclick = signInWithGoogle;
    dom.logoutBtn.onclick = () => signOut(auth);
    
    const monthNames = ["Ocak", "≈ûubat", "Mart", "Nisan", "Mayƒ±s", "Haziran", "Temmuz", "Aƒüustos", "Eyl√ºl", "Ekim", "Kasƒ±m", "Aralƒ±k"];

    // 2024-2025-2026 Yƒ±lƒ± Resmi Tatil G√ºnleri (Ay 0'dan ba≈ülar: Ocak=0, ≈ûubat=1...)
    const publicHolidays = {
        '2024': [
            { month: 9, day: 29, halfDay: false }, // Cumhuriyet Bayramƒ±
        ],
        '2025': [
            { month: 0, day: 1, halfDay: false },  // Yƒ±lba≈üƒ±
            { month: 2, day: 29, halfDay: true }, // Ramazan Bayramƒ± Arifesi
            { month: 2, day: 30, halfDay: false },// Ramazan Bayramƒ± 1. G√ºn
            { month: 2, day: 31, halfDay: false },// Ramazan Bayramƒ± 2. G√ºn
            { month: 3, day: 1, halfDay: false }, // Ramazan Bayramƒ± 3. G√ºn
            { month: 3, day: 23, halfDay: false },// Ulusal Egemenlik ve √áocuk Bayramƒ±
            { month: 4, day: 1, halfDay: false }, // Emek ve Dayanƒ±≈üma G√ºn√º
            { month: 4, day: 19, halfDay: false },// Atat√ºrk'√º Anma, Gen√ßlik ve Spor Bayramƒ±
            { month: 5, day: 5, halfDay: true }, // Kurban Bayramƒ± Arifesi
            { month: 5, day: 6, halfDay: false }, // Kurban Bayramƒ± 1. G√ºn
            { month: 5, day: 7, halfDay: false }, // Kurban Bayramƒ± 2. G√ºn
            { month: 5, day: 8, halfDay: false }, // Kurban Bayramƒ± 3. G√ºn
            { month: 5, day: 9, halfDay: false }, // Kurban Bayramƒ± 4. G√ºn
            { month: 6, day: 15, halfDay: false },// Demokrasi ve Milli Birlik G√ºn√º
            { month: 7, day: 30, halfDay: false },// Zafer Bayramƒ±
            { month: 9, day: 28, halfDay: true }, // Cumhuriyet Bayramƒ± Arifesi
            { month: 9, day: 29, halfDay: false } // Cumhuriyet Bayramƒ±
        ],
        '2026': [
            { month: 0, day: 1, halfDay: false },   // Yƒ±lba≈üƒ±
            { month: 2, day: 19, halfDay: true },  // Ramazan Bayramƒ± Arifesi
            { month: 2, day: 20, halfDay: false }, // Ramazan Bayramƒ± 1. G√ºn
            { month: 2, day: 21, halfDay: false }, // Ramazan Bayramƒ± 2. G√ºn
            { month: 2, day: 22, halfDay: false }, // Ramazan Bayramƒ± 3. G√ºn
            { month: 3, day: 23, halfDay: false }, // Ulusal Egemenlik ve √áocuk Bayramƒ±
            { month: 4, day: 1, halfDay: false },  // Emek ve Dayanƒ±≈üma G√ºn√º
            { month: 4, day: 19, halfDay: false }, // Atat√ºrk'√º Anma, Gen√ßlik ve Spor Bayramƒ±
            { month: 5, day: 26, halfDay: true },  // Kurban Bayramƒ± Arifesi
            { month: 5, day: 27, halfDay: false }, // Kurban Bayramƒ± 1. G√ºn
            { month: 5, day: 28, halfDay: false }, // Kurban Bayramƒ± 2. G√ºn
            { month: 5, day: 29, halfDay: false }, // Kurban Bayramƒ± 3. G√ºn
            { month: 5, day: 30, halfDay: false }, // Kurban Bayramƒ± 4. G√ºn
            { month: 6, day: 15, halfDay: false }, // Demokrasi ve Milli Birlik G√ºn√º
            { month: 7, day: 30, halfDay: false }, // Zafer Bayramƒ±
            { month: 9, day: 28, halfDay: true },  // Cumhuriyet Bayramƒ± Arifesi
            { month: 9, day: 29, halfDay: false }  // Cumhuriyet Bayramƒ±
        ]
    };

    // MEB √áalƒ±≈üma Takvimine G√∂re Okul Tatil D√∂nemleri
    const schoolHolidays = [
        // 2024-2025
        { start: new Date(2024, 10, 11), end: new Date(2024, 10, 15) }, // 1. Ara Tatil
        { start: new Date(2025, 0, 20), end: new Date(2025, 1, 2) },   // Yarƒ±yƒ±l Tatili
        { start: new Date(2025, 3, 7), end: new Date(2025, 3, 11) },  // 2. Ara Tatil
        { start: new Date(2025, 5, 14), end: new Date(2025, 8, 7) },   // Yaz Tatili ba≈ülangƒ±cƒ±

        // 2025-2026
        { start: new Date(2025, 10, 10), end: new Date(2025, 10, 14) }, // 1. Ara Tatil
        { start: new Date(2026, 0, 19), end: new Date(2026, 0, 30) },   // Yarƒ±yƒ±l Tatili
        { start: new Date(2026, 2, 16), end: new Date(2026, 2, 20) },   // 2. Ara Tatil
        { start: new Date(2026, 5, 27), end: new Date(2026, 8, 6) }    // Yaz Tatili ba≈ülangƒ±cƒ±
    ];

    // Yardƒ±mcƒ± fonksiyonlar
    function isPublicHoliday(date) {
        const year = date.getFullYear().toString();
        const month = date.getMonth();
        const day = date.getDate();
        if (!publicHolidays[year]) return false;
        return publicHolidays[year].some(holiday => holiday.month === month && holiday.day === day);
    }

    function isSchoolHoliday(date) {
        const checkDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        return schoolHolidays.some(period => checkDate >= period.start && checkDate <= period.end);
    }

    function parseDateString(dateStr) { if (!dateStr) return null; const parts = dateStr.split('-'); return new Date(parts[0], parts[1] - 1, parts[2]); }
    function getVisitDatesForMonth(year, month, dayOfWeek) { const dates = []; const targetDay = parseInt(dayOfWeek); if (isNaN(targetDay)) return []; const date = new Date(year, month, 1); while (date.getMonth() === month) { if (date.getDay() === targetDay) { dates.push(new Date(date.getTime())); } date.setDate(date.getDate() + 1); } return dates; }
    
    function getWeekOfYear(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        return weekNo;
    }
    
    function loadData() {
        const defaultData = { settings: { schoolName: 'U≈ûAK MESLEKƒ∞ VE TEKNƒ∞K ANADOLU Lƒ∞SESƒ∞', coordinatorName: '', asstPrincipalName: 'Salih SEVƒ∞M', principalName: 'Se√ßkin ≈ûENT√úRK' }, businesses: [] };
        appData = JSON.parse(localStorage.getItem(DB_KEY)) || defaultData;
        Object.keys(appData.settings).forEach(key => { if(document.getElementById(key)) document.getElementById(key).value = appData.settings[key]; });
        checkAndUpgradeClasses();
    }

    function checkAndUpgradeClasses() {
        const currentYear = new Date().getFullYear();
        const currentMonth = new Date().getMonth();
        
        if (currentMonth >= 8) {
            const academicYear = currentYear;
            
            if (!appData.lastClassUpgrade || appData.lastClassUpgrade < academicYear) {
                appData.businesses.forEach(business => {
                    if (business.students) {
                        business.students.forEach(student => {
                            if (student.class && !student.endDate) {
                                const currentClass = parseInt(student.class);
                                if (currentClass < 12) {
                                    student.class = (currentClass + 1).toString();
                                }
                            }
                        });
                    }
                });
                
                appData.lastClassUpgrade = academicYear;
                saveData();
            }
        }
    }

    async function saveData() {
        dom.settingsInputs.forEach(input => { 
            if(input.id) {
                if (!appData.settings) appData.settings = {};
                appData.settings[input.id] = input.value; 
            }
        });

        // Local storage'a kaydet
        localStorage.setItem(DB_KEY, JSON.stringify(appData));

        // Eƒüer kullanƒ±cƒ± giri≈ü yapmƒ±≈üsa, buluta da kaydet
        if (window.currentUser && window.saveDataToCloud) {
            await window.saveDataToCloud();
        }
    }
    
    function showNotification(message, type = 'info', callback = null) {
        let alertModal = document.getElementById('alertModal');
        if (!alertModal) {
            alertModal = document.createElement('div');
            alertModal.id = 'alertModal';
            alertModal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;display:none;';
            document.body.appendChild(alertModal);
        }
        
        if (type === 'confirm') {
            alertModal.innerHTML = `
                <div style="background:var(--card-bg);padding:30px;width:400px;text-align:center;border:2px solid var(--accent-gold);border-radius:10px;position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);">
                    <h2 style="color:var(--accent-gold);">‚ö†Ô∏è Onay</h2>
                    <p style="color:var(--text-light);">${message}</p>
                    <div style="display:flex;gap:15px;justify-content:center;margin-top:20px;">
                        <button id="confirmYes" class="btn btn-danger">Evet</button>
                        <button id="confirmNo" class="btn">Hayƒ±r</button>
                    </div>
                </div>
            `;
            
            alertModal.style.display = 'block';
            
            document.getElementById('confirmYes').onclick = function() {
                alertModal.style.display = 'none';
                if (callback) callback(true);
            };
            
            document.getElementById('confirmNo').onclick = function() {
                alertModal.style.display = 'none';
                if (callback) callback(false);
            };
        } else {
            alertModal.innerHTML = `<div style="background:var(--card-bg);padding:30px;width:400px;text-align:center;border:2px solid var(--accent-gold);border-radius:10px;position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);"><h2 style="color:var(--accent-gold);">‚ö†Ô∏è Uyarƒ±</h2><p style="color:var(--text-light);">${message}</p></div>`;
            alertModal.style.display = 'block';
            
            alertModal.onclick = function(e) {
                if (e.target === alertModal) alertModal.style.display = 'none';
            };
        }
    }

    function renderAll() { renderBusinessesAccordion(); renderGeneratorUI(); updateSummaryPanel(); }

    function renderBusinessesAccordion() {
       dom.businessesAccordion.innerHTML = (appData.businesses || []).map(b => `<div><div class="accordion-header" data-id="${b.id}"><h3>${b.name}</h3><span>${b.students?.length||0} √ñƒürenci</span></div><div class="accordion-content" id="content-${b.id}">${renderBusinessContent(b)}</div></div>`).join('') || '<p style="text-align:center; margin-top:20px;">Kayƒ±tlƒ± i≈ületme bulunmuyor.</p>';
    }

    function renderBusinessContent(business) {
        const studentList = (business.students && business.students.length > 0) ? business.students.map(s => {
            const isTerminated = s.endDate;
            let actionButtons = '';
            if (isTerminated) {
                actionButtons = `<button class="btn" style="padding:5px 10px;" data-action="edit-student" data-business-id="${business.id}" data-id="${s.id}">D√ºzenle</button> <button class="btn" style="padding:5px 10px; border-color: #8ab4f8; color: #8ab4f8;" data-action="cancel-termination" data-business-id="${business.id}" data-student-id="${s.id}">Feshi ƒ∞ptal Et</button> <button class="btn btn-danger" style="padding:5px 10px;" data-action="delete-student" data-business-id="${business.id}" data-id="${s.id}">Sil</button>`;
            } else {
                actionButtons = `<button class="btn" style="padding:5px 10px;" data-action="open-absence-modal" data-business-id="${business.id}" data-id="${s.id}">Devamsƒ±zlƒ±k</button> <button class="btn" style="padding:5px 10px;" data-action="edit-student" data-business-id="${business.id}" data-id="${s.id}">D√ºzenle</button> <button class="btn btn-danger" style="padding:5px 10px;" data-action="open-termination-modal" data-business-id="${business.id}" data-id="${s.id}">Feshet</button> <button class="btn btn-danger" style="padding:5px 10px;" data-action="delete-student" data-business-id="${business.id}" data-id="${s.id}">Sil</button>`;
            }
            return `<div class="student-item"> <div class="student-info"> <strong style="${isTerminated ? 'text-decoration: line-through; color: var(--slate);' : ''}">${s.name}</strong> <small>${s.field || 'Alan belirtilmedi'} ${s.phone ? `- Tel: ${s.phone}` : ''} ${isTerminated ? `(Fesih: ${parseDateString(s.endDate).toLocaleDateString('tr-TR')})` : ''}</small> </div> <div class="student-actions">${actionButtons}</div> </div>`;
        }).join('') : '<p>Bu i≈ületmeye kayƒ±tlƒ± √∂ƒürenci bulunmamaktadƒ±r.</p>';

        return `<div style="display:flex; gap:10px; margin-bottom:20px;"> <button class="btn btn-primary" data-action="add-student" data-id="${business.id}">√ñƒürenci Ekle</button> <button class="btn" data-action="edit-business" data-id="${business.id}">ƒ∞≈ületmeyi D√ºzenle</button> <button class="btn btn-danger" data-action="delete-business" data-id="${business.id}">ƒ∞≈ületmeyi Sil</button> </div>${studentList}`;
    }
    
    function renderGeneratorUI() {
        renderBusinessDropdowns();
        const monthOptions = monthNames.map((n,i) => `<option value="${i}">${n}</option>`).join('');
        dom.genMonthSelect.innerHTML = monthOptions;
        dom.dailyMonthSelect.innerHTML = monthOptions;
        
        const today = new Date();
        dom.genYearSelect.value = today.getFullYear(); 
        dom.genMonthSelect.value = today.getMonth();
        dom.dailyYearSelect.value = today.getFullYear();
        dom.dailyMonthSelect.value = today.getMonth();
        populateWeeksForDailyForm();
    }

    function renderBusinessDropdowns() {
        const businessItems = (appData.businesses || []).map(b => 
            `<div class="dropdown-item">
                <input type="checkbox" value="${b.id}" class="business-checkbox" id="monthly-business-${b.id}">
                <label for="monthly-business-${b.id}">${b.name}</label>
            </div>`
        ).join('');
        
        const dailyBusinessItems = (appData.businesses || []).map(b => 
            `<div class="dropdown-item">
                <input type="checkbox" value="${b.id}" class="daily-business-checkbox" id="daily-business-${b.id}">
                <label for="daily-business-${b.id}">${b.name}</label>
            </div>`
        ).join('');
        
        dom.businessDropdownList.innerHTML = businessItems || '<div style="padding: 15px; text-align: center; color: var(--text-light);">ƒ∞≈ületme bulunamadƒ±</div>';
        dom.dailyBusinessDropdownList.innerHTML = dailyBusinessItems || '<div style="padding: 15px; text-align: center; color: var(--text-light);">ƒ∞≈ületme bulunamadƒ±</div>';
        
        updateDropdownText();
    }

    function updateDropdownText() {
        const selectedBusinesses = Array.from(document.querySelectorAll('.business-checkbox:checked'));
        const selectedDaily = Array.from(document.querySelectorAll('.daily-business-checkbox:checked'));
        
        if (selectedBusinesses.length === 0) {
            dom.businessSelectedText.textContent = 'ƒ∞≈ületme se√ßin...';
        } else if (selectedBusinesses.length === 1) {
            const businessName = selectedBusinesses[0].nextElementSibling.textContent;
            dom.businessSelectedText.textContent = businessName;
        } else {
            dom.businessSelectedText.textContent = `${selectedBusinesses.length} i≈ületme se√ßildi`;
        }
        
        if (selectedDaily.length === 0) {
            dom.dailyBusinessSelectedText.textContent = 'ƒ∞≈ületme se√ßin...';
        } else if (selectedDaily.length === 1) {
            const businessName = selectedDaily[0].nextElementSibling.textContent;
            dom.dailyBusinessSelectedText.textContent = businessName;
        } else {
            dom.dailyBusinessSelectedText.textContent = `${selectedDaily.length} i≈ületme se√ßildi`;
        }
    }

    function populateWeeksForDailyForm() {
        const month = parseInt(dom.dailyMonthSelect.value);
        const year = parseInt(dom.dailyYearSelect.value);

        const weeks = [];
        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth = new Date(year, month + 1, 0);

        let firstMonday = new Date(firstDayOfMonth);
        const firstDayWeekday = firstDayOfMonth.getDay();
        const daysToSubtract = firstDayWeekday === 0 ? 6 : firstDayWeekday - 1;
        firstMonday.setDate(firstDayOfMonth.getDate() - daysToSubtract);

        let monthWeekNumber = 1;
        let currentMonday = new Date(firstMonday);

        while (currentMonday <= lastDayOfMonth) {
            const weekStart = new Date(currentMonday);
            const weekEnd = new Date(currentMonday);
            weekEnd.setDate(weekEnd.getDate() + 6);

            if (weekEnd >= firstDayOfMonth && weekStart <= lastDayOfMonth) {
                const yearWeekNumber = getWeekOfYear(weekStart);
                const label = `${yearWeekNumber}. Hafta (${weekStart.toLocaleDateString('tr-TR')} - ${weekEnd.toLocaleDateString('tr-TR')})`;

                weeks.push({ 
                    week: monthWeekNumber,
                    label: label, 
                    startDate: weekStart,
                    endDate: weekEnd 
                });
                monthWeekNumber++;
            }

            currentMonday.setDate(currentMonday.getDate() + 7);
        }

        dom.genWeekSelect1.innerHTML = weeks.map(w => `<option value="${w.week}">${w.label}</option>`).join('');

        const today = new Date();
        if (year === today.getFullYear() && month === today.getMonth()) {
            const currentWeekObject = weeks.find(w => today >= w.startDate && today <= w.endDate);
            if (currentWeekObject) {
                dom.genWeekSelect1.value = currentWeekObject.week;
            }
        }
    }
    
    function updateSummaryPanel() {
        dom.totalBusinesses.textContent = (appData.businesses || []).length;
        const totalStudents = (appData.businesses || []).reduce((sum, business) => sum + (business.students ? business.students.length : 0), 0);
        dom.totalStudents.textContent = totalStudents;
    }

    // Modal ve form fonksiyonlarƒ±
    function openModal(modalId, data) {
        const modal = document.getElementById(modalId);
        const form = modal.querySelector('form'); 
        if (form) {
            form.reset();
            form.querySelectorAll('.error-message').forEach(el => el.style.display = 'none'); 
            form.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
        }
        
        const title = modal.querySelector('h2');
        
        if (modalId === 'businessModal') {
            if (data && data.id) { 
                const b = appData.businesses.find(b => b.id === data.id); 
                title.textContent = 'ƒ∞≈ületmeyi D√ºzenle'; 
                form.querySelector('#businessId').value = b.id; 
                form.querySelector('#businessName').value = b.name; 
                form.querySelector('#businessAddress').value = b.address; 
                form.querySelector('#businessPhone').value = b.phone; 
                form.querySelector('#businessOfficial').value = b.official; 
                form.querySelector('#businessVisitDay').value = b.visitDay; 
            } else { 
                title.textContent = 'Yeni ƒ∞≈ületme Ekle'; 
                form.querySelector('#businessId').value = ''; 
            }
        } else if (modalId === 'studentModal') {
            form.querySelector('#studentBusinessId').value = data.businessId;
            if (data && data.id) { 
                const s = appData.businesses.find(b => b.id === data.businessId).students.find(s => s.id === data.id); 
                title.textContent = '√ñƒürenciyi D√ºzenle'; 
                form.querySelector('#studentId').value = s.id; 
                form.querySelector('#studentClass').value = s.class || '9';
                form.querySelector('#studentNo').value = s.no; 
                form.querySelector('#studentName').value = s.name; 
                form.querySelector('#studentField').value = s.field; 
                form.querySelector('#studentSchoolDay').value = s.schoolDay; 
                form.querySelector('#studentPhone').value = s.phone; 
                form.querySelector('#studentStartDate').value = s.startDate; 
                form.querySelector('#studentEndDate').value = s.endDate; 
            } else { 
                title.textContent = 'Yeni √ñƒürenci Ekle'; 
                form.querySelector('#studentId').value = ''; 
            }
        } else if (modalId === 'terminationModal') {
            form.querySelector('#terminationStudentId').value = data.studentId; 
            form.querySelector('#terminationBusinessId').value = data.businessId; 
            form.querySelector('#terminationDate').value = new Date().toISOString().slice(0, 10);
        } else if (modalId === 'absenceModal') {
            currentAbsence = { studentId: data.studentId, businessId: data.businessId };
            const student = appData.businesses.find(b=>b.id===data.businessId).students.find(s=>s.id===data.studentId);
            modal.querySelector('h2').textContent = `${student.name} - Devamsƒ±zlƒ±k Giri≈üi`;
            const monthSelect = modal.querySelector('#absenceMonthSelect');
            const yearSelect = modal.querySelector('#absenceYearSelect');
            if (monthSelect.innerHTML === '') { 
                monthSelect.innerHTML = monthNames.map((n,i) => `<option value="${i}">${n}</option>`).join(''); 
            }
            monthSelect.value = new Date().getMonth(); 
            yearSelect.value = new Date().getFullYear();
            renderAbsenceCalendar();
        }
        modal.style.display = 'block';
    }

    function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
    
    function validateForm(form) {
        let isValid = true;
        form.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
        form.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
        form.querySelectorAll('[required]').forEach(input => {
            const errorSpan = input.parentElement.querySelector('.error-message');
            if (!input.value.trim()) {
                input.classList.add('invalid');
                if (errorSpan) { errorSpan.textContent = "Bu alan zorunludur."; errorSpan.style.display = 'block'; }
                isValid = false;
            }
        });
        
        const phoneFields = form.querySelectorAll('input[inputmode="numeric"]');
        phoneFields.forEach(input => {
            const errorSpan = input.parentElement.querySelector('.error-message');
            if (input.value && !/^[0-9]+$/.test(input.value)) {
                input.classList.add('invalid');
                if (errorSpan) { errorSpan.textContent = "Sadece rakam giriniz."; errorSpan.style.display = 'block'; }
                isValid = false;
            }
        });
        return isValid;
    }

    function validateStudentForm() {
        if (!validateForm(dom.studentForm)) return false;
        const startDate = dom.studentForm.querySelector('#studentStartDate').value;
        const endDate = dom.studentForm.querySelector('#studentEndDate').value;
        const errorSpan = dom.studentForm.querySelector('#studentEndDateError');
        const endDateInput = dom.studentForm.querySelector('#studentEndDate');

        if (startDate && endDate && parseDateString(endDate) < parseDateString(startDate)) {
            errorSpan.textContent = 'Fesih tarihi, ba≈ülama tarihinden √∂nce olamaz.';
            errorSpan.style.display = 'block';
            endDateInput.classList.add('invalid');
            return false;
        } else {
            errorSpan.style.display = 'none';
            endDateInput.classList.remove('invalid');
        }
        return true;
    }

    function saveBusiness(e) { e.preventDefault(); if (!validateForm(dom.businessForm)) return; const form = dom.businessForm; const id = form.querySelector('#businessId').value; const businessData = { id: id || Date.now().toString(), name: form.querySelector('#businessName').value, address: form.querySelector('#businessAddress').value, phone: form.querySelector('#businessPhone').value, official: form.querySelector('#businessOfficial').value,
     visitDay: form.querySelector('#businessVisitDay').value, students: id ? appData.businesses.find(b => b.id === id).students : [] }; if (id) appData.businesses = appData.businesses.map(b => b.id === id ? businessData : b); else appData.businesses.push(businessData); saveData(); renderAll(); closeModal('businessModal'); showNotification('ƒ∞≈ületme ba≈üarƒ±yla kaydedildi.', 'success'); }
    function saveStudent(e) { e.preventDefault(); if (!validateStudentForm()) return; const form = dom.studentForm; const businessId = form.querySelector('#studentBusinessId').value; const id = form.querySelector('#studentId').value; const business = appData.businesses.find(b => b.id === businessId); const existingStudent = id ? business.students.find(s => s.id === id) : {}; const studentData = { id: id || Date.now().toString(), no: form.querySelector('#studentNo').value, name: form.querySelector('#studentName').value, class: form.querySelector('#studentClass').value, field: form.querySelector('#studentField').value, schoolDay: form.querySelector('#studentSchoolDay').value, phone: form.querySelector('#studentPhone').value, startDate: form.querySelector('#studentStartDate').value, endDate: form.querySelector('#studentEndDate').value, terminationReason: existingStudent.terminationReason || '', absences: existingStudent.absences || {} }; if (id) business.students = business.students.map(s => s.id === id ? studentData : s); else { if(!business.students) business.students = []; business.students.push(studentData); } saveData(); renderAll(); closeModal('studentModal'); showNotification('√ñƒürenci ba≈üarƒ±yla kaydedildi.', 'success'); }
    
    function deleteBusiness(id) {
        showNotification('ƒ∞≈ületmeyi ve i√ßindeki t√ºm √∂ƒürencileri silmek istediƒüinizden emin misiniz?', 'confirm', (result) => {
            if (result) {
                appData.businesses = appData.businesses.filter(b => b.id !== id);
                saveData();
                renderAll();
                showNotification('ƒ∞≈ületme ba≈üarƒ±yla silindi.', 'success');
            }
        });
    }
    function deleteStudent(id, businessId) {
        showNotification('√ñƒürenciyi kalƒ±cƒ± olarak silmek istediƒüinizden emin misiniz?', 'confirm', (result) => {
            if (result) {
                const business = appData.businesses.find(b => b.id === businessId);
                business.students = business.students.filter(s => s.id !== id);
                saveData();
                renderAll();
                showNotification('√ñƒürenci ba≈üarƒ±yla silindi.', 'success');
            }
        });
    }
    function cancelTermination(id, businessId) {
        showNotification('√ñƒürencinin s√∂zle≈üme feshini iptal etmek istediƒüinizden emin misiniz?', 'confirm', (result) => {
            if (result) {
                const business = appData.businesses.find(b => b.id === businessId);
                const student = business.students.find(s => s.id === id);
                student.endDate = '';
                student.terminationReason = '';
                saveData();
                renderAll();
                showNotification('S√∂zle≈üme feshi iptal edildi.', 'success');
            }
        });
    }    

    function renderAbsenceCalendar() {
        const { studentId, businessId } = currentAbsence;
        const modal = dom.absenceModal;
        const month = parseInt(modal.querySelector('#absenceMonthSelect').value);
        const year = parseInt(modal.querySelector('#absenceYearSelect').value);
        const grid = modal.querySelector('#absenceCalendarGrid');
        const student = appData.businesses.find(b => b.id === businessId).students.find(s => s.id === studentId);
        grid.innerHTML = '';
        const firstDay = (new Date(year, month, 1).getDay() + 6) % 7;
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        for(let i=0; i<firstDay; i++) { grid.insertAdjacentHTML('beforeend', '<div class="calendar-day empty"></div>'); }
        for(let day = 1; day <= daysInMonth; day++) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            dayEl.innerHTML = `<div class="calendar-day-num">${day}</div><div class="calendar-day-status"></div>`;
            const currentDate = new Date(year, month, day); const dayOfWeek = currentDate.getDay();
            let isOutOfRange = (student.startDate && new Date(currentDate) < parseDateString(student.startDate)) || (student.endDate && new Date(currentDate) > parseDateString(student.endDate));
            if (!isOutOfRange) {
                const monthYearKey = `${year}-${month}`;
                const studentAbsences = student.absences?.[monthYearKey]?.[day] || [];
                const statusEl = dayEl.querySelector('.calendar-day-status');
                if(dayOfWeek == student.schoolDay) { dayEl.classList.add('school'); statusEl.textContent = 'O'; statusEl.classList.add('f-blue'); }
                else if(dayOfWeek === 0) { dayEl.classList.add('sunday'); statusEl.textContent = 'T'; statusEl.classList.add('f-green'); }
                else {
                    dayEl.classList.add('workday'); dayEl.dataset.day = day;
                    let statusText = '';
                    if (studentAbsences.includes('S')) statusText += 'S';
                    if (studentAbsences.includes('√ñ')) statusText += '√ñ';
                    statusEl.innerHTML = statusText.replace('S√ñ', 'S<br>√ñ');
                    if(statusText !== '') statusEl.classList.add('f-gold');
                }
            } else { dayEl.classList.add('empty'); }
            grid.appendChild(dayEl);
        }
    }
    
    function saveAbsences() {
        const { studentId, businessId } = currentAbsence;
        const modal = dom.absenceModal; const month = modal.querySelector('#absenceMonthSelect').value; const year = modal.querySelector('#absenceYearSelect').value;
        const monthYearKey = `${year}-${month}`;
        const student = appData.businesses.find(b => b.id === businessId).students.find(s => s.id === studentId);
        if(!student.absences) student.absences = {}; if(!student.absences[monthYearKey]) student.absences[monthYearKey] = {};
        modal.querySelectorAll('.calendar-day.workday').forEach(dayEl => {
            const day = parseInt(dayEl.dataset.day); const status = dayEl.querySelector('.calendar-day-status').textContent;
            let absenceData = [];
            if(status.includes('S')) absenceData.push('S');
            if(status.includes('√ñ')) absenceData.push('√ñ');
            if (absenceData.length > 0) student.absences[monthYearKey][day] = absenceData;
            else if (student.absences[monthYearKey][day]) delete student.absences[monthYearKey][day];
        });
        saveData(); closeModal('absenceModal'); showNotification('Devamsƒ±zlƒ±k kayƒ±tlarƒ± g√ºncellendi.', 'success');
    }

    function generateListPrint() {
        let listHTML = `<div class="print-page-container print-page-list"><div class="list-container"><h2 style="margin-bottom: 8px;">${appData.settings.schoolName || 'OKUL ADI'}<br>ƒ∞≈ûLETME VE √ñƒûRENCƒ∞ Lƒ∞STESƒ∞</h2>`;
        
        // Yazdƒ±rma tarih-saati
        const currentDateTime = new Date().toLocaleString('tr-TR', {
            year: 'numeric',
            month: '2-digit', 
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });

        listHTML += `<div style="text-align: right; margin: 3px 0 8px 0; font-size: 8pt; color: #666;">
            Yazdƒ±rma: ${currentDateTime}
        </div>`;

        // Koordinat√∂r bilgileri
        listHTML += `<div style="display: flex; margin: 0 0 8px 0; padding: 5px 0;">
            <div style="width: 50%; text-align: left;">
                <strong>Koordinat√∂r √ñƒüretmen:</strong> ${appData.settings.coordinatorName || '................................'}
            </div>
            <div style="width: 50%; text-align: left;">
                <strong>Koordinat√∂r M√ºd√ºr Yardƒ±mcƒ±sƒ±:</strong> ${appData.settings.asstPrincipalName || '................................'}
            </div>
        </div>`;    
    
        appData.businesses.forEach(business => {
            listHTML += `<div class="business-section">
                <div class="business-header">${business.name} - ${business.address || 'Adres belirtilmedi'} - Tel: ${business.phone || 'Belirtilmedi'} - Yetkili: ${business.official || 'Belirtilmedi'}</div>
                <table class="student-list-table">
                    <thead>
                        <tr>
                            <th style="width: 8%;">No</th>
                            <th style="width: 8%;">Sƒ±nƒ±f</th>
                            <th style="width: 30%;">Adƒ± Soyadƒ±</th>
                            <th style="width: 25%;">Alan/Dalƒ±</th>
                            <th style="width: 15%;">Telefon</th>
                            <th style="width: 14%;">Okul G√ºn√º</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            if (business.students && business.students.length > 0) {
                const activeStudents = business.students.filter(student => !student.endDate);
                
                if (activeStudents.length > 0) {
                    activeStudents.forEach(student => {
                        const schoolDays = ['', 'Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma'];
                        const schoolDay = schoolDays[student.schoolDay] || '';
                        const studentClass = student.class ? `${student.class}. Sƒ±nƒ±f` : '';
                        
                        listHTML += `<tr>
                            <td>${student.no || ''}</td>
                            <td>${studentClass}</td>
                            <td>${student.name}</td>
                            <td>${student.field || ''}</td>
                            <td>${student.phone || ''}</td>
                            <td>${schoolDay}</td>
                        </tr>`;
                    });
                } else {
                    listHTML += `<tr><td colspan="6" style="text-align: center; font-style: italic;">Bu i≈ületmeye kayƒ±tlƒ± aktif √∂ƒürenci bulunmamaktadƒ±r.</td></tr>`;
                }
            } else {
                listHTML += `<tr><td colspan="6" style="text-align: center; font-style: italic;">Bu i≈ületmeye kayƒ±tlƒ± √∂ƒürenci bulunmamaktadƒ±r.</td></tr>`;
            }
            
            listHTML += `</tbody></table></div>`;
        });
        
        listHTML += `</div></div>`;
        return listHTML;
    }

    // ESKƒ∞ generateAttendanceSheet FONKSƒ∞YONUNU Sƒ∞Lƒ∞P BUNU YAPI≈ûTIRIN ‚ñº
    function generateAttendanceSheet(businessId, month, year) {
        const business = appData.businesses.find(b => b.id === businessId); 
        const lastDayOfMonth = new Date(year, month + 1, 0); 
        let studentRowsHTML = ''; 
        const studentList = business.students.filter(s => !s.endDate || parseDateString(s.endDate) > new Date(year, month, 1));
        
        studentList.forEach(student => {
            let morningRowCells = ''; 
            let afternoonRowCells = ''; 
            let unexcusedTotal = 0; 
            const daysInMonth = lastDayOfMonth.getDate();
            
            for(let day = 1; day <= 31; day++) {
                if(day > daysInMonth) { 
                    morningRowCells += `<td></td>`; 
                    afternoonRowCells += `<td></td>`; 
                    continue; 
                }
                const currentDate = new Date(year, month, day); 
                const dayOfWeek = currentDate.getDay();
                let fullDayContent = null;
                let isOutOfRange = (student.startDate && new Date(currentDate) < parseDateString(student.startDate)) || (student.endDate && new Date(currentDate) > parseDateString(student.endDate));
                
                if(isOutOfRange) { 
                    morningRowCells += `<td></td>`; 
                    afternoonRowCells += `<td></td>`; 
                }
                // YENƒ∞ KURAL: Resmi tatil mi kontrol et
                else if(isPublicHoliday(currentDate)) {
                    fullDayContent = `<td rowspan="2" class="f-bold f-green">T</td>`;
                }
                // YENƒ∞ KURAL: Okul g√ºn√º m√º ve okul tatil deƒüil mi kontrol et
                else if(dayOfWeek == student.schoolDay && !isSchoolHoliday(currentDate)) { 
                    fullDayContent = `<td rowspan="2" class="f-bold f-blue">O</td>`; 
                }
                else if(dayOfWeek === 0) { // Pazar g√ºn√º
                    fullDayContent = `<td rowspan="2" class="f-bold f-green">T</td>`; 
                }
                else { // ƒ∞≈ületme g√ºn√º (Okul tatilindeki okul g√ºnleri de buraya dahil olur)
                    const monthYearKey = `${year}-${month}`; 
                    const studentAbsences = student.absences?.[monthYearKey]?.[day] || [];
                    const s_absent = studentAbsences.includes('S'); 
                    const o_absent = studentAbsences.includes('√ñ');
                    if(s_absent) unexcusedTotal += 0.5; 
                    if(o_absent) unexcusedTotal += 0.5;
                    morningRowCells += `<td class="${s_absent ? 'f-teal f-bold': ''}">${s_absent ? 'S' : '+'}</td>`;
                    afternoonRowCells += `<td class="${o_absent ? 'f-teal f-bold': ''}">${o_absent ? '√ñ' : '+'}</td>`;
                }
                if (fullDayContent) { 
                    morningRowCells += fullDayContent; 
                }
            }
            const studentInfo = `<td class="student-info-cell" rowspan="2">${student.name}</td><td class="student-info-cell" rowspan="2">${student.no||''}</td><td class="student-info-cell" rowspan="2">${student.field||''}</td>`;
            const totals = `<td rowspan="2"></td><td rowspan="2">${unexcusedTotal > 0 ? unexcusedTotal : ''}</td>`;
            studentRowsHTML += `<tr>${studentInfo}<td class="f-bold">S</td>${morningRowCells}${totals}</tr><tr><td class="f-bold">√ñ</td>${afternoonRowCells}</tr>`;
        });
        
        const legendHTML = `<div class="legend-box"><strong>Devamsƒ±zlƒ±ƒüƒ±n g√∂sterileceƒüi semboller:</strong><br>(ƒ∞) ƒ∞zinli<br>(H) Hasta Sevkli<br>(R) Raporlu<br>(T) Resmi Tatil<br>(O) Okul G√ºn√º<br>(S) Sabah Devamsƒ±z<br>(√ñ) √ñƒüleden Sonra Devamsƒ±z</div>`;
        const explanationHTML = `<div class="explanation-section"><strong>Bu √ßizelge, i≈ületme tarafƒ±ndan tutulacak, √∂ƒürencinin i≈ületmede bulunmasƒ± gereken g√ºnlere ait devamsƒ±zlƒ±k durumlarƒ± ilgili s√ºtunda, yanda g√∂sterilen uygun sembolle belirlenecektir.</strong></div>`;
        const mainTitle = `<div class="print-main-title">ƒ∞≈ületmelerde Meslek Eƒüitimi G√∂ren √ñƒürencilerin Aylƒ±k Devam - Devamsƒ±zlƒ±k Bildirim √áizelgesi</div>`;
        const headerTable = `<table class="print-header-table"><tr><td style="width: 25%;" rowspan="2"><strong>Okul/Kurumun Adƒ±:</strong><br><span class="dynamic-text">${appData.settings.schoolName || ''}</span></td><td style="width: 50%;"><strong>ƒ∞≈ületmenin:</strong> Adƒ±: <span class="dynamic-text">${business.name || ''}</span></td><td style="width: 25%;"><strong>Ait Olduƒüu Ay:</strong> <span class="dynamic-text">${monthNames[month]} ${year}</span></td></tr><tr><td>Telefonu ve faksƒ±: <span class="dynamic-text">${business.phone || ''}</span></td><td><strong>Belgenin D√ºzenlendiƒüi Tarih:</strong> <span class="dynamic-text">${lastDayOfMonth.toLocaleDateString('tr-TR')}</span></td></tr></table>`;
        const mainTable = `<table class="print-main-table"><thead><tr><th colspan="3" rowspan="2">√ñƒûRENCƒ∞Nƒ∞N</th><th rowspan="3" class="header-cell-days">G√úNLER</th><th colspan="31"></th><th colspan="2" rowspan="2">TOPLAM<br>DEVAMSIZLIK</th></tr><tr>${Array.from({length: 31}, (_, i) => `<th class="day-cell">${i+1}</th>`).join('')}</tr><tr><th class="header-cell-name">Adƒ± Soyadƒ±</th><th class="header-cell-no">No</th><th class="header-cell-field">Alan/Dalƒ±</th><th colspan="31" style="border-top: 1px solid #000;"></th><th class="header-cell-total">√ñz√ºrl√º</th><th class="header-cell-total">√ñz√ºrs√ºz</th></tr></thead><tbody>${studentRowsHTML}</tbody></table>`;
        
        const printFooter = `<div class="print-footer">
            <div class="signature-section"><strong>ƒ∞≈ületme Yetkilisi</strong><br><span class="dynamic-text">${business.official || ''}</span><br><br>Ka≈üe - ƒ∞mza</div>
            <div class="signature-section"><strong>Koordinat√∂r √ñƒüretmen</strong><br><span class="dynamic-text">${appData.settings.coordinatorName || ''}</span><br><span class="dynamic-text">${lastDayOfMonth.toLocaleDateString('tr-TR')}</span><br>ƒ∞mza</div>
            <div class="signature-section"><strong>Koordinat√∂r M√ºd√ºr Yrd.</strong><br><span class="dynamic-text">${appData.settings.asstPrincipalName || ''}</span><br><span class="dynamic-text">${lastDayOfMonth.toLocaleDateString('tr-TR')}</span><br>ƒ∞mza</div>
            ${explanationHTML}
            <div class="legend-section">${legendHTML}</div>
        </div>`;
        
        return `<div class="sheet-content">${mainTitle}${headerTable}<div class="print-main-table-wrapper">${mainTable}</div>${printFooter}</div>`;
    }

    function generateMonthlyGuidanceForm(company, month, year) {
        function calculateVisitDates(year, month, dayOfWeek) { 
            const visitDates = getVisitDatesForMonth(year, month, dayOfWeek);
            if(visitDates.length === 0) return 'Bu ayda belirtilen g√ºn yok.';
            return visitDates.map(date => `${date.toLocaleDateString('tr-TR')} - ${date.toLocaleDateString('tr-TR', { weekday: 'long' })}`).join('<br>');
        }
        function getFormQuestionsHTML() { const questions = [ { s: 'A', q: '1. Usta √∂ƒüretici/eƒüitici personelin yƒ±llƒ±k eƒüitim planƒ± var mƒ±? Uyguluyor mu? √ñƒürencilere s√ºrekli aynƒ± i≈ülem mi, rotasyona g√∂re mi eƒüitim yaptƒ±rƒ±lƒ±yor?', a: 'Var, uyguluyor, rotasyona g√∂re eƒüitim' }, { s: 'A', q: '2. √ñƒürencilerin g√ºnl√ºk √ßalƒ±≈ümalarƒ± yƒ±llƒ±k eƒüitim planƒ±na uygun olarak pl√¢nlanmƒ±≈ü mƒ±?', a: 'Evet' }, { s: 'A', q: '3. √ñƒürenci devam durumu g√ºnl√ºk olarak takip ediliyor mu?', a: 'Evet' }, { s: 'A', q: '4. Meslek eƒüitimi √ßalƒ±≈ümalarƒ± puanla deƒüerlendiriliyor mu?', a: 'Evet' }, { s: 'A', q: '5. Yapƒ±lan i≈ülerle ilgili olarak her √∂ƒürenciye i≈ü dosyasƒ± tutturuluyor mu?', a: 'Evet' }, { s: 'A', q: '6. √ñƒürencilere 3308 sayƒ±lƒ± Kanunun 25 inci maddesine g√∂re aylƒ±k √ºcret √∂deniyor mu?', a: 'Evet' }, { s: 'A', q: '7. Meslek eƒüitimi, √ßalƒ±≈üma saatlerinde yapƒ±lƒ±yor mu?', a: 'Evet' }, { s: 'A', q: '8. ƒ∞≈ü g√ºvenliƒüi konusunda √∂ƒürencilere yeterli bilgi veriliyor ve gerekli tedbirler alƒ±nƒ±yor mu?', a: 'Evet' }, { s: 'A', q: '9. √ñƒürenciler disiplin, kƒ±lƒ±k-kƒ±yafet ve i≈ületmenin kurallarƒ±na uyuyor mu?', a: 'Evet' }, { s: 'A', q: '10. √ñƒürencilerin telafi eƒüitimine alƒ±nmasƒ± gerekiyor mu? Gerekiyorsa hangi konularda telafi eƒüitimi uygulanmalƒ±?', a: 'Hayƒ±r' }, { s: 'B', q: '1. ƒ∞≈ületmenin meslek eƒüitimi ile g√∂revli personelinin usta √∂ƒüreticilik belgesi var mƒ±?', a: 'Evet' }, { s: 'B', q: '2. Eƒüitici personelin sorumlu olduƒüu √∂ƒürenci grubu sayƒ±sƒ± Mesleki ve Teknik Eƒüitim Y√∂netmeliƒüinin 192 nci maddesine uygun mu?', a: 'Evet' }, { s: 'B', q: '3. Meslek eƒüitimi konusunda koordinat√∂r tarafƒ±ndan eƒüitici personele yapƒ±lan rehberlik ve konusu.', a: 'Geli≈üim tablolarƒ±nƒ±n kontrol edilmesi, √∂ƒürencilere ve eƒüiticilere g√ºvenli i≈ü ortamƒ±nƒ±n geli≈ütirilmesi.', tall: true }, { s: 'B', q: '4. Eƒüitici personelin geli≈ütirme ve uyum kursuna ihtiyacƒ± var mƒ±?', a: 'Hayƒ±r' }, { s: 'C', q: '1. ƒ∞≈ületmelerde meslek eƒüitimi, yƒ±llƒ±k √ßalƒ±≈üma takvimine uygun olarak s√ºrd√ºr√ºl√ºyor mu?', a: 'Evet' }, { s: 'C', q: '2. ƒ∞≈ületmede meslek eƒüitiminin mevzuata g√∂re s√ºrd√ºr√ºlmesi ile ilgili gerekli tedbirler alƒ±nƒ±yor mu? (Mesleki ve Teknik Eƒüitim Y√∂netmeliƒüi madde 196.)', a: 'Evet' }, { s: 'C', q: '4. √ñƒürenciler i√ßin geli≈üim tablosu uygulanƒ±yor mu?', a: 'Evet' }, { s: 'C', q: '5. ƒ∞≈ületme yetkililerinin meslek eƒüitiminin uygulanƒ±≈üƒ± ve √∂ƒüretim programlarƒ± konusundaki g√∂r√º≈ü ve √∂nerileri', a: '', tall: true }, { s: 'D', q: 'A√ßƒ±klanmasƒ± gereken diƒüer hususlar:', a: '', tall: true }, ]; let currentSection = ''; const rows = questions.map(item => { let sectionHeader = ''; if (item.s !== currentSection) { currentSection = item.s; const sectionNames = {A: 'A. Mesleki ve Teknik Eƒüitim Y√∂netmeliƒüi ile ilgili konular:', B: 'B. Eƒüitici Personelle ilgili konular:', C: 'C. ƒ∞≈ületme ile ilgili konular', D: 'D. A√ßƒ±klanmasƒ± gereken diƒüer hususlar:'}; sectionHeader = `<tr style="background:#f0f0f0 !important;"><td colspan="2" style="border:1px solid #000; padding:1px; font-weight:bold; text-align:center; font-size:5.5pt;">${sectionNames[item.s]}</td></tr>`; } const tallClass = item.tall ? 'expandable-area' : ''; const answerCell = `<textarea class="editable-textarea ${tallClass}">${item.a}</textarea>`; return `${sectionHeader}<tr><td style="border:1px solid #000; padding:1px; font-size:6pt; font-weight:bold; line-height:1.1;">${item.q}</td><td style="border:1px solid #000; padding:1px; vertical-align:middle; font-size:5.5pt;">${answerCell}</td></tr>`; }).join(''); return `<table style="width:100%; border-collapse:collapse;"><thead><tr style="background:#f0f0f0 !important;"><th style="border:1px solid #000; padding:1px; width:60%; font-size:6pt;">Koordinat√∂r√ºn Rehberlik Ziyaret Konularƒ±</th><th style="border:1px solid #000; padding:1px; width:40%; font-size:6pt;">Deƒüerlendirme ve √ñneriler</th></tr></thead><tbody>${rows}</tbody></table>`;
        }
        const visitDatesText = calculateVisitDates(year, month, company.visitDay); 
        const uniqueStudentFields = [...new Set(company.students.map(s => s.field).filter(Boolean))].join(', ');
        return `<div style="text-align: center; font-weight: bold; font-size: 7.5pt; line-height:1.1;">ƒ∞≈ûLETMELERDE MESLEK Eƒûƒ∞Tƒ∞Mƒ∞ KOORDƒ∞NAT√ñRLERƒ∞Nƒ∞N ƒ∞≈ûLETMEYE YAPACAƒûI AYLIK REHBERLƒ∞K RAPOR FORMU</div><div style="text-align: center; font-weight: bold; font-size: 7.5pt; margin-top: 2px;">U≈ûAK MESLEKƒ∞ VE TEKNƒ∞K ANADOLU Lƒ∞SESƒ∞ M√úD√úRL√úƒû√ú'NE</div><div style="text-align: center; font-weight: bold; font-size: 7.5pt;">U≈ûAK</div><p style="font-size: 7pt; line-height: 1.1; margin: 2px 0; text-indent:10px;">Okul/Kurumumuz <b><i>${uniqueStudentFields || '................................'}</i></b> alan/dalƒ± √∂ƒürencilerinin meslek eƒüitimi g√∂rd√ºƒü√º i≈ületmede yapmƒ±≈ü olduƒüum bir aylƒ±k koordinat√∂rl√ºk g√∂revlerim sƒ±rasƒ±nda tespit ettiƒüim hususlar a≈üaƒüƒ±da belirtilmi≈ütir.<br>Bilgilerinizi ve gereƒüini arz ederim.</p>
        <table style="width:100%; border-collapse:collapse; font-size:7pt; margin: 2px 0;"><tr><td style="border:1px solid #000; padding:1px; width:50%; vertical-align:top;"><b>ƒ∞≈ületmenin Adƒ± ve Adresi:</b><br><span class="dynamic-text">${company.name}, ${company.address}</span></td><td style="border:1px solid #000; padding:1px; width:50%; vertical-align:top;"><b>G√ñREV TARƒ∞HLERƒ∞:</b><br><span class="dynamic-text">${visitDatesText}</span></td></tr><tr><td style="border:1px solid #000; padding:1px; line-height:1.1;"><b>ƒ∞≈ületme Eƒüitim Yetkilisinin</b><br>Adƒ± Soyadƒ±: <span class="dynamic-text">${company.official}</span><br><br>ƒ∞mza:</td><td style="border:1px solid #000; padding:1px; line-height:1.1;"><b>Koordinat√∂r √ñƒüretmenin</b><br>Adƒ± Soyadƒ±: <span class="dynamic-text">${appData.settings.coordinatorName}</span><br><br>ƒ∞mza:</td></tr></table><div class="form-content-wrapper">${getFormQuestionsHTML()}</div><div style="text-align: center; margin-top: auto; font-size: 6pt; border-top: 1px solid #000; padding-top: 1px;"><strong>A√áIKLAMA:</strong> Bu form her i≈ületme i√ßin her ay ayrƒ± ayrƒ± doldurulacak, kurum idaresine verilecektir. FORM A</div>`;
    }
    
    // ESKƒ∞ generateDailyGuidanceForm FONKSƒ∞YONUNU Sƒ∞Lƒ∞P BUNU YAPI≈ûTIRIN ‚ñº
    function generateDailyGuidanceForm(business, visitDate) {
        if (!business || !visitDate) return `<div class="daily-guidance-form"></div>`;
        let activeStudents = [];
        if (business.students && business.students.length > 0) {
            for (const student of business.students) {
                const startDate = parseDateString(student.startDate);
                const endDate = student.endDate ? parseDateString(student.endDate) : null;
                if (startDate && startDate <= visitDate && (!endDate || endDate >= visitDate)) {
                    activeStudents.push(student);
                }
            }
        }
        const activeStudentCount = activeStudents.length;
        const uniqueStudentFields = [...new Set(activeStudents.map(s => s.field).filter(Boolean))].join(', ');

        return `<div class="daily-guidance-form">
            <h3>ƒ∞≈ûLETMELERDE MESLEK Eƒûƒ∞Tƒ∞Mƒ∞<br>G√úNLƒ∞K REHBERLƒ∞K G√ñREV FORMU</h3>
            <table class="main-table">
                <tbody>
                    <tr>
                        <td class="label-cell">ƒ∞≈ületmenin Adƒ±</td>
                        <td class="data-cell"><span class="dynamic-text">${business.name}</span></td>
                    </tr>
                    <tr>
                        <td class="label-cell">ƒ∞zlemede Sorumlu olduƒüu √ñƒürenci Sayƒ±sƒ±</td>
                        <td class="data-cell"><span class="dynamic-text">${activeStudentCount}</span></td>
                    </tr>
                    <tr>
                        <td class="label-cell">Meslek Alan/Dalƒ±</td>
                        <td class="data-cell"><span class="dynamic-text">${uniqueStudentFields}</span></td>
                    </tr>
                    <tr>
                        <td class="label-cell">G√∂rev Tarihi</td>
                        <td class="data-cell"><span class="dynamic-text">${visitDate.toLocaleDateString('tr-TR')}</span></td>
                    </tr>
                    <tr>
                        <td colspan="2" class="section-cell">
                            <p>1- ƒ∞≈ületmede √∂ƒürenim g√∂ren √∂ƒürencilerin eƒüitimini olumsuz y√∂nde etkileyen hususlar. (varsa yazƒ±nƒ±z.)</p>
                            <textarea class="editable-textarea"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" class="section-cell">
                            <p>2- Belirlenen aksaklƒ±klarla ilgili yapƒ±lan rehberlik ve alƒ±nan √∂nlemler:</p>
                            <textarea class="editable-textarea"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" class="section-cell">
                            <p>3- Aylƒ±k Rehberlik formunda belirtilmesinde yarar g√∂r√ºlen hususlar:</p>
                            <textarea class="editable-textarea"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" class="signature-cell">
                            <div class="footer">
                                <div><span class="dynamic-text">${business.official}</span><br>ƒ∞≈ületme Eƒüitim Yetkilisi<br><br>ƒ∞mza</div>
                                <div><span class="dynamic-text">${appData.settings.coordinatorName}</span><br>Koor. √ñƒüretmen<br><br>ƒ∞mza</div>
                                <div><span class="dynamic-text">${appData.settings.asstPrincipalName}</span><br>Koor. Md. Yrd.<br><br>ƒ∞mza</div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" class="notes-cell">
                            <div class="notes">
                                A√ßƒ±klamalar: Bu form koordinat√∂r √∂ƒüretmen tarafƒ±ndan her g√∂rev i√ßin g√∂rev haftasƒ± ba≈üƒ±nda koordinat√∂r Md. Yrd.'ndan alƒ±nƒ±r. G√∂rev sonrasƒ±nda okula geldiƒüi g√ºn i√ßinde imzalarƒ± tamamlanmƒ±≈ü olarak Koordinat√∂r Md. Yrd.'na teslim edilir.<br>
                                <b>Not: Haftalƒ±k devamsƒ±zlƒ±klarƒ± 3 nolu alanda belirtiniz. (No, isim, tarih)</b>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>`;
    }

   function generateTerminationForm(e) {
        e.preventDefault();
        const studentId = dom.terminationForm.querySelector('#terminationStudentId').value; 
        const businessId = dom.terminationForm.querySelector('#terminationBusinessId').value; 
        const terminationDate = dom.terminationForm.querySelector('#terminationDate').value; 
        const terminationReason = dom.terminationForm.querySelector('#terminationReason').value;
        const business = appData.businesses.find(b => b.id === businessId); 
        const student = business.students.find(s => s.id === studentId);
        
        student.endDate = terminationDate;  // Bu lazƒ±m - fesih tarihi i√ßin
        
        // √ñƒürenciyi tamamen sil
        business.students = business.students.filter(s => s.id !== studentId);
        saveData(); 
        renderAll(); 
        closeModal('terminationModal');
        
        const formattedStartDate = student.startDate ? parseDateString(student.startDate).toLocaleDateString('tr-TR') : '';
        const formattedTerminationDate = parseDateString(terminationDate).toLocaleDateString('tr-TR');
        
        const formHTML = `
        <div class="print-page-container print-page-termination">
            <div class="termination-container" style="padding-bottom: 25px;">
                <h1 style="font-size: 14pt;">${appData.settings.schoolName}</h1>
                <h2 style="font-size: 14pt; margin: 15px 0;">
                    ƒ∞≈ûLETMELERDE BECERƒ∞ Eƒûƒ∞Tƒ∞Mƒ∞ G√ñREN √ñƒûRENCƒ∞LERE Aƒ∞T<br>S√ñZLE≈ûME FESƒ∞H TUTANAƒûI
                </h2>
                <table>
                    <tr><td class="label-col">ƒ∞≈ûLETMENƒ∞N ADI</td><td class="separator-col">:</td><td class="value-col"><strong><em>${business.name}</em></strong></td></tr>
                    <tr><td class="label-col">√ñƒûRENCƒ∞Nƒ∞N ADI SOYADI</td><td class="separator-col">:</td><td class="value-col"><strong><em>${student.name}</em></strong></td></tr>
                    <tr><td class="label-col">ALANI</td><td class="separator-col">:</td><td class="value-col"><strong><em>${student.field}</em></strong></td></tr>
                    <tr><td class="label-col">SINIFI / NUMARASI</td><td class="separator-col">:</td><td class="value-col"><strong><em>${student.class ? student.class + '. Sƒ±nƒ±f' : ''} / ${student.no || ''}</em></strong></td></tr>
                    <tr><td class="label-col">S√ñZLE≈ûMELƒ∞ TARƒ∞Hƒ∞</td><td class="separator-col">:</td><td class="value-col"><strong><em>${formattedStartDate}</em></strong></td></tr>
                    <tr><td class="label-col">S√ñZLE≈ûMENƒ∞N FESƒ∞H TARƒ∞Hƒ∞</td><td class="separator-col">:</td><td class="value-col"><strong><em>${formattedTerminationDate}</em></strong></td></tr>
                </table>
                <div class="reasons">
                    <div class="label-col" style="border-bottom: 1px solid black; padding-bottom: 2px; margin-bottom: 5px;">FESƒ∞H NEDENLERƒ∞:</div>
                    <div class="value-box" style="border: 1px solid transparent; padding: 5px;">
                        <strong><em>${terminationReason.replace(/\n/g, '<br>')}</em></strong>
                    </div>
                </div>
                <div class="signatures" style="display: flex; flex-wrap: wrap; justify-content: space-between; text-align: center; width: 100%; margin-top: auto; padding-top: 40px;">
                    <div style="width: 32%; height: 1px;"></div>
                    <div style="width: 32%; height: 1px;"></div>
                    <div style="width: 32%; margin-bottom: 20px;">..... / ..... / 2025</div>
                    <div style="width: 32%;"><strong><em>${business.official}</em></strong><br>ƒ∞≈ületme Yetkilisi</div>
                    <div style="width: 32%;"><strong><em>${appData.settings.coordinatorName}</em></strong><br>Koordinat√∂r √ñƒüretmen</div>
                    <div style="width: 32%;"><strong><em>${appData.settings.principalName}</em></strong><br>Okul M√ºd√ºr√º</div>
                </div>
            </div>
        </div>`;
        dom.printContainer.innerHTML = formHTML; 
        window.print();
        showNotification('S√∂zle≈üme feshi ger√ßekle≈ütirildi.', 'success');
    }

    dom.generateSheetBtn.addEventListener('click', () => {
        const formType = dom.formTypeSelect.value;
        let allFormsHTML = '';
        if (formType === 'attendance' || formType === 'monthly_guidance') {
            const selectedBusinessIds = Array.from(document.querySelectorAll('.business-checkbox:checked')).map(cb => cb.value);
            if (selectedBusinessIds.length === 0) { showNotification('L√ºtfen en az bir i≈ületme se√ßin.', 'error'); return; }
            const month = parseInt(dom.genMonthSelect.value);
            const year = parseInt(dom.genYearSelect.value);
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth(); // JavaScript'te aylar 0'dan ba≈ülar (Ocak=0)

            if (year > currentYear || (year === currentYear && month > currentMonth)) {
                showNotification('Hen√ºz gelmemi≈ü bir tarih i√ßin form olu≈üturulamaz.', 'error');
                return; // ƒ∞≈ülemi burada durdurur ama ay ve yƒ±l deƒüerleri korunur
            }
            
            if(formType === 'attendance'){
                let businessChunks = [];
                for (let i = 0; i < selectedBusinessIds.length; ) {
                    const business = appData.businesses.find(b => b.id === selectedBusinessIds[i]); 
                    const studentCount = business.students.filter(s => !s.endDate || parseDateString(s.endDate) > new Date(year, month, 1)).length;
                    if (studentCount <= 8) {
                        const nextBusiness = i + 1 < selectedBusinessIds.length ? appData.businesses.find(b => b.id === selectedBusinessIds[i + 1]) : null;
                        const hasNextSmallBusiness = nextBusiness && nextBusiness.students.filter(s => !s.endDate || parseDateString(s.endDate) > new Date(year, month, 1)).length <= 8;
                        if(hasNextSmallBusiness) { businessChunks.push([selectedBusinessIds[i], selectedBusinessIds[i+1]]); i += 2; }
                        else { businessChunks.push([selectedBusinessIds[i]]); i++; }
                    } else { businessChunks.push([selectedBusinessIds[i]]); i++; }
                }
                businessChunks.forEach(chunk => {
                    if(chunk.length === 2) {
                        const formHTML1 = generateAttendanceSheet(chunk[0], month, year); 
                        const formHTML2 = generateAttendanceSheet(chunk[1], month, year);
                        allFormsHTML += `<div class="print-page-container print-page-attendance"><div class="print-sheet-wrapper"><div class="print-sheet first-half">${formHTML1}</div><div class="print-sheet second-half">${formHTML2}</div></div></div>`;
                    } else {
                        const formHTML = generateAttendanceSheet(chunk[0], month, year);
                        // Tek i≈ületme de yarƒ±m sayfa kullansƒ±n, diƒüer yarƒ±sƒ± bo≈ü kalsƒ±n
                        allFormsHTML += `<div class="print-page-container print-page-attendance"><div class="print-sheet-wrapper"><div class="print-sheet first-half">${formHTML}</div><div class="print-sheet second-half"></div></div></div>`;
                    }
                });
            } else {
                for (let i = 0; i < selectedBusinessIds.length; i += 2) {
                    const company1 = appData.businesses.find(c => c.id === selectedBusinessIds[i]);
                    const company2 = (i + 1 < selectedBusinessIds.length) ? appData.businesses.find(c => c.id === selectedBusinessIds[i + 1]) : null;
                    allFormsHTML += `<div class="print-page-container print-page-monthly-guidance"><div class="print-page"><div class="print-form-half">${generateMonthlyGuidanceForm(company1, month, year)}</div><div class="print-form-half">${company2 ? generateMonthlyGuidanceForm(company2, month, year) : ''}</div></div></div>`;
                }
            }
        } else if (formType === 'daily_guidance') {
            const selectedBusinessIds = Array.from(document.querySelectorAll('.daily-business-checkbox:checked')).map(cb => cb.value);
            const selectedWeek = parseInt(dom.genWeekSelect1.value);
            
            if (selectedBusinessIds.length === 0) { 
                showNotification('L√ºtfen en az bir i≈ületme se√ßin.', 'error'); 
                return; 
            }
            
            const month = parseInt(dom.dailyMonthSelect.value);
            const year = parseInt(dom.dailyYearSelect.value);
            
            // Se√ßilen hafta bilgisini almak i√ßin
            const selectedWeekOption = dom.genWeekSelect1.querySelector(`option[value="${selectedWeek}"]`);
            let weekStartDate = null, weekEndDate = null;
            
            if (selectedWeekOption) {
                // Hafta se√ßeneklerini yeniden hesapla ve tarihleri al
                const weeks = [];
                const firstDayOfMonth = new Date(year, month, 1);
                const lastDayOfMonth = new Date(year, month + 1, 0);
                
                let firstMonday = new Date(firstDayOfMonth);
                const firstDayWeekday = firstDayOfMonth.getDay();
                const daysToSubtract = firstDayWeekday === 0 ? 6 : firstDayWeekday - 1;
                firstMonday.setDate(firstDayOfMonth.getDate() - daysToSubtract);
                
                let weekNumber = 1;
                let currentMonday = new Date(firstMonday);
                
                while (currentMonday <= lastDayOfMonth) {
                    const weekStart = new Date(currentMonday);
                    const weekEnd = new Date(currentMonday);
                    weekEnd.setDate(weekEnd.getDate() + 6);
                    
                    if (weekEnd >= firstDayOfMonth && weekStart <= lastDayOfMonth) {
                        if (weekNumber === selectedWeek) {
                            weekStartDate = weekStart;
                            weekEndDate = weekEnd;
                            break;
                        }
                        weekNumber++;
                    }
                    currentMonday.setDate(currentMonday.getDate() + 7);
                }
            }
            
            const businessForms = selectedBusinessIds.map(businessId => {
                const business = appData.businesses.find(b => b.id === businessId);
                if (!business || !business.visitDay) return null;
                
                // Se√ßilen hafta i√ßindeki ziyaret g√ºn√ºn√º bul
                if (!weekStartDate || !weekEndDate) return null;
                
                let visitDate = null;
                for (let d = new Date(weekStartDate); d <= weekEndDate; d.setDate(d.getDate() + 1)) {
                    if (d.getDay() === parseInt(business.visitDay)) {
                        visitDate = new Date(d);
                        break;
                    }
                }
                
                if (!visitDate) return null;
                
                return generateDailyGuidanceForm(business, visitDate);
            }).filter(form => form !== null);
            
            if (businessForms.length === 0) {
                showNotification('Se√ßilen hafta i√ßin uygun ziyaret g√ºn√º bulunamadƒ±.', 'error');
                return;
            }
            
            for (let i = 0; i < businessForms.length; i += 2) {
                const form1HTML = businessForms[i];
                const form2HTML = businessForms[i + 1] || null;

                // Sol s√ºtunu olu≈ütur (k√∂≈üe yazƒ±larƒ± + √ßer√ßeveli form)
                let column1 = `<div class="daily-guidance-column">
                                 <div class="top-right-text">ƒ∞ME-G√ñREV REHBERLƒ∞K</div>
                                 ${form1HTML}
                                 <div class="bottom-left-text">FORM 4A</div>
                               </div>`;
                
                // Saƒü s√ºtunu olu≈ütur (eƒüer ikinci form varsa)
                let column2 = `<div class="daily-guidance-column">`;
                if (form2HTML) {
                    column2 += `<div class="top-right-text">ƒ∞ME-G√ñREV REHBERLƒ∞K</div>
                                ${form2HTML}
                                <div class="bottom-left-text">FORM 4A</div>`;
                }
                column2 += `</div>`;

                allFormsHTML += `<div class="print-page-container print-page-daily-guidance"><div class="daily-guidance-container">${column1}${column2}</div></div>`;
            }
        }
        
        if (allFormsHTML) { 
            dom.printContainer.innerHTML = allFormsHTML; 
            window.print(); 
        }
    });


    dom.formTypeSelect.addEventListener('change', (e) => {
        if (e.target.value === 'daily_guidance') { dom.controlsMonthly.classList.remove('active'); dom.controlsDaily.classList.add('active'); }
        else { dom.controlsDaily.classList.remove('active'); dom.controlsMonthly.classList.add('active'); }
    });

    // Dropdown event listeners
    dom.businessDropdownHeader.addEventListener('click', () => {
        dom.businessDropdownHeader.classList.toggle('open');
        dom.businessDropdownContent.classList.toggle('open');
    });
    
    dom.dailyBusinessDropdownHeader.addEventListener('click', () => {
        dom.dailyBusinessDropdownHeader.classList.toggle('open');
        dom.dailyBusinessDropdownContent.classList.toggle('open');
    });
    
    // Dƒ±≈üarƒ± tƒ±klamada dropdown'larƒ± kapat
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.dropdown-container')) {
            document.querySelectorAll('.dropdown-header').forEach(header => header.classList.remove('open'));
            document.querySelectorAll('.dropdown-content').forEach(content => content.classList.remove('open'));
        }
    });

    // T√ºm√ºn√º se√ß/temizle butonlarƒ±
    dom.selectAllBusinesses.addEventListener('click', (e) => {
        e.stopPropagation();
        document.querySelectorAll('.business-checkbox').forEach(cb => cb.checked = true);
        updateDropdownText();
    });
    
    dom.deselectAllBusinesses.addEventListener('click', (e) => {
        e.stopPropagation();
        document.querySelectorAll('.business-checkbox').forEach(cb => cb.checked = false);
        updateDropdownText();
    });
    
    dom.selectAllDailyBusinesses.addEventListener('click', (e) => {
        e.stopPropagation();
        document.querySelectorAll('.daily-business-checkbox').forEach(cb => cb.checked = true);
        updateDropdownText();
    });
    
    dom.deselectAllDailyBusinesses.addEventListener('click', (e) => {
        e.stopPropagation();
        document.querySelectorAll('.daily-business-checkbox').forEach(cb => cb.checked = false);
        updateDropdownText();
    });

    // Checkbox deƒüi≈üikliklerini dinle
    document.addEventListener('change', (e) => {
        if (e.target.matches('.business-checkbox, .daily-business-checkbox')) {
            updateDropdownText();
        }
    });

    [dom.dailyMonthSelect, dom.dailyYearSelect].forEach(el => el.addEventListener('change', populateWeeksForDailyForm));
    
    dom.tabs.addEventListener('click', e => { if(e.target.matches('.tab')) { const tabId=e.target.dataset.tab; document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); document.getElementById(tabId).classList.add('active'); e.target.classList.add('active'); }});
    document.addEventListener('click', e => { if (e.target.matches('[data-action="cancel-modal"]')) { e.target.closest('.modal').style.display = 'none'; return; } const accordionHeader = e.target.closest('.accordion-header'); if (accordionHeader) { accordionHeader.nextElementSibling.classList.toggle('open'); return; } const action = e.target.dataset.action; if(!action) return; const id = e.target.dataset.id; const businessId = e.target.dataset.businessId; switch(action) { case 'add-student': openModal('studentModal', {businessId: id}); break; case 'edit-business': openModal('businessModal', {id: id}); break; case 'delete-business': deleteBusiness(id); break; case 'edit-student': openModal('studentModal', {id: id, businessId: businessId}); break; case 'delete-student': deleteStudent(id, businessId); break; case 'open-termination-modal': openModal('terminationModal', {studentId: id, businessId: businessId}); break; 
    case 'cancel-termination': 
    const studentId = e.target.dataset.studentId || e.target.dataset.id;
    cancelTermination(studentId, businessId); 
    break;case 'open-absence-modal': openModal('absenceModal', {studentId: id, businessId: businessId}); break; } });
    dom.absenceModal.addEventListener('click', e => {
        const dayEl = e.target.closest('.calendar-day.workday'); if (!dayEl) return;
        const statusEl = dayEl.querySelector('.calendar-day-status');
        let currentStatus = statusEl.textContent.replace(/\s/g, ''); let newStatus = '';
        if (currentStatus === '') newStatus = 'S'; else if (currentStatus === 'S') newStatus = '√ñ'; else if (currentStatus === '√ñ') newStatus = 'S√ñ'; else newStatus = '';
        statusEl.innerHTML = newStatus.replace('S√ñ', 'S<br>√ñ');
        statusEl.classList.toggle('f-gold', newStatus !== '');
    });
    dom.absenceModal.querySelector('#saveAbsenceBtn').addEventListener('click', saveAbsences);
    dom.absenceModal.querySelector('#absenceMonthSelect').addEventListener('change', renderAbsenceCalendar);
    dom.absenceModal.querySelector('#absenceYearSelect').addEventListener('change', renderAbsenceCalendar);
    dom.addBusinessBtn.addEventListener('click', () => openModal('businessModal', null));
    dom.businessForm.addEventListener('submit', saveBusiness);
    dom.studentForm.addEventListener('submit', saveStudent);
    dom.terminationForm.addEventListener('submit', generateTerminationForm);
    dom.downloadBtn.addEventListener('click', () => { saveData(); const dataStr = JSON.stringify(appData, null, 2); const blob = new Blob([dataStr], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `mesem_verileri_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url); showNotification('Veriler ba≈üarƒ±yla indirildi.', 'success'); });
    dom.uploadBtn.addEventListener('click', () => dom.uploadInput.click());
    dom.uploadInput.addEventListener('change', (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const loadedData = JSON.parse(e.target.result); if (loadedData.settings && loadedData.businesses) { appData = loadedData; saveData(); loadData(); renderAll(); showNotification('Veriler ba≈üarƒ±yla geri y√ºklendi.', 'success'); } else { showNotification('Hatalƒ± dosya formatƒ±.', 'error'); } } catch (error) { showNotification('Dosya okunurken bir hata olu≈ütu: ' + error, 'error'); } }; reader.readAsText(file); event.target.value = ''; });
    dom.printListBtn.addEventListener('click', () => { const listHTML = generateListPrint(); dom.printContainer.innerHTML = listHTML; window.print(); });

    // Telefon numarasƒ± input'larƒ±na otomatik d√ºzenleme
    document.addEventListener('input', (e) => {
        if (e.target.hasAttribute('inputmode') && e.target.getAttribute('inputmode') === 'numeric') {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        }
    });
    
  
    renderAll();
    dom.settingsInputs.forEach(input => input.addEventListener('input', saveData));

    // Mobil klavye fix
    document.addEventListener('focusin', function(e) {
        if (e.target.matches('input, textarea, select')) {
            setTimeout(() => {
                e.target.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
            }, 300);
        }
    });

    // iOS Safari viewport fix
    function setVhProperty() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    setVhProperty();
    window.addEventListener('resize', setVhProperty);
    window.addEventListener('orientationchange', setVhProperty);
});

</script>
</body>
</html>
